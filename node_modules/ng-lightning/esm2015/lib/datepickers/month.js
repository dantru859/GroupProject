import { __decorate, __metadata } from "tslib";
import { Component, Input, Output, EventEmitter, ChangeDetectionStrategy, ViewChildren, QueryList, NgZone, OnChanges, SimpleChanges } from '@angular/core';
import { take } from 'rxjs/operators';
import { split, getToday, isEqualDate, numberOfDaysInMonth, isDisabled } from './util';
import { NglDay } from './day';
let NglDatepickerMonth = class NglDatepickerMonth {
    constructor(ngZone) {
        this.ngZone = ngZone;
        this.dateDisabled = null;
        this.selectDate = new EventEmitter();
    }
    indexTrackBy(index) {
        return index;
    }
    dateTrackBy(index, { year, month, day }) {
        return `${day}-${month}-${year}`;
    }
    onSelect(date) {
        if (date.disabled)
            return;
        this.selectDate.emit(date);
    }
    ngOnChanges(changes) {
        if (changes.year || changes.month || changes.firstDayOfWeek) {
            this.renderView();
            return;
        }
        if (changes.day) {
            this.updateActive();
        }
        if (changes.selected) {
            this.updateSelected();
        }
        if (changes.minDate || changes.maxDate || changes.dateDisabled) {
            this.updateDisabled();
        }
    }
    focusActiveDay() {
        this.ngZone.runOutsideAngular(() => {
            this.ngZone.onStable.asObservable().pipe(take(1)).subscribe(() => {
                const active = this.days.find((d) => d.isActive);
                if (active) {
                    active.focus();
                }
            });
        });
    }
    renderView() {
        const days = this.daysInMonth(this.year, this.month);
        Array.prototype.unshift.apply(days, this.daysInPreviousMonth(this.year, this.month));
        const nextMonth = this.daysInNextMonth(this.year, this.month + 1, days.length);
        if (nextMonth) {
            Array.prototype.push.apply(days, nextMonth);
        }
        this.weeks = split(days);
    }
    daysInMonth(year, month) {
        const last = numberOfDaysInMonth(year, month);
        return this.getDayObjects(year, month, 1, last);
    }
    daysInPreviousMonth(year, month) {
        const firstIndex = (new Date(year, month, 1)).getDay();
        const last = new Date(year, month, 0).getDate();
        const numDays = (7 + firstIndex - this.firstDayOfWeek) % 7;
        return this.getDayObjects(year, month - 1, last - numDays + 1, last, false);
    }
    daysInNextMonth(year, month, numOfDays) {
        if (numOfDays % 7 === 0) {
            return;
        }
        return this.getDayObjects(year, month, 1, 7 - (numOfDays % 7), false);
    }
    getDayObjects(year, month, from, to, isCurrentMonth = true) {
        const today = getToday();
        const days = [];
        for (let day = from; day <= to; day++) {
            const d = {
                year,
                month,
                day,
                isCurrentMonth,
                today: isEqualDate(today, { year, month, day }),
            };
            d.active = this.isActive(d);
            d.selected = this.isSelected(d);
            d.disabled = this.isDisabled(d);
            days.push(d);
        }
        return days;
    }
    updateActive() {
        this.weeks.forEach((days) => {
            days.forEach(day => {
                day.active = this.isActive(day);
            });
        });
    }
    isActive(day) {
        return day.isCurrentMonth && day.day === this.day;
    }
    updateSelected() {
        this.weeks.forEach((days) => {
            days.forEach((day) => {
                day.selected = this.isSelected(day);
            });
        });
    }
    isSelected(day) {
        return isEqualDate(this.selected, day);
    }
    updateDisabled() {
        this.weeks.forEach((days) => {
            days.forEach(day => {
                day.disabled = this.isDisabled(day);
            });
        });
    }
    /** Date filter for the month */
    isDisabled(d) {
        return !d.isCurrentMonth || isDisabled(d, this.dateDisabled, this.minDate, this.maxDate);
    }
};
NglDatepickerMonth.ctorParameters = () => [
    { type: NgZone }
];
__decorate([
    Input(),
    __metadata("design:type", Object)
], NglDatepickerMonth.prototype, "selected", void 0);
__decorate([
    Input(),
    __metadata("design:type", Number)
], NglDatepickerMonth.prototype, "year", void 0);
__decorate([
    Input(),
    __metadata("design:type", Number)
], NglDatepickerMonth.prototype, "month", void 0);
__decorate([
    Input(),
    __metadata("design:type", Number)
], NglDatepickerMonth.prototype, "day", void 0);
__decorate([
    Input(),
    __metadata("design:type", Number)
], NglDatepickerMonth.prototype, "firstDayOfWeek", void 0);
__decorate([
    Input(),
    __metadata("design:type", Object)
], NglDatepickerMonth.prototype, "minDate", void 0);
__decorate([
    Input(),
    __metadata("design:type", Object)
], NglDatepickerMonth.prototype, "maxDate", void 0);
__decorate([
    Input(),
    __metadata("design:type", Function)
], NglDatepickerMonth.prototype, "dateDisabled", void 0);
__decorate([
    Output(),
    __metadata("design:type", Object)
], NglDatepickerMonth.prototype, "selectDate", void 0);
__decorate([
    ViewChildren(NglDay),
    __metadata("design:type", QueryList)
], NglDatepickerMonth.prototype, "days", void 0);
NglDatepickerMonth = __decorate([
    Component({
        // tslint:disable-next-line:component-selector
        selector: '[nglDatepickerMonth]',
        template: "\n<tr *ngFor=\"let week of weeks; trackBy:indexTrackBy\">\n  <td *ngFor=\"let date of week; trackBy:dateTrackBy\" [class.slds-is-today]=\"date.today\" [isActive]=\"date.active\" [nglDay]=\"date\" [nglDaySelected]=\"date.selected\" [nglDayDisabled]=\"date.disabled\" (click)=\"onSelect(date)\" role=\"gridcell\"><span class=\"slds-day\">{{ date.day }}</span></td>\n</tr>",
        changeDetection: ChangeDetectionStrategy.OnPush
    }),
    __metadata("design:paramtypes", [NgZone])
], NglDatepickerMonth);
export { NglDatepickerMonth };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9udGguanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZy1saWdodG5pbmcvIiwic291cmNlcyI6WyJsaWIvZGF0ZXBpY2tlcnMvbW9udGgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsdUJBQXVCLEVBQUUsWUFBWSxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLGFBQWEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzSixPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdEMsT0FBTyxFQUFtQixLQUFLLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxtQkFBbUIsRUFBRSxVQUFVLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDeEcsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLE9BQU8sQ0FBQztBQWUvQixJQUFhLGtCQUFrQixHQUEvQixNQUFhLGtCQUFrQjtJQXdCN0IsWUFBb0IsTUFBYztRQUFkLFdBQU0sR0FBTixNQUFNLENBQVE7UUFSaEIsaUJBQVksR0FBbUMsSUFBSSxDQUFDO1FBRTVELGVBQVUsR0FBRyxJQUFJLFlBQVksRUFBbUIsQ0FBQztJQU10QixDQUFDO0lBRXRDLFlBQVksQ0FBQyxLQUFhO1FBQ3hCLE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUVELFdBQVcsQ0FBQyxLQUFhLEVBQUUsRUFBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBa0I7UUFDNUQsT0FBTyxHQUFHLEdBQUcsSUFBSSxLQUFLLElBQUksSUFBSSxFQUFFLENBQUM7SUFDbkMsQ0FBQztJQUVELFFBQVEsQ0FBQyxJQUFxQjtRQUM1QixJQUFJLElBQUksQ0FBQyxRQUFRO1lBQUUsT0FBTztRQUUxQixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM3QixDQUFDO0lBRUQsV0FBVyxDQUFDLE9BQXNCO1FB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QUFDLGNBQWMsSUFBSSxVQUFVLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDM0YsQ0FBQztDQUNGLENBQUE7O1lBcEk2QixNQUFNOztBQXRCekI7SUFBUixLQUFLLEVBQUU7O29EQUFvQztBQUVuQztJQUFSLEtBQUssRUFBRTs7Z0RBQXVCO0FBRXRCO0lBQVIsS0FBSyxFQUFFOztpREFBd0I7QUFFdkI7SUFBUixLQUFLLEVBQUU7OytDQUFzQjtBQUVyQjtJQUFSLEtBQUssRUFBRTs7MERBQWlDO0FBRWhDO0lBQVIsS0FBSyxFQUFFOzttREFBbUM7QUFFbEM7SUFBUixLQUFLLEVBQUU7O21EQUFtQztBQUVsQztJQUFSLEtBQUssRUFBRTs7d0RBQThEO0FBRTVEO0lBQVQsTUFBTSxFQUFFOztzREFBa0Q7QUFFckM7SUFBckIsWUFBWSxDQUFDLE1BQU0sQ0FBQzs4QkFBTyxTQUFTO2dEQUFTO0FBcEJuQyxrQkFBa0I7SUFOOUIsU0FBUyxDQUFDO1FBQ1QsOENBQThDO1FBQzlDLFFBQVEsRUFBRSxzQkFBc0I7UUFDaEMsNlhBQTJCO1FBQzNCLGVBQWUsRUFBRSx1QkFBdUIsQ0FBQyxNQUFNO0tBQ2hELENBQUM7cUNBeUI0QixNQUFNO0dBeEJ2QixrQkFBa0IsQ0E0SjlCO1NBNUpZLGtCQUFrQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgSW5wdXQsIE91dHB1dCwgRXZlbnRFbWl0dGVyLCBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSwgVmlld0NoaWxkcmVuLCBRdWVyeUxpc3QsIE5nWm9uZSwgT25DaGFuZ2VzLCBTaW1wbGVDaGFuZ2VzIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyB0YWtlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgTmdsSW50ZXJuYWxEYXRlLCBzcGxpdCwgZ2V0VG9kYXksIGlzRXF1YWxEYXRlLCBudW1iZXJPZkRheXNJbk1vbnRoLCBpc0Rpc2FibGVkIH0gZnJvbSAnLi91dGlsJztcbmltcG9ydCB7IE5nbERheSB9IGZyb20gJy4vZGF5JztcblxuaW50ZXJmYWNlIElOZ2xEYXlDZWxsIGV4dGVuZHMgTmdsSW50ZXJuYWxEYXRlIHtcbiAgdG9kYXk6IGJvb2xlYW47XG4gIGlzQ3VycmVudE1vbnRoOiBib29sZWFuO1xuICBzZWxlY3RlZD86IGJvb2xlYW47XG4gIGFjdGl2ZT86IGJvb2xlYW47XG59XG5cbkBDb21wb25lbnQoe1xuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6Y29tcG9uZW50LXNlbGVjdG9yXG4gIHNlbGVjdG9yOiAnW25nbERhdGVwaWNrZXJNb250aF0nLFxuICB0ZW1wbGF0ZVVybDogJy4vbW9udGguaHRtbCcsXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxufSlcbmV4cG9ydCBjbGFzcyBOZ2xEYXRlcGlja2VyTW9udGggaW1wbGVtZW50cyBPbkNoYW5nZXMge1xuXG4gIEBJbnB1dCgpIHJlYWRvbmx5IHNlbGVjdGVkOiBOZ2xJbnRlcm5hbERhdGU7XG5cbiAgQElucHV0KCkgcmVhZG9ubHkgeWVhcjogbnVtYmVyO1xuXG4gIEBJbnB1dCgpIHJlYWRvbmx5IG1vbnRoOiBudW1iZXI7XG5cbiAgQElucHV0KCkgcmVhZG9ubHkgZGF5OiBudW1iZXI7XG5cbiAgQElucHV0KCkgcmVhZG9ubHkgZmlyc3REYXlPZldlZWs6IG51bWJlcjtcblxuICBASW5wdXQoKSByZWFkb25seSBtaW5EYXRlOiBOZ2xJbnRlcm5hbERhdGU7XG5cbiAgQElucHV0KCkgcmVhZG9ubHkgbWF4RGF0ZTogTmdsSW50ZXJuYWxEYXRlO1xuXG4gIEBJbnB1dCgpIHJlYWRvbmx5IGRhdGVEaXNhYmxlZDogKGRhdGU6IERhdGUpID0+IGJvb2xlYW4gfCBudWxsID0gbnVsbDtcblxuICBAT3V0cHV0KCkgc2VsZWN0RGF0ZSA9IG5ldyBFdmVudEVtaXR0ZXI8TmdsSW50ZXJuYWxEYXRlPigpO1xuXG4gIEBWaWV3Q2hpbGRyZW4oTmdsRGF5KSBkYXlzOiBRdWVyeUxpc3Q8TmdsRGF5PjtcblxuICB3ZWVrczogSU5nbERheUNlbGxbXVtdO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgbmdab25lOiBOZ1pvbmUpIHt9XG5cbiAgaW5kZXhUcmFja0J5KGluZGV4OiBudW1iZXIpIHtcbiAgICByZXR1cm4gaW5kZXg7XG4gIH1cblxuICBkYXRlVHJhY2tCeShpbmRleDogbnVtYmVyLCB7eWVhciwgbW9udGgsIGRheX06IE5nbEludGVybmFsRGF0ZSkge1xuICAgIHJldHVybiBgJHtkYXl9LSR7bW9udGh9LSR7eWVhcn1gO1xuICB9XG5cbiAgb25TZWxlY3QoZGF0ZTogTmdsSW50ZXJuYWxEYXRlKSB7XG4gICAgaWYgKGRhdGUuZGlzYWJsZWQpIHJldHVybjtcblxuICAgIHRoaXMuc2VsZWN0RGF0ZS5lbWl0KGRhdGUpO1xuICB9XG5cbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xuICAgIGlmIChjaGFuZ2VzLnllYXIgfHwgY2hhbmdlcy5tb250aCB8fCBjaGFuZ2VzLmZpcnN0RGF5T2ZXZWVrKSB7XG4gICAgICB0aGlzLnJlbmRlclZpZXcoKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoY2hhbmdlcy5kYXkpIHtcbiAgICAgIHRoaXMudXBkYXRlQWN0aXZlKCk7XG4gICAgfVxuXG4gICAgaWYgKGNoYW5nZXMuc2VsZWN0ZWQpIHtcbiAgICAgIHRoaXMudXBkYXRlU2VsZWN0ZWQoKTtcbiAgICB9XG5cbiAgICBpZiAoY2hhbmdlcy5taW5EYXRlIHx8IGNoYW5nZXMubWF4RGF0ZSB8fCBjaGFuZ2VzLmRhdGVEaXNhYmxlZCkge1xuICAgICAgdGhpcy51cGRhdGVEaXNhYmxlZCgpO1xuICAgIH1cbiAgfVxuXG4gIGZvY3VzQWN0aXZlRGF5KCkge1xuICAgIHRoaXMubmdab25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcbiAgICAgIHRoaXMubmdab25lLm9uU3RhYmxlLmFzT2JzZXJ2YWJsZSgpLnBpcGUodGFrZSgxKSkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgY29uc3QgYWN0aXZlID0gdGhpcy5kYXlzLmZpbmQoKGQpID0+IGQuaXNBY3RpdmUpO1xuICAgICAgICBpZiAoYWN0aXZlKSB7XG4gICAgICAgICAgYWN0aXZlLmZvY3VzKCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSByZW5kZXJWaWV3KCkge1xuICAgIGNvbnN0IGRheXMgPSB0aGlzLmRheXNJbk1vbnRoKHRoaXMueWVhciwgdGhpcy5tb250aCk7XG5cbiAgICBBcnJheS5wcm90b3R5cGUudW5zaGlmdC5hcHBseShkYXlzLCB0aGlzLmRheXNJblByZXZpb3VzTW9udGgodGhpcy55ZWFyLCB0aGlzLm1vbnRoKSk7XG4gICAgY29uc3QgbmV4dE1vbnRoID0gdGhpcy5kYXlzSW5OZXh0TW9udGgodGhpcy55ZWFyLCB0aGlzLm1vbnRoICsgMSwgZGF5cy5sZW5ndGgpO1xuICAgIGlmIChuZXh0TW9udGgpIHtcbiAgICAgIEFycmF5LnByb3RvdHlwZS5wdXNoLmFwcGx5KGRheXMsIG5leHRNb250aCk7XG4gICAgfVxuXG4gICAgdGhpcy53ZWVrcyA9IHNwbGl0KGRheXMpO1xuICB9XG5cbiAgcHJpdmF0ZSBkYXlzSW5Nb250aCh5ZWFyOiBudW1iZXIsIG1vbnRoOiBudW1iZXIpIHtcbiAgICBjb25zdCBsYXN0ID0gbnVtYmVyT2ZEYXlzSW5Nb250aCh5ZWFyLCBtb250aCk7XG4gICAgcmV0dXJuIHRoaXMuZ2V0RGF5T2JqZWN0cyh5ZWFyLCBtb250aCwgMSwgbGFzdCk7XG4gIH1cblxuICBwcml2YXRlIGRheXNJblByZXZpb3VzTW9udGgoeWVhcjogbnVtYmVyLCBtb250aDogbnVtYmVyKSB7XG4gICAgY29uc3QgZmlyc3RJbmRleCA9IChuZXcgRGF0ZSh5ZWFyLCBtb250aCwgMSkpLmdldERheSgpO1xuICAgIGNvbnN0IGxhc3QgPSBuZXcgRGF0ZSh5ZWFyLCBtb250aCwgMCkuZ2V0RGF0ZSgpO1xuICAgIGNvbnN0IG51bURheXMgPSAoNyArIGZpcnN0SW5kZXggLSB0aGlzLmZpcnN0RGF5T2ZXZWVrKSAlIDc7XG5cbiAgICByZXR1cm4gdGhpcy5nZXREYXlPYmplY3RzKHllYXIsIG1vbnRoIC0gMSwgbGFzdCAtIG51bURheXMgKyAxLCBsYXN0LCBmYWxzZSk7XG4gIH1cblxuICBwcml2YXRlIGRheXNJbk5leHRNb250aCh5ZWFyOiBudW1iZXIsIG1vbnRoOiBudW1iZXIsIG51bU9mRGF5czogbnVtYmVyKSB7XG4gICAgaWYgKG51bU9mRGF5cyAlIDcgPT09IDApIHsgcmV0dXJuOyB9XG4gICAgcmV0dXJuIHRoaXMuZ2V0RGF5T2JqZWN0cyh5ZWFyLCBtb250aCwgMSwgNyAtIChudW1PZkRheXMgJSA3KSwgZmFsc2UpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXREYXlPYmplY3RzKHllYXI6IG51bWJlciwgbW9udGg6IG51bWJlciwgZnJvbTogbnVtYmVyLCB0bzogbnVtYmVyLCBpc0N1cnJlbnRNb250aCA9IHRydWUpIHtcbiAgICBjb25zdCB0b2RheSA9IGdldFRvZGF5KCk7XG4gICAgY29uc3QgZGF5czogSU5nbERheUNlbGxbXSA9IFtdO1xuICAgIGZvciAobGV0IGRheSA9IGZyb207IGRheSA8PSB0bzsgZGF5KyspIHtcbiAgICAgIGNvbnN0IGQ6IElOZ2xEYXlDZWxsID0ge1xuICAgICAgICB5ZWFyLFxuICAgICAgICBtb250aCxcbiAgICAgICAgZGF5LFxuICAgICAgICBpc0N1cnJlbnRNb250aCxcbiAgICAgICAgdG9kYXk6IGlzRXF1YWxEYXRlKHRvZGF5LCB7IHllYXIsIG1vbnRoLCBkYXkgfSksXG4gICAgICB9O1xuXG4gICAgICBkLmFjdGl2ZSA9IHRoaXMuaXNBY3RpdmUoZCk7XG4gICAgICBkLnNlbGVjdGVkID0gdGhpcy5pc1NlbGVjdGVkKGQpO1xuICAgICAgZC5kaXNhYmxlZCA9IHRoaXMuaXNEaXNhYmxlZChkKTtcbiAgICAgIGRheXMucHVzaChkKTtcbiAgICB9XG4gICAgcmV0dXJuIGRheXM7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZUFjdGl2ZSgpIHtcbiAgICB0aGlzLndlZWtzLmZvckVhY2goKGRheXM6IElOZ2xEYXlDZWxsW10pID0+IHtcbiAgICAgIGRheXMuZm9yRWFjaChkYXkgPT4ge1xuICAgICAgICBkYXkuYWN0aXZlID0gdGhpcy5pc0FjdGl2ZShkYXkpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGlzQWN0aXZlKGRheTogSU5nbERheUNlbGwpIHtcbiAgICByZXR1cm4gZGF5LmlzQ3VycmVudE1vbnRoICYmIGRheS5kYXkgPT09IHRoaXMuZGF5O1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVTZWxlY3RlZCgpIHtcbiAgICB0aGlzLndlZWtzLmZvckVhY2goKGRheXM6IElOZ2xEYXlDZWxsW10pID0+IHtcbiAgICAgIGRheXMuZm9yRWFjaCgoZGF5KSA9PiB7XG4gICAgICAgIGRheS5zZWxlY3RlZCA9IHRoaXMuaXNTZWxlY3RlZChkYXkpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGlzU2VsZWN0ZWQoZGF5OiBJTmdsRGF5Q2VsbCkge1xuICAgIHJldHVybiBpc0VxdWFsRGF0ZSh0aGlzLnNlbGVjdGVkLCBkYXkpO1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVEaXNhYmxlZCgpIHtcbiAgICB0aGlzLndlZWtzLmZvckVhY2goKGRheXM6IElOZ2xEYXlDZWxsW10pID0+IHtcbiAgICAgIGRheXMuZm9yRWFjaChkYXkgPT4ge1xuICAgICAgICBkYXkuZGlzYWJsZWQgPSB0aGlzLmlzRGlzYWJsZWQoZGF5KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqIERhdGUgZmlsdGVyIGZvciB0aGUgbW9udGggKi9cbiAgcHJpdmF0ZSBpc0Rpc2FibGVkKGQ6IElOZ2xEYXlDZWxsKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuICFkLmlzQ3VycmVudE1vbnRoIHx8IGlzRGlzYWJsZWQoZCwgdGhpcy5kYXRlRGlzYWJsZWQsIHRoaXMubWluRGF0ZSwgdGhpcy5tYXhEYXRlKTtcbiAgfVxufVxuIl19