import { __decorate, __metadata, __param } from "tslib";
import { Component, Input, Output, EventEmitter, ChangeDetectionStrategy, ElementRef, OnInit, OnChanges, AfterViewInit, Optional, Inject, ViewChild, SimpleChanges, LOCALE_ID } from '@angular/core';
import { ENTER, UP_ARROW, LEFT_ARROW, DOWN_ARROW, RIGHT_ARROW, PAGE_UP, PAGE_DOWN, HOME, END } from '@angular/cdk/keycodes';
import { uniqueId, trapEvent } from '../util/util';
import { InputBoolean, InputNumber } from '../util/convert';
import { NglDatepickerInput } from './input/datepicker-input';
import { NGL_DATEPICKER_CONFIG, NglDatepickerConfig } from './config';
import { numberOfDaysInMonth, getToday, isDisabled, compareDate, isSameMonth, parseDate } from './util';
import { NglDatepickerMonth } from './month';
const KEYBOARD_MOVES = {
    [UP_ARROW]: ['Move', -7],
    [LEFT_ARROW]: ['Move', -1],
    [DOWN_ARROW]: ['Move', 7],
    [RIGHT_ARROW]: ['Move', 1],
    [PAGE_UP]: ['MoveMonth', -1],
    [PAGE_DOWN]: ['MoveMonth', 1],
    [HOME]: ['MoveTo', 1],
    [END]: ['MoveTo', 31],
};
let NglDatepicker = class NglDatepicker {
    constructor(dtInput, defaultConfig, locale, element) {
        this.dtInput = dtInput;
        this.element = element;
        this.dateDisabled = null;
        this.dateChange = new EventEmitter();
        this.uid = uniqueId('datepicker');
        const config = Object.assign(Object.assign({}, new NglDatepickerConfig(locale)), defaultConfig);
        this.monthNames = config.monthNames;
        this.dayNamesShort = config.dayNamesShort;
        this.dayNamesLong = config.dayNamesLong;
        this.firstDayOfWeek = config.firstDayOfWeek;
        this.showToday = config.showToday;
        this.relativeYearFrom = config.relativeYearFrom;
        this.relativeYearTo = config.relativeYearTo;
        this.todayLabel = config.todayLabel;
        this.previousMonthLabel = config.previousMonthLabel;
        this.nextMonthLabel = config.nextMonthLabel;
    }
    set date(date) {
        this._date = parseDate(date);
    }
    ngOnInit() {
        this.setMinMaxDates();
        this.setCurrent(this._date || getToday());
    }
    ngOnChanges(changes) {
        if ((changes.date && changes.date.isFirstChange()) ||
            changes.relativeYearFrom || changes.relativeYearTo ||
            changes.min || changes.max) {
            this.setMinMaxDates();
        }
        if (changes.date) {
            this.setCurrent(this._date);
        }
    }
    moveYear(year) {
        this.setCurrent({ year: +year });
    }
    moveMonth(diff) {
        this.moveCalendar('MoveMonth', diff);
    }
    keyboardHandler(evt) {
        const keyCode = evt.keyCode;
        if (keyCode === ENTER) {
            trapEvent(evt);
            if (!this.isDisabledDate(this.current)) {
                this.select(this.current);
            }
            return;
        }
        const move = KEYBOARD_MOVES[keyCode];
        if (!move) {
            return;
        }
        // Handle keyboard event inside datepicker
        trapEvent(evt);
        const [code, param] = move;
        this.moveCalendar(code, param);
        this.focusActiveDay();
    }
    select(date) {
        if (date.disabled) {
            return;
        }
        const { year, month, day } = date;
        this.dateChange.emit(new Date(year, month, day));
    }
    selectToday() {
        const today = getToday();
        if (this.isDisabledDate(today)) {
            this.setCurrent(today);
        }
        else {
            this.dateChange.emit(new Date());
        }
    }
    ngAfterViewInit() {
        if (this.dtInput) {
            const el = this.element.nativeElement;
            this.dtInput.updateDatepickerSize(el.offsetWidth, el.offsetHeight);
            this.focusActiveDay();
        }
    }
    /** Whether the previous period button is disabled. */
    previousDisabled() {
        return this.minDate && isSameMonth(this.current, this.minDate);
    }
    /** Whether the next period button is disabled. */
    nextDisabled() {
        return this.maxDate && isSameMonth(this.current, this.maxDate);
    }
    focusActiveDay() {
        this.monthView.focusActiveDay();
    }
    moveCalendar(code, param) {
        const { year, month, day } = this.current;
        const date = new Date(year, month, day, 12);
        if (code === 'Move') {
            date.setDate(day + (+param));
            this.setCurrent({ year: date.getFullYear(), month: date.getMonth(), day: date.getDate() });
        }
        else if (code === 'MoveMonth') {
            date.setMonth(month + (+param), 1);
            this.setCurrent({ year: date.getFullYear(), month: date.getMonth(), day });
        }
        else if (code === 'MoveTo') {
            this.setCurrent({ day: +param });
        }
    }
    setCurrent(d, doRender = true) {
        this.current = Object.assign(Object.assign({}, this.current), d);
        // Keep current inside minimum/maximum range
        if (compareDate(this.current, this.minDate) < 0) {
            this.current = this.minDate;
        }
        else if (compareDate(this.current, this.maxDate) > 0) {
            this.current = this.maxDate;
        }
        if (doRender) {
            this.render();
        }
    }
    render() {
        const { year, month, day } = this.current;
        this.monthLabel = this.monthNames[month];
        // Keep current day inside limits of this month
        this.setCurrent({ day: Math.min(day, numberOfDaysInMonth(year, month)) }, false);
    }
    /** Date filter for the month */
    isDisabledDate(date) {
        return isDisabled(date, this.dateDisabled, this.minDate, this.maxDate);
    }
    setMinMaxDates() {
        const { year } = getToday();
        this.minDate = this.min ? parseDate(this.min) : { year: year + this.relativeYearFrom, month: 0, day: 1 };
        this.maxDate = this.max ? parseDate(this.max) : { year: year + this.relativeYearTo, month: 11, day: 31 };
    }
};
NglDatepicker.ctorParameters = () => [
    { type: NglDatepickerInput, decorators: [{ type: Optional }, { type: Inject, args: [NglDatepickerInput,] }] },
    { type: NglDatepickerConfig, decorators: [{ type: Optional }, { type: Inject, args: [NGL_DATEPICKER_CONFIG,] }] },
    { type: String, decorators: [{ type: Inject, args: [LOCALE_ID,] }] },
    { type: ElementRef }
];
__decorate([
    Input(),
    __metadata("design:type", Array)
], NglDatepicker.prototype, "monthNames", void 0);
__decorate([
    Input(),
    __metadata("design:type", Array)
], NglDatepicker.prototype, "dayNamesShort", void 0);
__decorate([
    Input(),
    __metadata("design:type", Array)
], NglDatepicker.prototype, "dayNamesLong", void 0);
__decorate([
    Input(),
    __metadata("design:type", Function)
], NglDatepicker.prototype, "dateDisabled", void 0);
__decorate([
    Input(),
    __metadata("design:type", Date),
    __metadata("design:paramtypes", [Date])
], NglDatepicker.prototype, "date", null);
__decorate([
    Output(),
    __metadata("design:type", Object)
], NglDatepicker.prototype, "dateChange", void 0);
__decorate([
    Input(), InputBoolean(),
    __metadata("design:type", Boolean)
], NglDatepicker.prototype, "showToday", void 0);
__decorate([
    Input(), InputNumber(),
    __metadata("design:type", Number)
], NglDatepicker.prototype, "firstDayOfWeek", void 0);
__decorate([
    Input(),
    __metadata("design:type", Number)
], NglDatepicker.prototype, "relativeYearFrom", void 0);
__decorate([
    Input(),
    __metadata("design:type", Number)
], NglDatepicker.prototype, "relativeYearTo", void 0);
__decorate([
    Input(),
    __metadata("design:type", Date)
], NglDatepicker.prototype, "min", void 0);
__decorate([
    Input(),
    __metadata("design:type", Date)
], NglDatepicker.prototype, "max", void 0);
__decorate([
    Input(),
    __metadata("design:type", String)
], NglDatepicker.prototype, "todayLabel", void 0);
__decorate([
    Input(),
    __metadata("design:type", String)
], NglDatepicker.prototype, "previousMonthLabel", void 0);
__decorate([
    Input(),
    __metadata("design:type", String)
], NglDatepicker.prototype, "nextMonthLabel", void 0);
__decorate([
    ViewChild(NglDatepickerMonth),
    __metadata("design:type", NglDatepickerMonth)
], NglDatepicker.prototype, "monthView", void 0);
NglDatepicker = __decorate([
    Component({
        selector: 'ngl-datepicker',
        template: "\n<div class=\"slds-datepicker__filter slds-grid\">\n  <div class=\"slds-datepicker__filter_month slds-grid slds-grid_align-spread slds-grow\">\n    <div class=\"slds-align-middle\">\n      <button class=\"slds-button slds-button_icon-container\" type=\"button\" (click)=\"moveMonth(-1)\" [disabled]=\"previousDisabled()\" [title]=\"previousMonthLabel\">\n        <svg class=\"slds-button__icon\" nglIconName=\"left\"></svg><span class=\"slds-assistive-text\">{{ previousMonthLabel }}</span>\n      </button>\n    </div>\n    <h2 class=\"slds-align-middle\" [id]=\"uid + '_month'\" aria-live=\"assertive\" aria-atomic=\"true\">{{ monthLabel }}</h2>\n    <div class=\"slds-align-middle\">\n      <button class=\"slds-button slds-button_icon-container\" type=\"button\" (click)=\"moveMonth(1)\" [disabled]=\"nextDisabled()\" [title]=\"nextMonthLabel\">\n        <svg class=\"slds-button__icon\" nglIconName=\"right\"></svg><span class=\"slds-assistive-text\">{{ nextMonthLabel }}</span>\n      </button>\n    </div>\n  </div>\n  <ngl-date-year class=\"slds-shrink-none\" [year]=\"current.year\" [from]=\"minDate\" [to]=\"maxDate\" (yearChange)=\"moveYear($event)\"></ngl-date-year>\n</div>\n<table class=\"datepicker__month\" role=\"grid\" [attr.aria-labelledby]=\"uid + '_month'\" (keydown)=\"keyboardHandler($event)\">\n  <thead>\n    <tr nglWeekdays [firstDayOfWeek]=\"firstDayOfWeek\" [dayNamesShort]=\"dayNamesShort\" [dayNamesLong]=\"dayNamesLong\"></tr>\n  </thead>\n  <tbody *ngIf=\"current\" nglDatepickerMonth [year]=\"current.year\" [month]=\"current.month\" [day]=\"current.day\" [selected]=\"_date\" [firstDayOfWeek]=\"firstDayOfWeek\" [minDate]=\"minDate\" [maxDate]=\"maxDate\" [dateDisabled]=\"dateDisabled\" (selectDate)=\"select($event)\"></tbody>\n</table>\n<button class=\"slds-button slds-align_absolute-center slds-text-link\" *ngIf=\"showToday\" (click)=\"selectToday()\">{{ todayLabel }}</button>",
        changeDetection: ChangeDetectionStrategy.OnPush,
        host: {
            '[class.slds-datepicker]': 'true',
        },
        styles: [`:host { display: block; }`]
    }),
    __param(0, Optional()), __param(0, Inject(NglDatepickerInput)),
    __param(1, Optional()), __param(1, Inject(NGL_DATEPICKER_CONFIG)),
    __param(2, Inject(LOCALE_ID)),
    __metadata("design:paramtypes", [NglDatepickerInput,
        NglDatepickerConfig, String, ElementRef])
], NglDatepicker);
export { NglDatepicker };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0ZXBpY2tlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25nLWxpZ2h0bmluZy8iLCJzb3VyY2VzIjpbImxpYi9kYXRlcGlja2Vycy9kYXRlcGlja2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLHVCQUF1QixFQUFFLFVBQVUsRUFDM0UsTUFBTSxFQUFFLFNBQVMsRUFBRSxhQUFhLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsYUFBYSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN4SCxPQUFPLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUM1SCxPQUFPLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUNuRCxPQUFPLEVBQUUsWUFBWSxFQUFFLFdBQVcsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzVELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQzlELE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxtQkFBbUIsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUN0RSxPQUFPLEVBQW1CLG1CQUFtQixFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDekgsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sU0FBUyxDQUFDO0FBRTdDLE1BQU0sY0FBYyxHQUFHO0lBQ3JCLENBQUMsUUFBUSxDQUFDLEVBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDM0IsQ0FBQyxVQUFVLENBQUMsRUFBRyxDQUFDLE1BQU0sRUFBRSxDQUFDLENB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QSxRQUFRLEVBQUUsQ0FBQSxFQUFFLFdBQUEsTUFBTSxDQUFDLGtCQUFrQixDQUFDLENBQUE7SUFDdEMsV0FBQSxRQUFRLEVBQUUsQ0FBQSxFQUFFLFdBQUEsTUFBTSxDQUFDLHFCQUFxQixDQUFDLENBQUE7SUFDekMsV0FBQSxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUE7cUNBRnVDLGtCQUFrQjtRQUNqQixtQkFBbUIsVUFFNUQsVUFBVTtHQWxFNUIsYUFBYSxDQXdOekI7U0F4TlksYUFBYSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgSW5wdXQsIE91dHB1dCwgRXZlbnRFbWl0dGVyLCBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSwgRWxlbWVudFJlZixcbiAgICAgICAgIE9uSW5pdCwgT25DaGFuZ2VzLCBBZnRlclZpZXdJbml0LCBPcHRpb25hbCwgSW5qZWN0LCBWaWV3Q2hpbGQsIFNpbXBsZUNoYW5nZXMsIExPQ0FMRV9JRCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRU5URVIsIFVQX0FSUk9XLCBMRUZUX0FSUk9XLCBET1dOX0FSUk9XLCBSSUdIVF9BUlJPVywgUEFHRV9VUCwgUEFHRV9ET1dOLCBIT01FLCBFTkQgfSBmcm9tICdAYW5ndWxhci9jZGsva2V5Y29kZXMnO1xuaW1wb3J0IHsgdW5pcXVlSWQsIHRyYXBFdmVudCB9IGZyb20gJy4uL3V0aWwvdXRpbCc7XG5pbXBvcnQgeyBJbnB1dEJvb2xlYW4sIElucHV0TnVtYmVyIH0gZnJvbSAnLi4vdXRpbC9jb252ZXJ0JztcbmltcG9ydCB7IE5nbERhdGVwaWNrZXJJbnB1dCB9IGZyb20gJy4vaW5wdXQvZGF0ZXBpY2tlci1pbnB1dCc7XG5pbXBvcnQgeyBOR0xfREFURVBJQ0tFUl9DT05GSUcsIE5nbERhdGVwaWNrZXJDb25maWcgfSBmcm9tICcuL2NvbmZpZyc7XG5pbXBvcnQgeyBOZ2xJbnRlcm5hbERhdGUsIG51bWJlck9mRGF5c0luTW9udGgsIGdldFRvZGF5LCBpc0Rpc2FibGVkLCBjb21wYXJlRGF0ZSwgaXNTYW1lTW9udGgsIHBhcnNlRGF0ZSB9IGZyb20gJy4vdXRpbCc7XG5pbXBvcnQgeyBOZ2xEYXRlcGlja2VyTW9udGggfSBmcm9tICcuL21vbnRoJztcblxuY29uc3QgS0VZQk9BUkRfTU9WRVMgPSB7XG4gIFtVUF9BUlJPV106ICAgIFsnTW92ZScsIC03XSxcbiAgW0xFRlRfQVJST1ddOiAgWydNb3ZlJywgLTFdLFxuICBbRE9XTl9BUlJPV106ICBbJ01vdmUnLCA3XSxcbiAgW1JJR0hUX0FSUk9XXTogWydNb3ZlJywgMV0sXG4gIFtQQUdFX1VQXTogICAgIFsnTW92ZU1vbnRoJywgLTFdLFxuICBbUEFHRV9ET1dOXTogICBbJ01vdmVNb250aCcsIDFdLFxuICBbSE9NRV06ICAgICAgICBbJ01vdmVUbycsIDFdLFxuICBbRU5EXTogICAgICAgICBbJ01vdmVUbycsIDMxXSxcbn07XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ25nbC1kYXRlcGlja2VyJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2RhdGVwaWNrZXIuaHRtbCcsXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxuICBob3N0OiB7XG4gICAgJ1tjbGFzcy5zbGRzLWRhdGVwaWNrZXJdJzogJ3RydWUnLFxuICB9LFxuICBzdHlsZXM6IFtgOmhvc3QgeyBkaXNwbGF5OiBibG9jazsgfWBdLFxufSlcbmV4cG9ydCBjbGFzcyBOZ2xEYXRlcGlja2VyIGltcGxlbWVudHMgT25Jbml0LCBPbkNoYW5nZXMsIEFmdGVyVmlld0luaXQge1xuICBASW5wdXQoKSByZWFkb25seSBtb250aE5hbWVzOiBzdHJpbmdbXTtcbiAgQElucHV0KCkgcmVhZG9ubHkgZGF5TmFtZXNTaG9ydDogc3RyaW5nW107XG4gIEBJbnB1dCgpIHJlYWRvbmx5IGRheU5hbWVzTG9uZzogc3RyaW5nW107XG4gIEBJbnB1dCgpIGRhdGVEaXNhYmxlZDogKGRhdGU6IERhdGUpID0+IGJvb2xlYW4gfCBudWxsID0gbnVsbDtcblxuICBfZGF0ZTogTmdsSW50ZXJuYWxEYXRlO1xuICBjdXJyZW50OiBOZ2xJbnRlcm5hbERhdGU7XG4gIEBJbnB1dCgpIHNldCBkYXRlKGRhdGU6IERhdGUpIHtcbiAgICB0aGlzLl9kYXRlID0gcGFyc2VEYXRlKGRhdGUpO1xuICB9XG4gIEBPdXRwdXQoKSBkYXRlQ2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gIEBJbnB1dCgpIEBJbnB1dEJvb2xlYW4oKSByZWFkb25seSBzaG93VG9kYXk6IGJvb2xlYW47XG5cbiAgQElucHV0KCkgQElucHV0TnVtYmVyKCkgcmVhZG9ubHkgZmlyc3REYXlPZldlZWs6IG51bWJlcjtcblxuICAvKipcbiAgICogT2Zmc2V0IG9mIHllYXIgZnJvbSBjdXJyZW50IHllYXIsIHRoYXQgY2FuIGJlIHRoZSBtaW5pbXVtIG9wdGlvbiBpbiB0aGUgeWVhciBzZWxlY3Rpb24gZHJvcGRvd24uXG4gICAqL1xuICBASW5wdXQoKSByZWFkb25seSByZWxhdGl2ZVllYXJGcm9tOiBudW1iZXI7XG5cbiAgLyoqXG4gICAqIE9mZnNldCBvZiB5ZWFyIGZyb20gY3VycmVudCB5ZWFyLCB0aGF0IGNhbiBiZSB0aGUgbWF4aW11bSBvcHRpb24gaW4gdGhlIHllYXIgc2VsZWN0aW9uIGRyb3Bkb3duLlxuICAgKi9cbiAgQElucHV0KCkgcmVhZG9ubHkgcmVsYXRpdmVZZWFyVG86IG51bWJlcjtcblxuICAvKipcbiAgICogVGhlIG1pbmltdW0gZGF0ZSB0aGF0IGNhbiBiZSBzZWxlY3RlZC5cbiAgICovXG4gIEBJbnB1dCgpIHJlYWRvbmx5IG1pbjogRGF0ZTtcblxuICAvKipcbiAgICogVGhlIG1heGltdW0gZGF0ZSB0aGF0IGNhbiBiZSBzZWxlY3RlZC5cbiAgICovXG4gIEBJbnB1dCgpIHJlYWRvbmx5IG1heDogRGF0ZTtcblxuICAvKipcbiAgICogTGFiZWwgb2Ygc2hvcnRjdXQgdG8gc2VsZWN0IGN1cnJlbnQgZGF0ZS5cbiAgICovXG4gIEBJbnB1dCgpIHJlYWRvbmx5IHRvZGF5TGFiZWw6IHN0cmluZztcblxuICAvKipcbiAgICogTGFiZWwgZm9yIGJ1dHRvbiB0byBnbyB0byB0aGUgcHJldmlvdXMgbW9udGguXG4gICAqL1xuICBASW5wdXQoKSByZWFkb25seSBwcmV2aW91c01vbnRoTGFiZWw6IHN0cmluZztcblxuICAvKipcbiAgICogTGFiZWwgZm9yIGJ1dHRvbiB0byBnbyB0byB0aGUgbmV4dCBtb250aC5cbiAgICovXG4gIEBJbnB1dCgpIHJlYWRvbmx5IG5leHRNb250aExhYmVsOiBzdHJpbmc7XG5cblxuICB3ZWVrczogTmdsSW50ZXJuYWxEYXRlW107XG4gIHVpZCA9IHVuaXF1ZUlkKCdkYXRlcGlja2VyJyk7XG4gIG1vbnRoTGFiZWw6IHN0cmluZztcblxuICBtaW5EYXRlOiBOZ2xJbnRlcm5hbERhdGU7XG5cbiAgbWF4RGF0ZTogTmdsSW50ZXJuYWxEYXRlO1xuXG4gIEBWaWV3Q2hpbGQoTmdsRGF0ZXBpY2tlck1vbnRoKSBtb250aFZpZXc6IE5nbERhdGVwaWNrZXJNb250aDtcblxuICBjb25zdHJ1Y3RvcihAT3B0aW9uYWwoKSBASW5qZWN0KE5nbERhdGVwaWNrZXJJbnB1dCkgcHJpdmF0ZSBkdElucHV0OiBOZ2xEYXRlcGlja2VySW5wdXQsXG4gICAgICAgICAgICAgIEBPcHRpb25hbCgpIEBJbmplY3QoTkdMX0RBVEVQSUNLRVJfQ09ORklHKSBkZWZhdWx0Q29uZmlnOiBOZ2xEYXRlcGlja2VyQ29uZmlnLFxuICAgICAgICAgICAgICBASW5qZWN0KExPQ0FMRV9JRCkgbG9jYWxlOiBzdHJpbmcsXG4gICAgICAgICAgICAgIHByaXZhdGUgZWxlbWVudDogRWxlbWVudFJlZikge1xuXG4gICAgY29uc3QgY29uZmlnID0geyAuLi5uZXcgTmdsRGF0ZXBpY2tlckNvbmZpZyhsb2NhbGUpLCAuLi5kZWZhdWx0Q29uZmlnIH07XG4gICAgdGhpcy5tb250aE5hbWVzID0gY29uZmlnLm1vbnRoTmFtZXM7XG4gICAgdGhpcy5kYXlOYW1lc1Nob3J0ID0gY29uZmlnLmRheU5hbWVzU2hvcnQ7XG4gICAgdGhpcy5kYXlOYW1lc0xvbmcgPSBjb25maWcuZGF5TmFtZXNMb25nO1xuICAgIHRoaXMuZmlyc3REYXlPZldlZWsgPSBjb25maWcuZmlyc3REYXlPZldlZWs7XG4gICAgdGhpcy5zaG93VG9kYXkgPSBjb25maWcuc2hvd1RvZGF5O1xuICAgIHRoaXMucmVsYXRpdmVZZWFyRnJvbSA9IGNvbmZpZy5yZWxhdGl2ZVllYXJGcm9tO1xuICAgIHRoaXMucmVsYXRpdmVZZWFyVG8gPSBjb25maWcucmVsYXRpdmVZZWFyVG87XG4gICAgdGhpcy50b2RheUxhYmVsID0gY29uZmlnLnRvZGF5TGFiZWw7XG4gICAgdGhpcy5wcmV2aW91c01vbnRoTGFiZWwgPSBjb25maWcucHJldmlvdXNNb250aExhYmVsO1xuICAgIHRoaXMubmV4dE1vbnRoTGFiZWwgPSBjb25maWcubmV4dE1vbnRoTGFiZWw7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLnNldE1pbk1heERhdGVzKCk7XG4gICAgdGhpcy5zZXRDdXJyZW50KHRoaXMuX2RhdGUgfHwgZ2V0VG9kYXkoKSk7XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XG4gICAgaWYgKChjaGFuZ2VzLmRhdGUgJiYgY2hhbmdlcy5kYXRlLmlzRmlyc3RDaGFuZ2UoKSkgfHxcbiAgICAgICAgY2hhbmdlcy5yZWxhdGl2ZVllYXJGcm9tIHx8IGNoYW5nZXMucmVsYXRpdmVZZWFyVG8gfHxcbiAgICAgICAgY2hhbmdlcy5taW4gfHwgY2hhbmdlcy5tYXgpIHtcbiAgICAgIHRoaXMuc2V0TWluTWF4RGF0ZXMoKTtcbiAgICB9XG4gICAgaWYgKGNoYW5nZXMuZGF0ZSkge1xuICAgICAgdGhpcy5zZXRDdXJyZW50KHRoaXMuX2RhdGUpO1xuICAgIH1cbiAgfVxuXG4gIG1vdmVZZWFyKHllYXI6IHN0cmluZyB8IG51bWJlcikge1xuICAgIHRoaXMuc2V0Q3VycmVudCh7IHllYXI6ICt5ZWFyIH0pO1xuICB9XG5cbiAgbW92ZU1vbnRoKGRpZmY6IG51bWJlcikge1xuICAgIHRoaXMubW92ZUNhbGVuZGFyKCdNb3ZlTW9udGgnLCBkaWZmKTtcbiAgfVxuXG4gIGtleWJvYXJkSGFuZGxlcihldnQ6IEtleWJvYXJkRXZlbnQpIHtcbiAgICBjb25zdCBrZXlDb2RlID0gZXZ0LmtleUNvZGU7XG5cbiAgICBpZiAoa2V5Q29kZSA9PT0gRU5URVIpIHtcbiAgICAgIHRyYXBFdmVudChldnQpO1xuICAgICAgaWYgKCF0aGlzLmlzRGlzYWJsZWREYXRlKHRoaXMuY3VycmVudCkpIHtcbiAgICAgICAgdGhpcy5zZWxlY3QodGhpcy5jdXJyZW50KTtcbiAgICAgIH1cbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBtb3ZlID0gS0VZQk9BUkRfTU9WRVNba2V5Q29kZV07XG4gICAgaWYgKCFtb3ZlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gSGFuZGxlIGtleWJvYXJkIGV2ZW50IGluc2lkZSBkYXRlcGlja2VyXG4gICAgdHJhcEV2ZW50KGV2dCk7XG5cbiAgICBjb25zdCBbY29kZSwgcGFyYW1dID0gbW92ZTtcbiAgICB0aGlzLm1vdmVDYWxlbmRhcihjb2RlLCBwYXJhbSk7XG4gICAgdGhpcy5mb2N1c0FjdGl2ZURheSgpO1xuICB9XG5cbiAgc2VsZWN0KGRhdGU6IE5nbEludGVybmFsRGF0ZSkge1xuICAgIGlmIChkYXRlLmRpc2FibGVkKSB7IHJldHVybjsgfVxuXG4gICAgY29uc3Qge3llYXIsIG1vbnRoLCBkYXl9ID0gZGF0ZTtcbiAgICB0aGlzLmRhdGVDaGFuZ2UuZW1pdChuZXcgRGF0ZSh5ZWFyLCBtb250aCwgZGF5KSk7XG4gIH1cblxuICBzZWxlY3RUb2RheSgpIHtcbiAgICBjb25zdCB0b2RheSA9IGdldFRvZGF5KCk7XG4gICAgaWYgKHRoaXMuaXNEaXNhYmxlZERhdGUodG9kYXkpKSB7XG4gICAgICB0aGlzLnNldEN1cnJlbnQodG9kYXkpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmRhdGVDaGFuZ2UuZW1pdChuZXcgRGF0ZSgpKTtcbiAgICB9XG4gIH1cblxuICBuZ0FmdGVyVmlld0luaXQoKSB7XG4gICAgaWYgKHRoaXMuZHRJbnB1dCkge1xuICAgICAgY29uc3QgZWwgPSB0aGlzLmVsZW1lbnQubmF0aXZlRWxlbWVudDtcbiAgICAgIHRoaXMuZHRJbnB1dC51cGRhdGVEYXRlcGlja2VyU2l6ZShlbC5vZmZzZXRXaWR0aCwgZWwub2Zmc2V0SGVpZ2h0KTtcblxuICAgICAgdGhpcy5mb2N1c0FjdGl2ZURheSgpO1xuICAgIH1cbiAgfVxuXG4gIC8qKiBXaGV0aGVyIHRoZSBwcmV2aW91cyBwZXJpb2QgYnV0dG9uIGlzIGRpc2FibGVkLiAqL1xuICBwcmV2aW91c0Rpc2FibGVkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLm1pbkRhdGUgJiYgaXNTYW1lTW9udGgodGhpcy5jdXJyZW50LCB0aGlzLm1pbkRhdGUpO1xuICB9XG5cbiAgLyoqIFdoZXRoZXIgdGhlIG5leHQgcGVyaW9kIGJ1dHRvbiBpcyBkaXNhYmxlZC4gKi9cbiAgbmV4dERpc2FibGVkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLm1heERhdGUgJiYgaXNTYW1lTW9udGgodGhpcy5jdXJyZW50LCB0aGlzLm1heERhdGUpO1xuICB9XG5cbiAgcHJpdmF0ZSBmb2N1c0FjdGl2ZURheSgpIHtcbiAgICB0aGlzLm1vbnRoVmlldy5mb2N1c0FjdGl2ZURheSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBtb3ZlQ2FsZW5kYXIoY29kZTogJ01vdmUnIHwgJ01vdmVNb250aCcgfCAnTW92ZVRvJywgcGFyYW06IG51bWJlcikge1xuICAgIGNvbnN0IHsgeWVhciwgbW9udGgsIGRheSB9ID0gdGhpcy5jdXJyZW50O1xuICAgIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZSh5ZWFyLCBtb250aCwgZGF5LCAxMik7XG5cbiAgICBpZiAoY29kZSA9PT0gJ01vdmUnKSB7XG4gICAgICBkYXRlLnNldERhdGUoZGF5ICsgKCtwYXJhbSkpO1xuICAgICAgdGhpcy5zZXRDdXJyZW50KHsgeWVhcjogZGF0ZS5nZXRGdWxsWWVhcigpLCBtb250aDogZGF0ZS5nZXRNb250aCgpLCBkYXk6IGRhdGUuZ2V0RGF0ZSgpIH0pO1xuICAgIH0gZWxzZSBpZiAoY29kZSA9PT0gJ01vdmVNb250aCcpIHtcbiAgICAgIGRhdGUuc2V0TW9udGgobW9udGggKyAoK3BhcmFtKSwgMSk7XG4gICAgICB0aGlzLnNldEN1cnJlbnQoeyB5ZWFyOiBkYXRlLmdldEZ1bGxZZWFyKCksIG1vbnRoOiBkYXRlLmdldE1vbnRoKCksIGRheSB9KTtcbiAgICB9IGVsc2UgaWYgKGNvZGUgPT09ICdNb3ZlVG8nKSB7XG4gICAgICB0aGlzLnNldEN1cnJlbnQoeyBkYXk6ICtwYXJhbSB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNldEN1cnJlbnQoZDogUGFydGlhbDxOZ2xJbnRlcm5hbERhdGU+LCBkb1JlbmRlciA9IHRydWUpIHtcbiAgICB0aGlzLmN1cnJlbnQgPSB7IC4uLnRoaXMuY3VycmVudCwgLi4uZCB9O1xuXG4gICAgLy8gS2VlcCBjdXJyZW50IGluc2lkZSBtaW5pbXVtL21heGltdW0gcmFuZ2VcbiAgICBpZiAoY29tcGFyZURhdGUodGhpcy5jdXJyZW50LCB0aGlzLm1pbkRhdGUpIDwgMCkge1xuICAgICAgdGhpcy5jdXJyZW50ID0gdGhpcy5taW5EYXRlO1xuICAgIH0gZWxzZSBpZiAoY29tcGFyZURhdGUodGhpcy5jdXJyZW50LCB0aGlzLm1heERhdGUpID4gMCkge1xuICAgICAgdGhpcy5jdXJyZW50ID0gdGhpcy5tYXhEYXRlO1xuICAgIH1cblxuICAgIGlmIChkb1JlbmRlcikge1xuICAgICAgdGhpcy5yZW5kZXIoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJlbmRlcigpIHtcbiAgICBjb25zdCB7IHllYXIsIG1vbnRoLCBkYXkgfSA9IHRoaXMuY3VycmVudDtcbiAgICB0aGlzLm1vbnRoTGFiZWwgPSB0aGlzLm1vbnRoTmFtZXNbbW9udGhdO1xuXG4gICAgLy8gS2VlcCBjdXJyZW50IGRheSBpbnNpZGUgbGltaXRzIG9mIHRoaXMgbW9udGhcbiAgICB0aGlzLnNldEN1cnJlbnQoeyBkYXk6IE1hdGgubWluKGRheSwgbnVtYmVyT2ZEYXlzSW5Nb250aCh5ZWFyLCBtb250aCkpIH0sIGZhbHNlKTtcbiAgfVxuXG4gIC8qKiBEYXRlIGZpbHRlciBmb3IgdGhlIG1vbnRoICovXG4gIHByaXZhdGUgaXNEaXNhYmxlZERhdGUoZGF0ZTogTmdsSW50ZXJuYWxEYXRlKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIGlzRGlzYWJsZWQoZGF0ZSwgdGhpcy5kYXRlRGlzYWJsZWQsIHRoaXMubWluRGF0ZSwgdGhpcy5tYXhEYXRlKTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0TWluTWF4RGF0ZXMoKSB7XG4gICAgY29uc3QgeyB5ZWFyIH0gPSBnZXRUb2RheSgpO1xuICAgIHRoaXMubWluRGF0ZSA9IHRoaXMubWluID8gcGFyc2VEYXRlKHRoaXMubWluKSA6IHsgeWVhcjogeWVhciArIHRoaXMucmVsYXRpdmVZZWFyRnJvbSwgbW9udGg6IDAsIGRheTogMSB9O1xuICAgIHRoaXMubWF4RGF0ZSA9IHRoaXMubWF4ID8gcGFyc2VEYXRlKHRoaXMubWF4KSA6IHsgeWVhcjogeWVhciArIHRoaXMucmVsYXRpdmVZZWFyVG8sIG1vbnRoOiAxMSwgZGF5OiAzMSB9O1xuICB9XG59XG4iXX0=