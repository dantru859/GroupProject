var NglFileUpload_1;
import { __decorate, __metadata } from "tslib";
import { Component, Input, ChangeDetectionStrategy, ElementRef, Renderer2, TemplateRef, HostBinding, OnChanges, SimpleChanges } from '@angular/core';
import { NG_VALUE_ACCESSOR, NG_VALIDATORS } from '@angular/forms';
import { trapEvent, uniqueId } from '../util/util';
import { InputBoolean, InputNumber } from '../util/convert';
import { isFileTypeAccepted } from './file-upload.util';
let NglFileUpload = NglFileUpload_1 = class NglFileUpload {
    constructor(element, renderer) {
        this.element = element;
        this.renderer = renderer;
        /**
         * File types that can be accepted. See [input accept Attribute](https://www.w3schools.com/tags/att_input_accept.asp).
         */
        this.accept = null;
        /**
         * Whether file selection is disabled.
         */
        this.disabled = false;
        /**
          * How many files can be selected simultaneously. `0` means unlimited.
          */
        this.maxFiles = 1;
        /**
         * File size limit in bytes. `0` means unlimited.
         */
        this.maxFilesize = 0;
        /**
         * Message to display when there is in an error state.
         */
        this.error = null;
        /**
         * Text for button to open file selector.
         */
        this.uploadButtonLabel = 'Upload Files';
        /**
         * Text to display inside drop zone.
         */
        this.dropZoneLabel = 'or Drop Files';
        this.uid = uniqueId('file-upload');
        this.isDragOver = false;
        this.files = [];
        this.onChange = null;
        this.onTouched = () => { };
        this.validatorChange = () => { };
        this.renderer.addClass(this.element.nativeElement, 'slds-form-element');
    }
    writeValue(value) {
        this.files = value;
    }
    registerOnChange(fn) { this.onChange = fn; }
    registerOnTouched(fn) { this.onTouched = fn; }
    registerOnValidatorChange(fn) { this.validatorChange = fn; }
    setDisabledState(isDisabled) { this.disabled = isDisabled; }
    validate(c) {
        const files = c.value;
        if (!files || files.length === 0) {
            return null;
        }
        if (this.maxFiles > 0 && files.length > this.maxFiles) {
            return { nglFileUpload: { maxFiles: files.length } };
        }
        for (let i = 0, n = files.length; i < n; i++) {
            const file = files[i];
            if (this.accept && !isFileTypeAccepted(this.accept, file)) {
                return { nglFileUpload: { invalidType: file } };
            }
            if (this.maxFilesize && file.size > this.maxFilesize) {
                return { nglFileUpload: { maxFilesize: file } };
            }
        }
        return null;
    }
    ngOnChanges(changes) {
        if (changes['maxFiles'] || changes['maxFilesize'] || changes['accept']) {
            this.validatorChange();
        }
    }
    onDropZone(evt) {
        trapEvent(evt);
        if (this.disabled) {
            return;
        }
        this.isDragOver = evt.type === 'dragover';
        if (evt.type === 'drop' && evt.dataTransfer) {
            this.select(evt.dataTransfer.files);
        }
    }
    onInputChange(files) {
        this.select(files);
    }
    select(files) {
        this.onChange(Array.from(files));
    }
};
NglFileUpload.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 }
];
__decorate([
    Input(),
    __metadata("design:type", Object)
], NglFileUpload.prototype, "label", void 0);
__decorate([
    Input(),
    __metadata("design:type", Object)
], NglFileUpload.prototype, "accept", void 0);
__decorate([
    Input(), InputBoolean(),
    __metadata("design:type", Object)
], NglFileUpload.prototype, "disabled", void 0);
__decorate([
    Input(), InputNumber(),
    __metadata("design:type", Object)
], NglFileUpload.prototype, "maxFiles", void 0);
__decorate([
    Input(), InputNumber(),
    __metadata("design:type", Object)
], NglFileUpload.prototype, "maxFilesize", void 0);
__decorate([
    HostBinding('class.slds-has-error'),
    Input(),
    __metadata("design:type", Object)
], NglFileUpload.prototype, "error", void 0);
__decorate([
    Input(),
    __metadata("design:type", Object)
], NglFileUpload.prototype, "uploadButtonLabel", void 0);
__decorate([
    Input(),
    __metadata("design:type", Object)
], NglFileUpload.prototype, "dropZoneLabel", void 0);
NglFileUpload = NglFileUpload_1 = __decorate([
    Component({
        selector: 'ngl-file-upload',
        changeDetection: ChangeDetectionStrategy.OnPush,
        template: "<span class=\"slds-form-element__label\" *ngIf=\"label\" [id]=\"uid + '-primary-label'\" [nglInternalOutlet]=\"label\"></span>\n<div class=\"slds-form-element__control\">\n  <div class=\"slds-file-selector slds-file-selector_files\">\n    <div class=\"slds-file-selector__dropzone\" [class.slds-has-drag-over]=\"isDragOver\" (dragover)=\"onDropZone($event)\" (dragleave)=\"onDropZone($event)\" (drop)=\"onDropZone($event)\">\n      <input class=\"slds-file-selector__input slds-assistive-text\" type=\"file\" [id]=\"uid\" [attr.accept]=\"accept\" [disabled]=\"disabled\" [multiple]=\"maxFiles !== 1\" [attr.aria-describedby]=\"error ? uid + '-error' : null\" [attr.aria-labelledby]=\"uid + '-primary-label ' + uid + '-secondary-label'\" (change)=\"onInputChange($event.target.files)\">\n      <label class=\"slds-file-selector__body\" [attr.for]=\"uid\" [id]=\"uid + '-secondary-label'\"><span class=\"slds-file-selector__button slds-button slds-button_neutral\">\n          <svg class=\"slds-button__icon slds-button__icon_left\" nglIconName=\"utility:upload\"></svg>{{ uploadButtonLabel }}</span><span class=\"slds-file-selector__text slds-medium-show\">{{ dropZoneLabel }}</span></label>\n    </div>\n  </div>\n</div>\n<div class=\"slds-form-element__help\" *ngIf=\"error\" [id]=\"uid + '-error'\" [nglInternalOutlet]=\"error\"></div>",
        providers: [
            {
                provide: NG_VALUE_ACCESSOR,
                useExisting: NglFileUpload_1,
                multi: true
            },
            {
                provide: NG_VALIDATORS,
                useExisting: NglFileUpload_1,
                multi: true
            }
        ]
    }),
    __metadata("design:paramtypes", [ElementRef, Renderer2])
], NglFileUpload);
export { NglFileUpload };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZS11cGxvYWQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZy1saWdodG5pbmcvIiwic291cmNlcyI6WyJsaWIvZmlsZS11cGxvYWQvZmlsZS11cGxvYWQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSx1QkFBdUIsRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQUUsU0FBUyxFQUFFLGFBQWEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNySixPQUFPLEVBQUUsaUJBQWlCLEVBQXdCLGFBQWEsRUFBZ0QsTUFBTSxnQkFBZ0IsQ0FBQztBQUN0SSxPQUFPLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUNuRCxPQUFPLEVBQUUsWUFBWSxFQUFFLFdBQVcsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzVELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBbUJ4RCxJQUFhLGFBQWEscUJBQTFCLE1BQWEsYUFBYTtJQWlEeEIsWUFBb0IsT0FBbUIsRUFBVSxRQUFtQjtRQUFoRCxZQUFPLEdBQVAsT0FBTyxDQUFZO1FBQVUsYUFBUSxHQUFSLFFBQVEsQ0FBVztRQTFDcEU7O1dBRUc7UUFDTSxXQUFNLEdBQXNCLElBQUksQ0FBQztRQUUxQzs7V0FFRztRQUNzQixhQUFRLEdBQUcsS0FBSyxDQUFDO1FBRTFDOztZQUVJO1FBQ29CLGFBQVEsR0FBRyxDQUFDLENBQUM7UUFFckM7O1dBRUc7UUFDcUIsZ0JBQVcsR0FBRyxDQUFDLENBQUM7UUFFeEM7O1dBRUc7UUFFTSxVQUFLLEdBQThCLElBQUksQ0FBQztRQUVqRDs7V0FFRztRQUNNLHNCQUFpQixHQUFHLGNBQWMsQ0FBQztRQUU1Qzs7V0FFRztRQUNNLGtCQUFhLEdBQUcsZUFBZSxDQUFDO1FBRXpDLFFBQUcsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLENBQUM7UUFFOUIs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aGFuZ2VEZXRlY3Rpb25TdHJhdGVneSwgRWxlbWVudFJlZiwgUmVuZGVyZXIyLCBUZW1wbGF0ZVJlZiwgSG9zdEJpbmRpbmcsIE9uQ2hhbmdlcywgU2ltcGxlQ2hhbmdlcyB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTkdfVkFMVUVfQUNDRVNTT1IsIENvbnRyb2xWYWx1ZUFjY2Vzc29yLCBOR19WQUxJREFUT1JTLCBWYWxpZGF0b3IsIEFic3RyYWN0Q29udHJvbCwgVmFsaWRhdGlvbkVycm9ycyB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IHRyYXBFdmVudCwgdW5pcXVlSWQgfSBmcm9tICcuLi91dGlsL3V0aWwnO1xuaW1wb3J0IHsgSW5wdXRCb29sZWFuLCBJbnB1dE51bWJlciB9IGZyb20gJy4uL3V0aWwvY29udmVydCc7XG5pbXBvcnQgeyBpc0ZpbGVUeXBlQWNjZXB0ZWQgfSBmcm9tICcuL2ZpbGUtdXBsb2FkLnV0aWwnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICduZ2wtZmlsZS11cGxvYWQnLFxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaCxcbiAgdGVtcGxhdGVVcmw6ICcuL2ZpbGUtdXBsb2FkLmh0bWwnLFxuICBwcm92aWRlcnM6IFtcbiAgICB7XG4gICAgICBwcm92aWRlOiBOR19WQUxVRV9BQ0NFU1NPUixcbiAgICAgIHVzZUV4aXN0aW5nOiBOZ2xGaWxlVXBsb2FkLFxuICAgICAgbXVsdGk6IHRydWVcbiAgICB9LFxuICAgIHtcbiAgICAgIHByb3ZpZGU6IE5HX1ZBTElEQVRPUlMsXG4gICAgICB1c2VFeGlzdGluZzogTmdsRmlsZVVwbG9hZCxcbiAgICAgIG11bHRpOiB0cnVlXG4gICAgfVxuICBdLFxufSlcbmV4cG9ydCBjbGFzcyBOZ2xGaWxlVXBsb2FkIGltcGxlbWVudHMgQ29udHJvbFZhbHVlQWNjZXNzb3IsIFZhbGlkYXRvciwgT25DaGFuZ2VzIHtcblxuICAvKipcbiAgICogTGFiZWwgdGhhdCBhcHBlYXJzIGFib3ZlIHRoZSB1cGxvYWQgYXJlYS5cbiAgICovXG4gIEBJbnB1dCgpIGxhYmVsOiBzdHJpbmcgfCBUZW1wbGF0ZVJlZjxhbnk+O1xuXG4gIC8qKlxuICAgKiBGaWxlIHR5cGVzIHRoYXQgY2FuIGJlIGFjY2VwdGVkLiBTZWUgW2lucHV0IGFjY2VwdCBBdHRyaWJ1dGVdKGh0dHBzOi8vd3d3Lnczc2Nob29scy5jb20vdGFncy9hdHRfaW5wdXRfYWNjZXB0LmFzcCkuXG4gICAqL1xuICBASW5wdXQoKSBhY2NlcHQ6IHN0cmluZyB8IHN0cmluZ1tdID0gbnVsbDtcblxuICAvKipcbiAgICogV2hldGhlciBmaWxlIHNlbGVjdGlvbiBpcyBkaXNhYmxlZC5cbiAgICovXG4gIEBJbnB1dCgpIEBJbnB1dEJvb2xlYW4oKSBkaXNhYmxlZCA9IGZhbHNlO1xuXG4gIC8qKlxuICAgICogSG93IG1hbnkgZmlsZXMgY2FuIGJlIHNlbGVjdGVkIHNpbXVsdGFuZW91c2x5LiBgMGAgbWVhbnMgdW5saW1pdGVkLlxuICAgICovXG4gIEBJbnB1dCgpIEBJbnB1dE51bWJlcigpIG1heEZpbGVzID0gMTtcblxuICAvKipcbiAgICogRmlsZSBzaXplIGxpbWl0IGluIGJ5dGVzLiBgMGAgbWVhbnMgdW5saW1pdGVkLlxuICAgKi9cbiAgQElucHV0KCkgQElucHV0TnVtYmVyKCkgbWF4RmlsZXNpemUgPSAwO1xuXG4gIC8qKlxuICAgKiBNZXNzYWdlIHRvIGRpc3BsYXkgd2hlbiB0aGVyZSBpcyBpbiBhbiBlcnJvciBzdGF0ZS5cbiAgICovXG4gIEBIb3N0QmluZGluZygnY2xhc3Muc2xkcy1oYXMtZXJyb3InKVxuICBASW5wdXQoKSBlcnJvcjogc3RyaW5nIHwgVGVtcGxhdGVSZWY8YW55PiA9IG51bGw7XG5cbiAgLyoqXG4gICAqIFRleHQgZm9yIGJ1dHRvbiB0byBvcGVuIGZpbGUgc2VsZWN0b3IuXG4gICAqL1xuICBASW5wdXQoKSB1cGxvYWRCdXR0b25MYWJlbCA9ICdVcGxvYWQgRmlsZXMnO1xuXG4gIC8qKlxuICAgKiBUZXh0IHRvIGRpc3BsYXkgaW5zaWRlIGRyb3Agem9uZS5cbiAgICovXG4gIEBJbnB1dCgpIGRyb3Bab25lTGFiZWwgPSAnb3IgRHJvcCBGaWxlcyc7XG5cbiAgdWlkID0gdW5pcXVlSWQoJ2ZpbGUtdXBsb2FkJyk7XG5cbiAgaXNEcmFnT3ZlciA9IGZhbHNlO1xuXG4gIGZpbGVzOiBGaWxlW10gPSBbXTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGVsZW1lbnQ6IEVsZW1lbnRSZWYsIHByaXZhdGUgcmVuZGVyZXI6IFJlbmRlcmVyMikge1xuICAgIHRoaXMucmVuZGVyZXIuYWRkQ2xhc3ModGhpcy5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQsICdzbGRzLWZvcm0tZWxlbWVudCcpO1xuICB9XG5cbiAgb25DaGFuZ2U6IEZ1bmN0aW9uIHwgbnVsbCA9IG51bGw7XG5cbiAgb25Ub3VjaGVkID0gKCkgPT4ge307XG5cbiAgdmFsaWRhdG9yQ2hhbmdlID0gKCkgPT4ge307XG5cbiAgd3JpdGVWYWx1ZSh2YWx1ZTogRmlsZVtdKSB7XG4gICAgdGhpcy5maWxlcyA9IHZhbHVlO1xuICB9XG5cbiAgcmVnaXN0ZXJPbkNoYW5nZShmbjogKHZhbHVlOiBhbnkpID0+IGFueSk6IHZvaWQgeyB0aGlzLm9uQ2hhbmdlID0gZm47IH1cblxuICByZWdpc3Rlck9uVG91Y2hlZChmbjogKCkgPT4gYW55KTogdm9pZCB7IHRoaXMub25Ub3VjaGVkID0gZm47IH1cblxuICByZWdpc3Rlck9uVmFsaWRhdG9yQ2hhbmdlKGZuOiAoKSA9PiB2b2lkKTogdm9pZCB7IHRoaXMudmFsaWRhdG9yQ2hhbmdlID0gZm47IH1cblxuICBzZXREaXNhYmxlZFN0YXRlKGlzRGlzYWJsZWQ6IGJvb2xlYW4pIHsgdGhpcy5kaXNhYmxlZCA9IGlzRGlzYWJsZWQ7IH1cblxuICB2YWxpZGF0ZShjOiBBYnN0cmFjdENvbnRyb2wpOiBWYWxpZGF0aW9uRXJyb3JzIHwgbnVsbCB7XG4gICAgY29uc3QgZmlsZXMgPSBjLnZhbHVlIGFzIEZpbGVbXTtcblxuICAgIGlmICghZmlsZXMgfHwgZmlsZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5tYXhGaWxlcyA+IDAgJiYgZmlsZXMubGVuZ3RoID4gdGhpcy5tYXhGaWxlcykge1xuICAgICAgcmV0dXJuIHsgbmdsRmlsZVVwbG9hZDogeyBtYXhGaWxlczogZmlsZXMubGVuZ3RoIH0gfTtcbiAgICB9XG5cbiAgICBmb3IgKGxldCBpID0gMCwgbiA9IGZpbGVzLmxlbmd0aDsgaSA8IG47IGkrKykge1xuICAgICAgY29uc3QgZmlsZSA9IGZpbGVzW2ldO1xuICAgICAgaWYgKHRoaXMuYWNjZXB0ICYmICFpc0ZpbGVUeXBlQWNjZXB0ZWQodGhpcy5hY2NlcHQsIGZpbGUpKSB7XG4gICAgICAgIHJldHVybiB7IG5nbEZpbGVVcGxvYWQ6IHsgaW52YWxpZFR5cGU6IGZpbGUgfSB9O1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMubWF4RmlsZXNpemUgJiYgZmlsZS5zaXplID4gdGhpcy5tYXhGaWxlc2l6ZSkge1xuICAgICAgICByZXR1cm4geyBuZ2xGaWxlVXBsb2FkOiB7IG1heEZpbGVzaXplOiBmaWxlIH0gfTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICBpZiAoY2hhbmdlc1snbWF4RmlsZXMnXSB8fCBjaGFuZ2VzWydtYXhGaWxlc2l6ZSddIHx8IGNoYW5nZXNbJ2FjY2VwdCddKSB7XG4gICAgICB0aGlzLnZhbGlkYXRvckNoYW5nZSgpO1xuICAgIH1cbiAgfVxuXG4gIG9uRHJvcFpvbmUoZXZ0OiBEcmFnRXZlbnQpIHtcbiAgICB0cmFwRXZlbnQoZXZ0KTtcbiAgICBpZiAodGhpcy5kaXNhYmxlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMuaXNEcmFnT3ZlciA9IGV2dC50eXBlID09PSAnZHJhZ292ZXInO1xuXG4gICAgaWYgKGV2dC50eXBlID09PSAnZHJvcCcgJiYgZXZ0LmRhdGFUcmFuc2Zlcikge1xuICAgICAgdGhpcy5zZWxlY3QoZXZ0LmRhdGFUcmFuc2Zlci5maWxlcyk7XG4gICAgfVxuICB9XG5cbiAgb25JbnB1dENoYW5nZShmaWxlczogRmlsZUxpc3QpIHtcbiAgICB0aGlzLnNlbGVjdChmaWxlcyk7XG4gIH1cblxuICBwcml2YXRlIHNlbGVjdChmaWxlczogRmlsZUxpc3QpIHtcbiAgICB0aGlzLm9uQ2hhbmdlKEFycmF5LmZyb20oZmlsZXMpKTtcbiAgfVxufVxuIl19