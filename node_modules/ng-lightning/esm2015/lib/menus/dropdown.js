import { __decorate, __metadata } from "tslib";
import { Directive, Input, Output, EventEmitter, HostListener, ElementRef, OnInit, OnDestroy, ContentChildren, QueryList, Renderer2 } from '@angular/core';
import { toBoolean, InputBoolean } from '../util/convert';
import { NglDropdownItem } from './dropdown-item';
const openEventEmitter = new EventEmitter();
let NglDropdown = class NglDropdown {
    constructor(element, renderer) {
        this.element = element;
        this.renderer = renderer;
        this.handlePageEvents = true;
        this.isOpenChange = new EventEmitter();
        this.triggerFocusEventEmitter = new EventEmitter();
        this._isOpen = false;
        this.globalClickEventUnsubscriber = null;
        this.clickEventUnsubscriber = null;
    }
    set isOpen(isOpen) {
        this._isOpen = toBoolean(isOpen);
        if (this.isOpen) {
            this.clearGlobalClickTimeout();
            this.globalClickTimeout = setTimeout(() => {
                if (this.handlePageEvents) {
                    this._subscribeToClickEvents();
                }
            });
            this.renderer.addClass(this.element.nativeElement, 'slds-is-open');
        }
        else {
            this._unsubscribeFromClickEvents();
            this.renderer.removeClass(this.element.nativeElement, 'slds-is-open');
        }
        this.renderer.setAttribute(this.element.nativeElement, 'aria-expanded', `${this.isOpen}`);
    }
    get isOpen() {
        return this._isOpen;
    }
    onKeydownClose(eventName) {
        this.toggle(false);
        if (eventName === 'esc') {
            this.triggerFocusEventEmitter.emit(null);
        }
    }
    onKeydownFocusNext($event, direction) {
        $event.preventDefault();
        this.focusItem(direction);
    }
    ngOnInit() {
        this.openEventSubscription = openEventEmitter.subscribe(this.handleDropdownOpenEvent.bind(this));
    }
    ngOnDestroy() {
        this.clearGlobalClickTimeout();
        if (this.openEventSubscription) {
            this.openEventSubscription.unsubscribe();
        }
        this._unsubscribeFromClickEvents();
    }
    toggle(toggle = !this.isOpen, focus = false) {
        if (toggle === this.isOpen) {
            return;
        }
        this.isOpenChange.emit(toggle);
        if (toggle) {
            openEventEmitter.emit(this);
            if (focus) {
                this.focusItem('next');
            }
        }
    }
    handleGlobalClickEvent($event) {
        if (!this.handlePageEvents || $event.$nglStop) {
            return;
        }
        this.toggle(false);
    }
    _subscribeToClickEvents() {
        this._unsubscribeFromClickEvents();
        // Prevent document listener to close it, since click happened inside
        this.clickEventUnsubscriber = this.renderer.listen(this.element.nativeElement, 'click', ($event) => $event.$nglStop = true);
        this.globalClickEventUnsubscriber = this.renderer.listen('document', 'click', this.handleGlobalClickEvent.bind(this));
    }
    _unsubscribeFromClickEvents() {
        if (this.clickEventUnsubscriber) {
            this.clickEventUnsubscriber();
            this.clickEventUnsubscriber = null;
        }
        if (this.globalClickEventUnsubscriber) {
            this.globalClickEventUnsubscriber();
            this.globalClickEventUnsubscriber = null;
        }
    }
    clearGlobalClickTimeout() {
        clearTimeout(this.globalClickTimeout);
    }
    focusItem(direction) {
        if (!this.items.length) {
            return;
        }
        const items = this.items.toArray();
        const activeElementIndex = items.findIndex(item => item.hasFocus()) + (direction === 'next' ? 1 : -1);
        if (activeElementIndex === items.length || activeElementIndex < 0) {
            return;
        }
        items[activeElementIndex].focus();
    }
    handleDropdownOpenEvent(dropdown) {
        if (dropdown !== this) {
            this.toggle(false);
        }
    }
};
NglDropdown.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 }
];
__decorate([
    Input('open'),
    __metadata("design:type", Boolean),
    __metadata("design:paramtypes", [Boolean])
], NglDropdown.prototype, "isOpen", null);
__decorate([
    Input(), InputBoolean(),
    __metadata("design:type", Object)
], NglDropdown.prototype, "handlePageEvents", void 0);
__decorate([
    ContentChildren(NglDropdownItem, { descendants: true }),
    __metadata("design:type", QueryList)
], NglDropdown.prototype, "items", void 0);
__decorate([
    Output('openChange'),
    __metadata("design:type", Object)
], NglDropdown.prototype, "isOpenChange", void 0);
__decorate([
    HostListener('keydown.esc', ['"esc"']),
    HostListener('keydown.tab', ['"tab"']),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String]),
    __metadata("design:returntype", void 0)
], NglDropdown.prototype, "onKeydownClose", null);
__decorate([
    HostListener('keydown.arrowdown', ['$event', '"next"']),
    HostListener('keydown.arrowup', ['$event', '"previous"']),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Event, String]),
    __metadata("design:returntype", void 0)
], NglDropdown.prototype, "onKeydownFocusNext", null);
NglDropdown = __decorate([
    Directive({
        selector: '[nglDropdown]',
        host: {
            '[class.slds-dropdown-trigger]': 'true',
            '[class.slds-dropdown-trigger_click]': 'true',
        },
    }),
    __metadata("design:paramtypes", [ElementRef, Renderer2])
], NglDropdown);
export { NglDropdown };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJvcGRvd24uanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZy1saWdodG5pbmcvIiwic291cmNlcyI6WyJsaWIvbWVudXMvZHJvcGRvd24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLGVBQWUsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNKLE9BQU8sRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDMUQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRWxELE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztBQVNqRCxJQUFhLFdBQVcsR0FBeEIsTUFBYSxXQUFXO0lBbUR0QixZQUFtQixPQUFtQixFQUFTLFFBQW1CO1FBQS9DLFlBQU8sR0FBUCxPQUFPLENBQVk7UUFBUyxhQUFRLEdBQVIsUUFBUSxDQUFXO1FBM0J6QyxxQkFBZ0IsR0FBRyxJQUFJLENBQUM7UUFFM0IsaUJBQVksR0FBRyxJQUFJLFlBQVksRUFBVyxDQUFDO1FBRWpFLDZCQUF3QixHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFFdEMsWUFBTyxHQUFHLEtBQUssQ0FBQztRQUVoQixpQ0FBNEIsR0FBYSxJQUFJLENBQUM7UUFDOUMsMkJBQXNCLEdBQWEsSUFBSSxDQUFDO0lBa0JxQixDQUFDO0lBbER2RCxJQUFJLE1BQU0sQ0FBQyxNQUFlO1FBQ3ZDLElBQUksQ0FBQyxPQUFPLEdBQUcsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRWpDLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNmLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxDQUFDO1lBQy9CLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxVQUFVLENBQUMsR0FB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QUMsS0FBSyxDQUFDLENBQUM7U0FDcEI7SUFDSCxDQUFDO0NBRUYsQ0FBQTs7WUE3RTZCLFVBQVU7WUFBbUIsU0FBUzs7QUFsRG5EO0lBQWQsS0FBSyxDQUFDLE1BQU0sQ0FBQzs7O3lDQWtCYjtBQUt3QjtJQUF4QixLQUFLLEVBQUUsRUFBRSxZQUFZLEVBQUU7O3FEQUF5QjtBQUNNO0lBQXRELGVBQWUsQ0FBQyxlQUFlLEVBQUUsRUFBQyxXQUFXLEVBQUUsSUFBSSxFQUFDLENBQUM7OEJBQVEsU0FBUzswQ0FBa0I7QUFDbkU7SUFBckIsTUFBTSxDQUFDLFlBQVksQ0FBQzs7aURBQTRDO0FBWWpFO0lBRkMsWUFBWSxDQUFDLGFBQWEsRUFBRSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3RDLFlBQVksQ0FBQyxhQUFhLEVBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQzs7OztpREFNdEM7QUFHRDtJQUZDLFlBQVksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQztJQUN2RCxZQUFZLENBQUMsaUJBQWlCLEVBQUUsQ0FBQyxRQUFRLEVBQUUsWUFBWSxDQUFDLENBQUM7O3FDQUMvQixLQUFLOztxREFHL0I7QUFqRFUsV0FBVztJQVB2QixTQUFTLENBQUM7UUFDVCxRQUFRLEVBQUUsZUFBZTtRQUN6QixJQUFJLEVBQUU7WUFDSiwrQkFBK0IsRUFBRSxNQUFNO1lBQ3ZDLHFDQUFxQyxFQUFFLE1BQU07U0FDOUM7S0FDRixDQUFDO3FDQW9ENEIsVUFBVSxFQUFtQixTQUFTO0dBbkR2RCxXQUFXLENBZ0l2QjtTQWhJWSxXQUFXIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlyZWN0aXZlLCBJbnB1dCwgT3V0cHV0LCBFdmVudEVtaXR0ZXIsIEhvc3RMaXN0ZW5lciwgRWxlbWVudFJlZiwgT25Jbml0LCBPbkRlc3Ryb3ksIENvbnRlbnRDaGlsZHJlbiwgUXVlcnlMaXN0LCBSZW5kZXJlcjIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IHRvQm9vbGVhbiwgSW5wdXRCb29sZWFuIH0gZnJvbSAnLi4vdXRpbC9jb252ZXJ0JztcbmltcG9ydCB7IE5nbERyb3Bkb3duSXRlbSB9IGZyb20gJy4vZHJvcGRvd24taXRlbSc7XG5cbmNvbnN0IG9wZW5FdmVudEVtaXR0ZXIgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuQERpcmVjdGl2ZSh7XG4gIHNlbGVjdG9yOiAnW25nbERyb3Bkb3duXScsXG4gIGhvc3Q6IHtcbiAgICAnW2NsYXNzLnNsZHMtZHJvcGRvd24tdHJpZ2dlcl0nOiAndHJ1ZScsXG4gICAgJ1tjbGFzcy5zbGRzLWRyb3Bkb3duLXRyaWdnZXJfY2xpY2tdJzogJ3RydWUnLFxuICB9LFxufSlcbmV4cG9ydCBjbGFzcyBOZ2xEcm9wZG93biBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcbiAgQElucHV0KCdvcGVuJykgc2V0IGlzT3Blbihpc09wZW46IGJvb2xlYW4pIHtcbiAgICB0aGlzLl9pc09wZW4gPSB0b0Jvb2xlYW4oaXNPcGVuKTtcblxuICAgIGlmICh0aGlzLmlzT3Blbikge1xuICAgICAgdGhpcy5jbGVhckdsb2JhbENsaWNrVGltZW91dCgpO1xuICAgICAgdGhpcy5nbG9iYWxDbGlja1RpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgaWYgKHRoaXMuaGFuZGxlUGFnZUV2ZW50cykge1xuICAgICAgICAgIHRoaXMuX3N1YnNjcmliZVRvQ2xpY2tFdmVudHMoKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIHRoaXMucmVuZGVyZXIuYWRkQ2xhc3ModGhpcy5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQsICdzbGRzLWlzLW9wZW4nKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fdW5zdWJzY3JpYmVGcm9tQ2xpY2tFdmVudHMoKTtcbiAgICAgIHRoaXMucmVuZGVyZXIucmVtb3ZlQ2xhc3ModGhpcy5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQsICdzbGRzLWlzLW9wZW4nKTtcbiAgICB9XG5cbiAgICB0aGlzLnJlbmRlcmVyLnNldEF0dHJpYnV0ZSh0aGlzLmVsZW1lbnQubmF0aXZlRWxlbWVudCwgJ2FyaWEtZXhwYW5kZWQnLCBgJHt0aGlzLmlzT3Blbn1gKTtcbiAgfVxuICBnZXQgaXNPcGVuKCkge1xuICAgIHJldHVybiB0aGlzLl9pc09wZW47XG4gIH1cblxuICBASW5wdXQoKSBASW5wdXRCb29sZWFuKCkgaGFuZGxlUGFnZUV2ZW50cyA9IHRydWU7XG4gIEBDb250ZW50Q2hpbGRyZW4oTmdsRHJvcGRvd25JdGVtLCB7ZGVzY2VuZGFudHM6IHRydWV9KSBpdGVtczogUXVlcnlMaXN0PE5nbERyb3Bkb3duSXRlbT47XG4gIEBPdXRwdXQoJ29wZW5DaGFuZ2UnKSBpc09wZW5DaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyPGJvb2xlYW4+KCk7XG5cbiAgdHJpZ2dlckZvY3VzRXZlbnRFbWl0dGVyID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gIHByaXZhdGUgX2lzT3BlbiA9IGZhbHNlO1xuICBwcml2YXRlIG9wZW5FdmVudFN1YnNjcmlwdGlvbjogYW55O1xuICBwcml2YXRlIGdsb2JhbENsaWNrRXZlbnRVbnN1YnNjcmliZXI6IEZ1bmN0aW9uID0gbnVsbDtcbiAgcHJpdmF0ZSBjbGlja0V2ZW50VW5zdWJzY3JpYmVyOiBGdW5jdGlvbiA9IG51bGw7XG4gIHByaXZhdGUgZ2xvYmFsQ2xpY2tUaW1lb3V0OiBudW1iZXI7XG5cbiAgQEhvc3RMaXN0ZW5lcigna2V5ZG93bi5lc2MnLCBbJ1wiZXNjXCInXSlcbiAgQEhvc3RMaXN0ZW5lcigna2V5ZG93bi50YWInLCBbJ1widGFiXCInXSlcbiAgb25LZXlkb3duQ2xvc2UoZXZlbnROYW1lOiBzdHJpbmcpIHtcbiAgICB0aGlzLnRvZ2dsZShmYWxzZSk7XG4gICAgaWYgKGV2ZW50TmFtZSA9PT0gJ2VzYycpIHtcbiAgICAgIHRoaXMudHJpZ2dlckZvY3VzRXZlbnRFbWl0dGVyLmVtaXQobnVsbCk7XG4gICAgfVxuICB9XG4gIEBIb3N0TGlzdGVuZXIoJ2tleWRvd24uYXJyb3dkb3duJywgWyckZXZlbnQnLCAnXCJuZXh0XCInXSlcbiAgQEhvc3RMaXN0ZW5lcigna2V5ZG93bi5hcnJvd3VwJywgWyckZXZlbnQnLCAnXCJwcmV2aW91c1wiJ10pXG4gIG9uS2V5ZG93bkZvY3VzTmV4dCgkZXZlbnQ6IEV2ZW50LCBkaXJlY3Rpb246ICduZXh0JyB8ICdwcmV2aW91cycpIHtcbiAgICAkZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICB0aGlzLmZvY3VzSXRlbShkaXJlY3Rpb24pO1xuICB9XG5cbiAgY29uc3RydWN0b3IocHVibGljIGVsZW1lbnQ6IEVsZW1lbnRSZWYsIHB1YmxpYyByZW5kZXJlcjogUmVuZGVyZXIyKSB7fVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMub3BlbkV2ZW50U3Vic2NyaXB0aW9uID0gb3BlbkV2ZW50RW1pdHRlci5zdWJzY3JpYmUodGhpcy5oYW5kbGVEcm9wZG93bk9wZW5FdmVudC5iaW5kKHRoaXMpKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuY2xlYXJHbG9iYWxDbGlja1RpbWVvdXQoKTtcbiAgICBpZiAodGhpcy5vcGVuRXZlbnRTdWJzY3JpcHRpb24pIHtcbiAgICAgIHRoaXMub3BlbkV2ZW50U3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuICAgIHRoaXMuX3Vuc3Vic2NyaWJlRnJvbUNsaWNrRXZlbnRzKCk7XG4gIH1cblxuICB0b2dnbGUodG9nZ2xlOiBib29sZWFuID0gIXRoaXMuaXNPcGVuLCBmb2N1czogYm9vbGVhbiA9IGZhbHNlKSB7XG4gICAgaWYgKHRvZ2dsZSA9PT0gdGhpcy5pc09wZW4pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5pc09wZW5DaGFuZ2UuZW1pdCh0b2dnbGUpO1xuICAgIGlmICh0b2dnbGUpIHtcbiAgICAgIG9wZW5FdmVudEVtaXR0ZXIuZW1pdCh0aGlzKTtcbiAgICAgIGlmIChmb2N1cykge1xuICAgICAgICB0aGlzLmZvY3VzSXRlbSgnbmV4dCcpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlR2xvYmFsQ2xpY2tFdmVudCgkZXZlbnQ6IGFueSkge1xuICAgIGlmICghdGhpcy5oYW5kbGVQYWdlRXZlbnRzIHx8ICRldmVudC4kbmdsU3RvcCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLnRvZ2dsZShmYWxzZSk7XG4gIH1cblxuICBwcml2YXRlIF9zdWJzY3JpYmVUb0NsaWNrRXZlbnRzKCkge1xuICAgIHRoaXMuX3Vuc3Vic2NyaWJlRnJvbUNsaWNrRXZlbnRzKCk7XG5cbiAgICAvLyBQcmV2ZW50IGRvY3VtZW50IGxpc3RlbmVyIHRvIGNsb3NlIGl0LCBzaW5jZSBjbGljayBoYXBwZW5lZCBpbnNpZGVcbiAgICB0aGlzLmNsaWNrRXZlbnRVbnN1YnNjcmliZXIgPSB0aGlzLnJlbmRlcmVyLmxpc3Rlbih0aGlzLmVsZW1lbnQubmF0aXZlRWxlbWVudCwgJ2NsaWNrJywgKCRldmVudDogYW55KSA9PiAkZXZlbnQuJG5nbFN0b3AgPSB0cnVlKTtcblxuICAgIHRoaXMuZ2xvYmFsQ2xpY2tFdmVudFVuc3Vic2NyaWJlciA9IHRoaXMucmVuZGVyZXIubGlzdGVuKCdkb2N1bWVudCcsICdjbGljaycsIHRoaXMuaGFuZGxlR2xvYmFsQ2xpY2tFdmVudC5iaW5kKHRoaXMpKTtcbiAgfVxuXG4gIHByaXZhdGUgX3Vuc3Vic2NyaWJlRnJvbUNsaWNrRXZlbnRzKCkge1xuICAgIGlmICh0aGlzLmNsaWNrRXZlbnRVbnN1YnNjcmliZXIpIHtcbiAgICAgIHRoaXMuY2xpY2tFdmVudFVuc3Vic2NyaWJlcigpO1xuICAgICAgdGhpcy5jbGlja0V2ZW50VW5zdWJzY3JpYmVyID0gbnVsbDtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5nbG9iYWxDbGlja0V2ZW50VW5zdWJzY3JpYmVyKSB7XG4gICAgICB0aGlzLmdsb2JhbENsaWNrRXZlbnRVbnN1YnNjcmliZXIoKTtcbiAgICAgIHRoaXMuZ2xvYmFsQ2xpY2tFdmVudFVuc3Vic2NyaWJlciA9IG51bGw7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjbGVhckdsb2JhbENsaWNrVGltZW91dCgpIHtcbiAgICBjbGVhclRpbWVvdXQodGhpcy5nbG9iYWxDbGlja1RpbWVvdXQpO1xuICB9XG5cbiAgcHJpdmF0ZSBmb2N1c0l0ZW0oZGlyZWN0aW9uOiAnbmV4dCcgfCAncHJldmlvdXMnKSB7XG4gICAgaWYgKCF0aGlzLml0ZW1zLmxlbmd0aCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBpdGVtcyA9IHRoaXMuaXRlbXMudG9BcnJheSgpO1xuICAgIGNvbnN0IGFjdGl2ZUVsZW1lbnRJbmRleCA9IGl0ZW1zLmZpbmRJbmRleChpdGVtID0+IGl0ZW0uaGFzRm9jdXMoKSkgKyAoZGlyZWN0aW9uID09PSAnbmV4dCcgPyAxIDogLTEpO1xuICAgIGlmIChhY3RpdmVFbGVtZW50SW5kZXggPT09IGl0ZW1zLmxlbmd0aCB8fCBhY3RpdmVFbGVtZW50SW5kZXggPCAwKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGl0ZW1zW2FjdGl2ZUVsZW1lbnRJbmRleF0uZm9jdXMoKTtcbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlRHJvcGRvd25PcGVuRXZlbnQoZHJvcGRvd246IE5nbERyb3Bkb3duKSB7XG4gICAgaWYgKGRyb3Bkb3duICE9PSB0aGlzKSB7XG4gICAgICB0aGlzLnRvZ2dsZShmYWxzZSk7XG4gICAgfVxuICB9XG5cbn1cbiJdfQ==