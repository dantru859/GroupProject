import { __assign, __decorate, __metadata, __param } from "tslib";
import { Component, ElementRef, ChangeDetectionStrategy, Input, ViewChild, Output, EventEmitter, Inject } from '@angular/core';
import { DOCUMENT } from '@angular/common';
import { LEFT_ARROW, DOWN_ARROW, UP_ARROW, RIGHT_ARROW } from '@angular/cdk/keycodes';
import { flatMap, map, takeUntil, startWith } from 'rxjs/operators';
import { merge, fromEvent } from 'rxjs';
import { getHexFromHsv } from '../../util';
import { trapEvent, uniqueId } from '../../../util/util';
var NglColorpickerRange = /** @class */ (function () {
    function NglColorpickerRange(document) {
        this.document = document;
        this.hsvChange = new EventEmitter();
        this.uid = uniqueId('colorpicker-range');
        this._hsv = { hue: 0, saturation: 0, value: 0 };
    }
    Object.defineProperty(NglColorpickerRange.prototype, "hsv", {
        get: function () {
            return this._hsv;
        },
        set: function (hsv) {
            if (hsv) {
                this._hsv = hsv;
            }
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NglColorpickerRange.prototype, "hex", {
        get: function () {
            return getHexFromHsv(this.hsv);
        },
        enumerable: true,
        configurable: true
    });
    NglColorpickerRange.prototype.ngAfterViewInit = function () {
        var _this = this;
        this.dragSubscription = this.setupDrag().subscribe(function (mm) { return _this.emitChange(mm); });
    };
    NglColorpickerRange.prototype.hueSliderChange = function (value) {
        this.emitChange({ hue: value });
    };
    NglColorpickerRange.prototype.rangeIndicatorKeyboard = function (evt) {
        var saturation = this.hsv.saturation;
        var value = this.hsv.value;
        switch (evt.keyCode) {
            case LEFT_ARROW:
                saturation = this.limit(saturation - 1);
                break;
            case RIGHT_ARROW:
                saturation = this.limit(saturation + 1);
                break;
            case UP_ARROW:
                value = this.limit(value + 1);
                break;
            case DOWN_ARROW:
                value = this.limit(value - 1);
                break;
            default:
                return;
        }
        trapEvent(evt);
        this.emitChange({ saturation: saturation, value: value });
    };
    NglColorpickerRange.prototype.indicatorStyle = function () {
        return {
            'bottom.%': this.hsv.value,
            'left.%': this.hsv.saturation,
            'background': this.hex,
        };
    };
    NglColorpickerRange.prototype.ngOnDestroy = function () {
        if (this.dragSubscription) {
            this.dragSubscription.unsubscribe();
            this.dragSubscription = null;
        }
    };
    NglColorpickerRange.prototype.emitChange = function (hsv) {
        this.hsvChange.emit(__assign(__assign({}, this.hsv), hsv));
    };
    NglColorpickerRange.prototype.limit = function (value) {
        return Math.min(Math.max(value, 0), 100);
    };
    NglColorpickerRange.prototype.setupDrag = function () {
        var _this = this;
        var dragTarget = this.rangeIndicatorContainer.nativeElement;
        var pressEnd = merge(fromEvent(this.document, 'mouseup'), fromEvent(this.document, 'touchend'));
        var pressMove = merge(fromEvent(this.document, 'mousemove'), fromEvent(this.document, 'touchmove'));
        var pressStart = merge(fromEvent(dragTarget, 'mousedown'), fromEvent(dragTarget, 'touchstart'));
        return pressStart.pipe(flatMap(function (md) {
            _this.rangeIndicator.nativeElement.focus();
            var rect = dragTarget.getBoundingClientRect();
            return pressMove.pipe(startWith(md), map(function (mm) {
                mm.preventDefault();
                var saturation = Math.round((mm.clientX - rect.left) / rect.width * 100);
                var value = Math.round((rect.bottom - mm.clientY) / rect.height * 100);
                return { saturation: _this.limit(saturation), value: _this.limit(value) };
            }), takeUntil(pressEnd));
        }));
    };
    NglColorpickerRange.ctorParameters = function () { return [
        { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] }
    ]; };
    __decorate([
        Input(),
        __metadata("design:type", Object),
        __metadata("design:paramtypes", [Object])
    ], NglColorpickerRange.prototype, "hsv", null);
    __decorate([
        Output(),
        __metadata("design:type", Object)
    ], NglColorpickerRange.prototype, "hsvChange", void 0);
    __decorate([
        ViewChild('rangeIndicator'),
        __metadata("design:type", ElementRef)
    ], NglColorpickerRange.prototype, "rangeIndicator", void 0);
    __decorate([
        ViewChild('rangeIndicatorContainer'),
        __metadata("design:type", ElementRef)
    ], NglColorpickerRange.prototype, "rangeIndicatorContainer", void 0);
    NglColorpickerRange = __decorate([
        Component({
            selector: 'ngl-colorpicker-range',
            template: "\n<p class=\"slds-assistive-text\" [attr.id]=\"uid + '-instructions'\">Use arrow keys to select a saturation and brightness, on an x and y axis.</p>\n<div class=\"slds-color-picker__custom-range\" #rangeIndicatorContainer [style.background]=\"'hsl(' + hsv.hue + ', 100%, 50%)'\"><a class=\"slds-color-picker__range-indicator\" #rangeIndicator href=\"javascript:void(0);\" aria-live=\"assertive\" aria-atomic=\"true\" [attr.aria-describedby]=\"uid + '-instructions'\" [ngStyle]=\"indicatorStyle()\" (keydown)=\"rangeIndicatorKeyboard($event)\"><span class=\"slds-assistive-text\">Saturation: {{hsv.saturation}}%. Brightness: {{hsv.value}}%.</span></a></div>\n<div class=\"slds-color-picker__hue-and-preview\">\n  <label class=\"slds-assistive-text\" [attr.for]=\"uid + '-hue'\">Select Hue</label>\n  <input class=\"slds-color-picker__hue-slider\" #hueSlider type=\"range\" min=\"0\" max=\"360\" [id]=\"uid + '-hue'\" [value]=\"hsv.hue\" (input)=\"hueSliderChange($event.target.value)\"><span nglColorpickerSwatch [color]=\"hex\"></span>\n</div>",
            changeDetection: ChangeDetectionStrategy.OnPush
        }),
        __param(0, Inject(DOCUMENT)),
        __metadata("design:paramtypes", [Object])
    ], NglColorpickerRange);
    return NglColorpickerRange;
}());
export { NglColorpickerRange };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29sb3JwaWNrZXItcmFuZ2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZy1saWdodG5pbmcvIiwic291cmNlcyI6WyJsaWIvY29sb3JwaWNrZXIvY3VzdG9tL3JhbmdlL2NvbG9ycGlja2VyLXJhbmdlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSx1QkFBdUIsRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQTRCLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN6SixPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDM0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ3RGLE9BQU8sRUFBRSxPQUFPLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNwRSxPQUFPLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBZ0IsTUFBTSxNQUFNLENBQUM7QUFDdEQsT0FBTyxFQUFFLGFBQWEsRUFBUSxNQUFNLFlBQVksQ0FBQztBQUNqRCxPQUFPLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBT3pEO0lBMEJFLDZCQUFzQyxRQUFhO1FBQWIsYUFBUSxHQUFSLFFBQVEsQ0FBSztRQWZ6QyxjQUFTLEdBQUcsSUFBSSxZQUFZLEVBQVEsQ0FBQztRQUsvQyxRQUFHLEdBQUcsUUFBUSxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFNNUIsU0FBSSxHQUFTLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxVQUFVLEVBQUUsQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsQ0FBQztJQUlGLENBQUM7SUF4Qi9DLHNCQUFJLG9DQUFHO2FBS2hCO1lBQ0UsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBQ25CLENBQUM7YUFQUSxVQUFRLEdBQVM7WUFDeEIsSUFBSSxHQUFHLEVBQUU7Z0JBQ1AsSUFBSSxDQUFDLElBQUksR0FBRyxHQUFHLENBQUM7YUFDakI7UUFDSCxDQUFDOzs7T0FBQTtJQVlELHNCQUFJLG9DQUFHO2FBQVA7WUFDRSxPQUFPLGFBQWEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDakMsQ0FBQzs7O09BQUE7SUFRRCw2Q0FBZSxHQUFmO1FBQUEsaUJBRUM7UUFEQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDLFNBQVMsQ0FBQyxVQUFDLEVBQU8sSUFBSyxPQUFBLEtBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLEVBQW5CLENBQW1CLENBQUMsQ0FBQztJQUN2RixDQUFDO0lBRUQsNkNBQWUsR0FBZixVQUFnQixLQUFhO1FBQzNCLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztJQUNsQyxDQUFDO0lBRUQsb0RBQXNCLEdBQXRCLFVBQXVCLEdBQWtCO1FBQ3ZDLElBQUksVUFBVSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDO1FBQ3JDLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDO1FBRTNCLFFBQVEsR0FBRyxDQUFDLE9BQU8sRUFBRTtZQUNuQixLQUFLLFVBQVU7Z0JBQ2IsVUFBVSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUN4QyxNQUFNO1lBQ1IsS0FBSyxXQUFXO2dCQUNkLFVBQVUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDeEMsTUFBTTtZQUNSLEtBQUssUUFBUTtnQkFDWCxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQzlCLE1BQU07WUFDUixLQUFLLFVBQVU7Z0JBQ2IsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUM5QixNQUFNO1lBQ1I7Z0JBQ0UsT0FBTztTQUNWO1FBRUQsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2YsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFLFVBQVUsWUFBQSxFQUFFLEtBQUssT0FBQSxFQUFFLENBQUMsQ0FBQztJQUN6QyxDQUFDO0lBRUQsNENBQWMsR0FBZDtRQUNFLE9BQU87WUFDTCxVQUFVLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLO1lBQzFCLFFBQVEsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVU7WUFDN0IsWUFBWSxFQUFFLElBQUksQ0FBQyxHQUFHO1NBQ3ZCLENBQUM7SUFDSixDQUFDO0lBRUQseUNBQVcsR0FBWDtRQUNFLElBQUksSUFBSSxDQUFDLGdCQUFnQixFQUFFO1lBQ3pCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUNwQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDO1NBQzlCO0lBQ0gsQ0FBQztJQUVPLHdDQUFVLEdBQWxCLFVBQW1CLEdBQWtCO1FBQ25DLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSx1QkFBTSxJQUFJLENBQUMsR0FBRyxHQUFLLEdBQUcsRUFBRyxDQUFDO0lBQy9DLENBQUM7SUFFTyxtQ0FBSyxHQUFiLFVBQWMsS0FBSztRQUNqQixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDM0MsQ0FBQztJQUVPLHVDQUFTLEdBQWpCO1FBQUEsaUJBa0NDO1FBakNDLElBQU0sVUFBVSxHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxhQUFhLENBQUM7UUFFOUQsSUFBTSxRQUFRLEdBQUcsS0FBSyxDQUNwQixTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxTQUFTLENBQUMsRUFDbkMsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsVUFBVSxDQUFDLENBQ3JDLENBQUM7UUFFRixJQUFNLFNBQVMsR0FBRyxLQUFLLENBQ3JCLFNBQVMsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLFdBQVcsQ0FBQyxFQUNyQyxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxXQUFXLENBQUMsQ0FDdEMsQ0FBQztRQUVGLElBQU0sVUFBVSxHQUFHLEtBQUssQ0FDdEIsU0FBUyxDQUFDLFVBQVUsRUFBRSxXQUFXLENBQUMsRUFDbEMsU0FBUyxDQUFDLFVBQVUsRUFBRSxZQUFZLENBQUMsQ0FDcEMsQ0FBQztRQUVGLE9BQU8sVUFBVSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBQyxFQUFFO1lBQ2hDLEtBQUksQ0FBQyxjQUFjLENBQUMsYUFBYSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQzFDLElBQU0sSUFBSSxHQUFHLFVBQVUsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1lBRWpELE9BQU8sU0FBUyxDQUFDLElBQUksQ0FDbEIsU0FBUyxDQUFDLEVBQUUsQ0FBQyxFQUNiLEdBQUcsQ0FBQyxVQUFDLEVBQU87Z0JBQ1YsRUFBRSxDQUFDLGNBQWMsRUFBRSxDQUFDO2dCQUVwQixJQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssR0FBRyxHQUFHLENBQUMsQ0FBQztnQkFDM0UsSUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLEdBQUcsR0FBRyxDQUFDLENBQUM7Z0JBQ3pFLE9BQU8sRUFBRSxVQUFVLEVBQUUsS0FBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsRUFBRSxLQUFLLEVBQUUsS0FBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO1lBQzFFLENBQUMsQ0FBQyxFQUNGLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FDcEIsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDTixDQUFDOztnREE1RlksTUFBTSxTQUFDLFFBQVE7O0lBeEJuQjtRQUFSLEtBQUssRUFBRTs7O2tEQUlQO0lBS1M7UUFBVCxNQUFNLEVBQUU7OzBEQUFzQztJQUVsQjtRQUE1QixTQUFTLENBQUMsZ0JBQWdCLENBQUM7a0NBQWlCLFVBQVU7K0RBQUM7SUFDbEI7UUFBckMsU0FBUyxDQUFDLHlCQUF5QixDQUFDO2tDQUEwQixVQUFVO3dFQUFDO0lBZC9ELG1CQUFtQjtRQUwvQixTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUsdUJBQXVCO1lBQ2pDLCtoQ0FBdUM7WUFDdkMsZUFBZSxFQUFFLHVCQUF1QixDQUFDLE1BQU07U0FDaEQsQ0FBQztRQTJCYSxXQUFBLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQTs7T0ExQmxCLG1CQUFtQixDQXVIL0I7SUFBRCwwQkFBQztDQUFBLEFBdkhELElBdUhDO1NBdkhZLG1CQUFtQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgRWxlbWVudFJlZiwgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksIElucHV0LCBWaWV3Q2hpbGQsIE91dHB1dCwgRXZlbnRFbWl0dGVyLCBBZnRlclZpZXdJbml0LCBPbkRlc3Ryb3ksIEluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRE9DVU1FTlQgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgTEVGVF9BUlJPVywgRE9XTl9BUlJPVywgVVBfQVJST1csIFJJR0hUX0FSUk9XIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL2tleWNvZGVzJztcbmltcG9ydCB7IGZsYXRNYXAsIG1hcCwgdGFrZVVudGlsLCBzdGFydFdpdGggfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBtZXJnZSwgZnJvbUV2ZW50LCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGdldEhleEZyb21Ic3YsIElIU1YgfSBmcm9tICcuLi8uLi91dGlsJztcbmltcG9ydCB7IHRyYXBFdmVudCwgdW5pcXVlSWQgfSBmcm9tICcuLi8uLi8uLi91dGlsL3V0aWwnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICduZ2wtY29sb3JwaWNrZXItcmFuZ2UnLFxuICB0ZW1wbGF0ZVVybDogJy4vY29sb3JwaWNrZXItcmFuZ2UuaHRtbCcsXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxufSlcbmV4cG9ydCBjbGFzcyBOZ2xDb2xvcnBpY2tlclJhbmdlIGltcGxlbWVudHMgQWZ0ZXJWaWV3SW5pdCwgT25EZXN0cm95IHtcblxuICBASW5wdXQoKSBzZXQgaHN2KGhzdjogSUhTVikge1xuICAgIGlmIChoc3YpIHtcbiAgICAgIHRoaXMuX2hzdiA9IGhzdjtcbiAgICB9XG4gIH1cbiAgZ2V0IGhzdigpIHtcbiAgICByZXR1cm4gdGhpcy5faHN2O1xuICB9XG5cbiAgQE91dHB1dCgpIGhzdkNoYW5nZSA9IG5ldyBFdmVudEVtaXR0ZXI8SUhTVj4oKTtcblxuICBAVmlld0NoaWxkKCdyYW5nZUluZGljYXRvcicpIHJhbmdlSW5kaWNhdG9yOiBFbGVtZW50UmVmO1xuICBAVmlld0NoaWxkKCdyYW5nZUluZGljYXRvckNvbnRhaW5lcicpIHJhbmdlSW5kaWNhdG9yQ29udGFpbmVyOiBFbGVtZW50UmVmO1xuXG4gIHVpZCA9IHVuaXF1ZUlkKCdjb2xvcnBpY2tlci1yYW5nZScpO1xuXG4gIGdldCBoZXgoKSB7XG4gICAgcmV0dXJuIGdldEhleEZyb21Ic3YodGhpcy5oc3YpO1xuICB9XG5cbiAgcHJpdmF0ZSBfaHN2OiBJSFNWID0geyBodWU6IDAsIHNhdHVyYXRpb246IDAsIHZhbHVlOiAwIH07XG5cbiAgcHJpdmF0ZSBkcmFnU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG5cbiAgY29uc3RydWN0b3IoQEluamVjdChET0NVTUVOVCkgcHJpdmF0ZSBkb2N1bWVudDogYW55KSB7IH1cblxuICBuZ0FmdGVyVmlld0luaXQoKSB7XG4gICAgdGhpcy5kcmFnU3Vic2NyaXB0aW9uID0gdGhpcy5zZXR1cERyYWcoKS5zdWJzY3JpYmUoKG1tOiBhbnkpID0+IHRoaXMuZW1pdENoYW5nZShtbSkpO1xuICB9XG5cbiAgaHVlU2xpZGVyQ2hhbmdlKHZhbHVlOiBudW1iZXIpIHtcbiAgICB0aGlzLmVtaXRDaGFuZ2UoeyBodWU6IHZhbHVlIH0pO1xuICB9XG5cbiAgcmFuZ2VJbmRpY2F0b3JLZXlib2FyZChldnQ6IEtleWJvYXJkRXZlbnQpIHtcbiAgICBsZXQgc2F0dXJhdGlvbiA9IHRoaXMuaHN2LnNhdHVyYXRpb247XG4gICAgbGV0IHZhbHVlID0gdGhpcy5oc3YudmFsdWU7XG5cbiAgICBzd2l0Y2ggKGV2dC5rZXlDb2RlKSB7XG4gICAgICBjYXNlIExFRlRfQVJST1c6XG4gICAgICAgIHNhdHVyYXRpb24gPSB0aGlzLmxpbWl0KHNhdHVyYXRpb24gLSAxKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFJJR0hUX0FSUk9XOlxuICAgICAgICBzYXR1cmF0aW9uID0gdGhpcy5saW1pdChzYXR1cmF0aW9uICsgMSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBVUF9BUlJPVzpcbiAgICAgICAgdmFsdWUgPSB0aGlzLmxpbWl0KHZhbHVlICsgMSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBET1dOX0FSUk9XOlxuICAgICAgICB2YWx1ZSA9IHRoaXMubGltaXQodmFsdWUgLSAxKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdHJhcEV2ZW50KGV2dCk7XG4gICAgdGhpcy5lbWl0Q2hhbmdlKHsgc2F0dXJhdGlvbiwgdmFsdWUgfSk7XG4gIH1cblxuICBpbmRpY2F0b3JTdHlsZSgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgJ2JvdHRvbS4lJzogdGhpcy5oc3YudmFsdWUsXG4gICAgICAnbGVmdC4lJzogdGhpcy5oc3Yuc2F0dXJhdGlvbixcbiAgICAgICdiYWNrZ3JvdW5kJzogdGhpcy5oZXgsXG4gICAgfTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIGlmICh0aGlzLmRyYWdTdWJzY3JpcHRpb24pIHtcbiAgICAgIHRoaXMuZHJhZ1N1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgICAgdGhpcy5kcmFnU3Vic2NyaXB0aW9uID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGVtaXRDaGFuZ2UoaHN2OiBQYXJ0aWFsPElIU1Y+KSB7XG4gICAgdGhpcy5oc3ZDaGFuZ2UuZW1pdCh7IC4uLnRoaXMuaHN2LCAuLi5oc3YgfSk7XG4gIH1cblxuICBwcml2YXRlIGxpbWl0KHZhbHVlKTogbnVtYmVyIHtcbiAgICByZXR1cm4gTWF0aC5taW4oTWF0aC5tYXgodmFsdWUsIDApLCAxMDApO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXR1cERyYWcoKSB7XG4gICAgY29uc3QgZHJhZ1RhcmdldCA9IHRoaXMucmFuZ2VJbmRpY2F0b3JDb250YWluZXIubmF0aXZlRWxlbWVudDtcblxuICAgIGNvbnN0IHByZXNzRW5kID0gbWVyZ2UoXG4gICAgICBmcm9tRXZlbnQodGhpcy5kb2N1bWVudCwgJ21vdXNldXAnKSxcbiAgICAgIGZyb21FdmVudCh0aGlzLmRvY3VtZW50LCAndG91Y2hlbmQnKVxuICAgICk7XG5cbiAgICBjb25zdCBwcmVzc01vdmUgPSBtZXJnZShcbiAgICAgIGZyb21FdmVudCh0aGlzLmRvY3VtZW50LCAnbW91c2Vtb3ZlJyksXG4gICAgICBmcm9tRXZlbnQodGhpcy5kb2N1bWVudCwgJ3RvdWNobW92ZScpXG4gICAgKTtcblxuICAgIGNvbnN0IHByZXNzU3RhcnQgPSBtZXJnZShcbiAgICAgIGZyb21FdmVudChkcmFnVGFyZ2V0LCAnbW91c2Vkb3duJyksXG4gICAgICBmcm9tRXZlbnQoZHJhZ1RhcmdldCwgJ3RvdWNoc3RhcnQnKVxuICAgICk7XG5cbiAgICByZXR1cm4gcHJlc3NTdGFydC5waXBlKGZsYXRNYXAoKG1kKSA9PiB7XG4gICAgICB0aGlzLnJhbmdlSW5kaWNhdG9yLm5hdGl2ZUVsZW1lbnQuZm9jdXMoKTtcbiAgICAgIGNvbnN0IHJlY3QgPSBkcmFnVGFyZ2V0LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuXG4gICAgIHJldHVybiBwcmVzc01vdmUucGlwZShcbiAgICAgICAgc3RhcnRXaXRoKG1kKSxcbiAgICAgICAgbWFwKChtbTogYW55KSA9PiB7XG4gICAgICAgICAgbW0ucHJldmVudERlZmF1bHQoKTtcblxuICAgICAgICAgIGNvbnN0IHNhdHVyYXRpb24gPSBNYXRoLnJvdW5kKChtbS5jbGllbnRYIC0gcmVjdC5sZWZ0KSAvIHJlY3Qud2lkdGggKiAxMDApO1xuICAgICAgICAgIGNvbnN0IHZhbHVlID0gTWF0aC5yb3VuZCgocmVjdC5ib3R0b20gLSBtbS5jbGllbnRZKSAvIHJlY3QuaGVpZ2h0ICogMTAwKTtcbiAgICAgICAgICByZXR1cm4geyBzYXR1cmF0aW9uOiB0aGlzLmxpbWl0KHNhdHVyYXRpb24pLCB2YWx1ZTogdGhpcy5saW1pdCh2YWx1ZSkgfTtcbiAgICAgICAgfSksXG4gICAgICAgIHRha2VVbnRpbChwcmVzc0VuZCksXG4gICAgICApO1xuICAgIH0pKTtcbiAgfVxufVxuIl19