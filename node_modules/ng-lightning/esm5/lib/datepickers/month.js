import { __decorate, __metadata } from "tslib";
import { Component, Input, Output, EventEmitter, ChangeDetectionStrategy, ViewChildren, QueryList, NgZone, OnChanges, SimpleChanges } from '@angular/core';
import { take } from 'rxjs/operators';
import { split, getToday, isEqualDate, numberOfDaysInMonth, isDisabled } from './util';
import { NglDay } from './day';
var NglDatepickerMonth = /** @class */ (function () {
    function NglDatepickerMonth(ngZone) {
        this.ngZone = ngZone;
        this.dateDisabled = null;
        this.selectDate = new EventEmitter();
    }
    NglDatepickerMonth.prototype.indexTrackBy = function (index) {
        return index;
    };
    NglDatepickerMonth.prototype.dateTrackBy = function (index, _a) {
        var year = _a.year, month = _a.month, day = _a.day;
        return day + "-" + month + "-" + year;
    };
    NglDatepickerMonth.prototype.onSelect = function (date) {
        if (date.disabled)
            return;
        this.selectDate.emit(date);
    };
    NglDatepickerMonth.prototype.ngOnChanges = function (changes) {
        if (changes.year || changes.month || changes.firstDayOfWeek) {
            this.renderView();
            return;
        }
        if (changes.day) {
            this.updateActive();
        }
        if (changes.selected) {
            this.updateSelected();
        }
        if (changes.minDate || changes.maxDate || changes.dateDisabled) {
            this.updateDisabled();
        }
    };
    NglDatepickerMonth.prototype.focusActiveDay = function () {
        var _this = this;
        this.ngZone.runOutsideAngular(function () {
            _this.ngZone.onStable.asObservable().pipe(take(1)).subscribe(function () {
                var active = _this.days.find(function (d) { return d.isActive; });
                if (active) {
                    active.focus();
                }
            });
        });
    };
    NglDatepickerMonth.prototype.renderView = function () {
        var days = this.daysInMonth(this.year, this.month);
        Array.prototype.unshift.apply(days, this.daysInPreviousMonth(this.year, this.month));
        var nextMonth = this.daysInNextMonth(this.year, this.month + 1, days.length);
        if (nextMonth) {
            Array.prototype.push.apply(days, nextMonth);
        }
        this.weeks = split(days);
    };
    NglDatepickerMonth.prototype.daysInMonth = function (year, month) {
        var last = numberOfDaysInMonth(year, month);
        return this.getDayObjects(year, month, 1, last);
    };
    NglDatepickerMonth.prototype.daysInPreviousMonth = function (year, month) {
        var firstIndex = (new Date(year, month, 1)).getDay();
        var last = new Date(year, month, 0).getDate();
        var numDays = (7 + firstIndex - this.firstDayOfWeek) % 7;
        return this.getDayObjects(year, month - 1, last - numDays + 1, last, false);
    };
    NglDatepickerMonth.prototype.daysInNextMonth = function (year, month, numOfDays) {
        if (numOfDays % 7 === 0) {
            return;
        }
        return this.getDayObjects(year, month, 1, 7 - (numOfDays % 7), false);
    };
    NglDatepickerMonth.prototype.getDayObjects = function (year, month, from, to, isCurrentMonth) {
        if (isCurrentMonth === void 0) { isCurrentMonth = true; }
        var today = getToday();
        var days = [];
        for (var day = from; day <= to; day++) {
            var d = {
                year: year,
                month: month,
                day: day,
                isCurrentMonth: isCurrentMonth,
                today: isEqualDate(today, { year: year, month: month, day: day }),
            };
            d.active = this.isActive(d);
            d.selected = this.isSelected(d);
            d.disabled = this.isDisabled(d);
            days.push(d);
        }
        return days;
    };
    NglDatepickerMonth.prototype.updateActive = function () {
        var _this = this;
        this.weeks.forEach(function (days) {
            days.forEach(function (day) {
                day.active = _this.isActive(day);
            });
        });
    };
    NglDatepickerMonth.prototype.isActive = function (day) {
        return day.isCurrentMonth && day.day === this.day;
    };
    NglDatepickerMonth.prototype.updateSelected = function () {
        var _this = this;
        this.weeks.forEach(function (days) {
            days.forEach(function (day) {
                day.selected = _this.isSelected(day);
            });
        });
    };
    NglDatepickerMonth.prototype.isSelected = function (day) {
        return isEqualDate(this.selected, day);
    };
    NglDatepickerMonth.prototype.updateDisabled = function () {
        var _this = this;
        this.weeks.forEach(function (days) {
            days.forEach(function (day) {
                day.disabled = _this.isDisabled(day);
            });
        });
    };
    /** Date filter for the month */
    NglDatepickerMonth.prototype.isDisabled = function (d) {
        return !d.isCurrentMonth || isDisabled(d, this.dateDisabled, this.minDate, this.maxDate);
    };
    NglDatepickerMonth.ctorParameters = function () { return [
        { type: NgZone }
    ]; };
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], NglDatepickerMonth.prototype, "selected", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Number)
    ], NglDatepickerMonth.prototype, "year", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Number)
    ], NglDatepickerMonth.prototype, "month", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Number)
    ], NglDatepickerMonth.prototype, "day", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Number)
    ], NglDatepickerMonth.prototype, "firstDayOfWeek", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], NglDatepickerMonth.prototype, "minDate", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], NglDatepickerMonth.prototype, "maxDate", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Function)
    ], NglDatepickerMonth.prototype, "dateDisabled", void 0);
    __decorate([
        Output(),
        __metadata("design:type", Object)
    ], NglDatepickerMonth.prototype, "selectDate", void 0);
    __decorate([
        ViewChildren(NglDay),
        __metadata("design:type", QueryList)
    ], NglDatepickerMonth.prototype, "days", void 0);
    NglDatepickerMonth = __decorate([
        Component({
            // tslint:disable-next-line:component-selector
            selector: '[nglDatepickerMonth]',
            template: "\n<tr *ngFor=\"let week of weeks; trackBy:indexTrackBy\">\n  <td *ngFor=\"let date of week; trackBy:dateTrackBy\" [class.slds-is-today]=\"date.today\" [isActive]=\"date.active\" [nglDay]=\"date\" [nglDaySelected]=\"date.selected\" [nglDayDisabled]=\"date.disabled\" (click)=\"onSelect(date)\" role=\"gridcell\"><span class=\"slds-day\">{{ date.day }}</span></td>\n</tr>",
            changeDetection: ChangeDetectionStrategy.OnPush
        }),
        __metadata("design:paramtypes", [NgZone])
    ], NglDatepickerMonth);
    return NglDatepickerMonth;
}());
export { NglDatepickerMonth };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9udGguanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZy1saWdodG5pbmcvIiwic291cmNlcyI6WyJsaWIvZGF0ZXBpY2tlcnMvbW9udGgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsdUJBQXVCLEVBQUUsWUFBWSxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLGFBQWEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzSixPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdEMsT0FBTyxFQUFtQixLQUFLLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxtQkFBbUIsRUFBRSxVQUFVLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDeEcsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLE9BQU8sQ0FBQztBQWUvQjtJQXdCRSw0QkFBb0IsTUFBYztRQUFkLFdBQU0sR0FBTixNQUFNLENBQVE7UUFSaEIsaUJBQVksR0FBbUMsSUFBSSxDQUFDO1FBRTVELGVBQVUsR0FBRyxJQUFJLFlBQVksRUFBbUIsQ0FBQztJQU10QixDQUFDO0lBRXRDLHlDQUFZLEdBQVosVUFBYSxLQUFhO1FBQ3hCLE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUVELHdDQUFXLEdBQVgsVUFBWSxLQUFhLEVBQUUsRUFBbUM7WUFBbEMsY0FBSSxFQUFFLGdCQUFLLEVBQUUsWUFBRztRQUMxQyxPQUFVLEdBQUcsU0FBSSxLQUFLLFNBQUksSUFBTSxDQUFDO0lBQ25DLENBQUM7SUFFRCxxQ0FBUSxHQUFSLFVBQVMsSUFBcUI7UUFDNUIsSUFBSSxJQUFJLENBQUMsUUFBUTtZQUFFLE9BQU87UUFFMUIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDN0IsQ0FBQztJQUVELHdDQUFXLEdBQVgsVUFBWSxPQUFzQjtRQUNoQyxJQUFJLE9BQU8s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Q0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELGdDQUFnQztJQUN4Qix1Q0FBVSxHQUFsQixVQUFtQixDQUFjO1FBQy9CLE9BQU8sQ0FBQyxDQUFDLENBQUMsY0FBYyxJQUFJLFVBQVUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUMzRixDQUFDOztnQkFuSTJCLE1BQU07O0lBdEJ6QjtRQUFSLEtBQUssRUFBRTs7d0RBQW9DO0lBRW5DO1FBQVIsS0FBSyxFQUFFOztvREFBdUI7SUFFdEI7UUFBUixLQUFLLEVBQUU7O3FEQUF3QjtJQUV2QjtRQUFSLEtBQUssRUFBRTs7bURBQXNCO0lBRXJCO1FBQVIsS0FBSyxFQUFFOzs4REFBaUM7SUFFaEM7UUFBUixLQUFLLEVBQUU7O3VEQUFtQztJQUVsQztRQUFSLEtBQUssRUFBRTs7dURBQW1DO0lBRWxDO1FBQVIsS0FBSyxFQUFFOzs0REFBOEQ7SUFFNUQ7UUFBVCxNQUFNLEVBQUU7OzBEQUFrRDtJQUVyQztRQUFyQixZQUFZLENBQUMsTUFBTSxDQUFDO2tDQUFPLFNBQVM7b0RBQVM7SUFwQm5DLGtCQUFrQjtRQU45QixTQUFTLENBQUM7WUFDVCw4Q0FBOEM7WUFDOUMsUUFBUSxFQUFFLHNCQUFzQjtZQUNoQyw2WEFBMkI7WUFDM0IsZUFBZSxFQUFFLHVCQUF1QixDQUFDLE1BQU07U0FDaEQsQ0FBQzt5Q0F5QjRCLE1BQU07T0F4QnZCLGtCQUFrQixDQTRKOUI7SUFBRCx5QkFBQztDQUFBLEFBNUpELElBNEpDO1NBNUpZLGtCQUFrQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgSW5wdXQsIE91dHB1dCwgRXZlbnRFbWl0dGVyLCBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSwgVmlld0NoaWxkcmVuLCBRdWVyeUxpc3QsIE5nWm9uZSwgT25DaGFuZ2VzLCBTaW1wbGVDaGFuZ2VzIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyB0YWtlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgTmdsSW50ZXJuYWxEYXRlLCBzcGxpdCwgZ2V0VG9kYXksIGlzRXF1YWxEYXRlLCBudW1iZXJPZkRheXNJbk1vbnRoLCBpc0Rpc2FibGVkIH0gZnJvbSAnLi91dGlsJztcbmltcG9ydCB7IE5nbERheSB9IGZyb20gJy4vZGF5JztcblxuaW50ZXJmYWNlIElOZ2xEYXlDZWxsIGV4dGVuZHMgTmdsSW50ZXJuYWxEYXRlIHtcbiAgdG9kYXk6IGJvb2xlYW47XG4gIGlzQ3VycmVudE1vbnRoOiBib29sZWFuO1xuICBzZWxlY3RlZD86IGJvb2xlYW47XG4gIGFjdGl2ZT86IGJvb2xlYW47XG59XG5cbkBDb21wb25lbnQoe1xuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6Y29tcG9uZW50LXNlbGVjdG9yXG4gIHNlbGVjdG9yOiAnW25nbERhdGVwaWNrZXJNb250aF0nLFxuICB0ZW1wbGF0ZVVybDogJy4vbW9udGguaHRtbCcsXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxufSlcbmV4cG9ydCBjbGFzcyBOZ2xEYXRlcGlja2VyTW9udGggaW1wbGVtZW50cyBPbkNoYW5nZXMge1xuXG4gIEBJbnB1dCgpIHJlYWRvbmx5IHNlbGVjdGVkOiBOZ2xJbnRlcm5hbERhdGU7XG5cbiAgQElucHV0KCkgcmVhZG9ubHkgeWVhcjogbnVtYmVyO1xuXG4gIEBJbnB1dCgpIHJlYWRvbmx5IG1vbnRoOiBudW1iZXI7XG5cbiAgQElucHV0KCkgcmVhZG9ubHkgZGF5OiBudW1iZXI7XG5cbiAgQElucHV0KCkgcmVhZG9ubHkgZmlyc3REYXlPZldlZWs6IG51bWJlcjtcblxuICBASW5wdXQoKSByZWFkb25seSBtaW5EYXRlOiBOZ2xJbnRlcm5hbERhdGU7XG5cbiAgQElucHV0KCkgcmVhZG9ubHkgbWF4RGF0ZTogTmdsSW50ZXJuYWxEYXRlO1xuXG4gIEBJbnB1dCgpIHJlYWRvbmx5IGRhdGVEaXNhYmxlZDogKGRhdGU6IERhdGUpID0+IGJvb2xlYW4gfCBudWxsID0gbnVsbDtcblxuICBAT3V0cHV0KCkgc2VsZWN0RGF0ZSA9IG5ldyBFdmVudEVtaXR0ZXI8TmdsSW50ZXJuYWxEYXRlPigpO1xuXG4gIEBWaWV3Q2hpbGRyZW4oTmdsRGF5KSBkYXlzOiBRdWVyeUxpc3Q8TmdsRGF5PjtcblxuICB3ZWVrczogSU5nbERheUNlbGxbXVtdO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgbmdab25lOiBOZ1pvbmUpIHt9XG5cbiAgaW5kZXhUcmFja0J5KGluZGV4OiBudW1iZXIpIHtcbiAgICByZXR1cm4gaW5kZXg7XG4gIH1cblxuICBkYXRlVHJhY2tCeShpbmRleDogbnVtYmVyLCB7eWVhciwgbW9udGgsIGRheX06IE5nbEludGVybmFsRGF0ZSkge1xuICAgIHJldHVybiBgJHtkYXl9LSR7bW9udGh9LSR7eWVhcn1gO1xuICB9XG5cbiAgb25TZWxlY3QoZGF0ZTogTmdsSW50ZXJuYWxEYXRlKSB7XG4gICAgaWYgKGRhdGUuZGlzYWJsZWQpIHJldHVybjtcblxuICAgIHRoaXMuc2VsZWN0RGF0ZS5lbWl0KGRhdGUpO1xuICB9XG5cbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xuICAgIGlmIChjaGFuZ2VzLnllYXIgfHwgY2hhbmdlcy5tb250aCB8fCBjaGFuZ2VzLmZpcnN0RGF5T2ZXZWVrKSB7XG4gICAgICB0aGlzLnJlbmRlclZpZXcoKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoY2hhbmdlcy5kYXkpIHtcbiAgICAgIHRoaXMudXBkYXRlQWN0aXZlKCk7XG4gICAgfVxuXG4gICAgaWYgKGNoYW5nZXMuc2VsZWN0ZWQpIHtcbiAgICAgIHRoaXMudXBkYXRlU2VsZWN0ZWQoKTtcbiAgICB9XG5cbiAgICBpZiAoY2hhbmdlcy5taW5EYXRlIHx8IGNoYW5nZXMubWF4RGF0ZSB8fCBjaGFuZ2VzLmRhdGVEaXNhYmxlZCkge1xuICAgICAgdGhpcy51cGRhdGVEaXNhYmxlZCgpO1xuICAgIH1cbiAgfVxuXG4gIGZvY3VzQWN0aXZlRGF5KCkge1xuICAgIHRoaXMubmdab25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcbiAgICAgIHRoaXMubmdab25lLm9uU3RhYmxlLmFzT2JzZXJ2YWJsZSgpLnBpcGUodGFrZSgxKSkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgY29uc3QgYWN0aXZlID0gdGhpcy5kYXlzLmZpbmQoKGQpID0+IGQuaXNBY3RpdmUpO1xuICAgICAgICBpZiAoYWN0aXZlKSB7XG4gICAgICAgICAgYWN0aXZlLmZvY3VzKCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSByZW5kZXJWaWV3KCkge1xuICAgIGNvbnN0IGRheXMgPSB0aGlzLmRheXNJbk1vbnRoKHRoaXMueWVhciwgdGhpcy5tb250aCk7XG5cbiAgICBBcnJheS5wcm90b3R5cGUudW5zaGlmdC5hcHBseShkYXlzLCB0aGlzLmRheXNJblByZXZpb3VzTW9udGgodGhpcy55ZWFyLCB0aGlzLm1vbnRoKSk7XG4gICAgY29uc3QgbmV4dE1vbnRoID0gdGhpcy5kYXlzSW5OZXh0TW9udGgodGhpcy55ZWFyLCB0aGlzLm1vbnRoICsgMSwgZGF5cy5sZW5ndGgpO1xuICAgIGlmIChuZXh0TW9udGgpIHtcbiAgICAgIEFycmF5LnByb3RvdHlwZS5wdXNoLmFwcGx5KGRheXMsIG5leHRNb250aCk7XG4gICAgfVxuXG4gICAgdGhpcy53ZWVrcyA9IHNwbGl0KGRheXMpO1xuICB9XG5cbiAgcHJpdmF0ZSBkYXlzSW5Nb250aCh5ZWFyOiBudW1iZXIsIG1vbnRoOiBudW1iZXIpIHtcbiAgICBjb25zdCBsYXN0ID0gbnVtYmVyT2ZEYXlzSW5Nb250aCh5ZWFyLCBtb250aCk7XG4gICAgcmV0dXJuIHRoaXMuZ2V0RGF5T2JqZWN0cyh5ZWFyLCBtb250aCwgMSwgbGFzdCk7XG4gIH1cblxuICBwcml2YXRlIGRheXNJblByZXZpb3VzTW9udGgoeWVhcjogbnVtYmVyLCBtb250aDogbnVtYmVyKSB7XG4gICAgY29uc3QgZmlyc3RJbmRleCA9IChuZXcgRGF0ZSh5ZWFyLCBtb250aCwgMSkpLmdldERheSgpO1xuICAgIGNvbnN0IGxhc3QgPSBuZXcgRGF0ZSh5ZWFyLCBtb250aCwgMCkuZ2V0RGF0ZSgpO1xuICAgIGNvbnN0IG51bURheXMgPSAoNyArIGZpcnN0SW5kZXggLSB0aGlzLmZpcnN0RGF5T2ZXZWVrKSAlIDc7XG5cbiAgICByZXR1cm4gdGhpcy5nZXREYXlPYmplY3RzKHllYXIsIG1vbnRoIC0gMSwgbGFzdCAtIG51bURheXMgKyAxLCBsYXN0LCBmYWxzZSk7XG4gIH1cblxuICBwcml2YXRlIGRheXNJbk5leHRNb250aCh5ZWFyOiBudW1iZXIsIG1vbnRoOiBudW1iZXIsIG51bU9mRGF5czogbnVtYmVyKSB7XG4gICAgaWYgKG51bU9mRGF5cyAlIDcgPT09IDApIHsgcmV0dXJuOyB9XG4gICAgcmV0dXJuIHRoaXMuZ2V0RGF5T2JqZWN0cyh5ZWFyLCBtb250aCwgMSwgNyAtIChudW1PZkRheXMgJSA3KSwgZmFsc2UpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXREYXlPYmplY3RzKHllYXI6IG51bWJlciwgbW9udGg6IG51bWJlciwgZnJvbTogbnVtYmVyLCB0bzogbnVtYmVyLCBpc0N1cnJlbnRNb250aCA9IHRydWUpIHtcbiAgICBjb25zdCB0b2RheSA9IGdldFRvZGF5KCk7XG4gICAgY29uc3QgZGF5czogSU5nbERheUNlbGxbXSA9IFtdO1xuICAgIGZvciAobGV0IGRheSA9IGZyb207IGRheSA8PSB0bzsgZGF5KyspIHtcbiAgICAgIGNvbnN0IGQ6IElOZ2xEYXlDZWxsID0ge1xuICAgICAgICB5ZWFyLFxuICAgICAgICBtb250aCxcbiAgICAgICAgZGF5LFxuICAgICAgICBpc0N1cnJlbnRNb250aCxcbiAgICAgICAgdG9kYXk6IGlzRXF1YWxEYXRlKHRvZGF5LCB7IHllYXIsIG1vbnRoLCBkYXkgfSksXG4gICAgICB9O1xuXG4gICAgICBkLmFjdGl2ZSA9IHRoaXMuaXNBY3RpdmUoZCk7XG4gICAgICBkLnNlbGVjdGVkID0gdGhpcy5pc1NlbGVjdGVkKGQpO1xuICAgICAgZC5kaXNhYmxlZCA9IHRoaXMuaXNEaXNhYmxlZChkKTtcbiAgICAgIGRheXMucHVzaChkKTtcbiAgICB9XG4gICAgcmV0dXJuIGRheXM7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZUFjdGl2ZSgpIHtcbiAgICB0aGlzLndlZWtzLmZvckVhY2goKGRheXM6IElOZ2xEYXlDZWxsW10pID0+IHtcbiAgICAgIGRheXMuZm9yRWFjaChkYXkgPT4ge1xuICAgICAgICBkYXkuYWN0aXZlID0gdGhpcy5pc0FjdGl2ZShkYXkpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGlzQWN0aXZlKGRheTogSU5nbERheUNlbGwpIHtcbiAgICByZXR1cm4gZGF5LmlzQ3VycmVudE1vbnRoICYmIGRheS5kYXkgPT09IHRoaXMuZGF5O1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVTZWxlY3RlZCgpIHtcbiAgICB0aGlzLndlZWtzLmZvckVhY2goKGRheXM6IElOZ2xEYXlDZWxsW10pID0+IHtcbiAgICAgIGRheXMuZm9yRWFjaCgoZGF5KSA9PiB7XG4gICAgICAgIGRheS5zZWxlY3RlZCA9IHRoaXMuaXNTZWxlY3RlZChkYXkpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGlzU2VsZWN0ZWQoZGF5OiBJTmdsRGF5Q2VsbCkge1xuICAgIHJldHVybiBpc0VxdWFsRGF0ZSh0aGlzLnNlbGVjdGVkLCBkYXkpO1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVEaXNhYmxlZCgpIHtcbiAgICB0aGlzLndlZWtzLmZvckVhY2goKGRheXM6IElOZ2xEYXlDZWxsW10pID0+IHtcbiAgICAgIGRheXMuZm9yRWFjaChkYXkgPT4ge1xuICAgICAgICBkYXkuZGlzYWJsZWQgPSB0aGlzLmlzRGlzYWJsZWQoZGF5KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqIERhdGUgZmlsdGVyIGZvciB0aGUgbW9udGggKi9cbiAgcHJpdmF0ZSBpc0Rpc2FibGVkKGQ6IElOZ2xEYXlDZWxsKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuICFkLmlzQ3VycmVudE1vbnRoIHx8IGlzRGlzYWJsZWQoZCwgdGhpcy5kYXRlRGlzYWJsZWQsIHRoaXMubWluRGF0ZSwgdGhpcy5tYXhEYXRlKTtcbiAgfVxufVxuIl19