import { __decorate, __metadata, __param } from "tslib";
import { Component, Input, Output, ElementRef, EventEmitter, HostListener, ContentChild, ChangeDetectionStrategy, Inject, OnChanges, SimpleChanges, AfterContentInit, OnDestroy } from '@angular/core';
import { DOCUMENT } from '@angular/common';
import { FocusTrap, FocusTrapFactory } from '@angular/cdk/a11y';
import { BlockScrollStrategy, Overlay, OverlayRef } from '@angular/cdk/overlay';
import { uniqueId } from '../util/util';
import { InputBoolean } from '../util/convert';
import { NglModalHeaderTemplate, NglModalTaglineTemplate, NglModalFooterTemplate } from './templates';
import { hasObservers } from '../util/hasObservers';
var NglModal = /** @class */ (function () {
    function NglModal(focusTrapFactory, document, overlay, element) {
        this.focusTrapFactory = focusTrapFactory;
        this.document = document;
        this.overlay = overlay;
        this.element = element;
        this.header = '';
        this.directional = false;
        this.headingId = uniqueId('modal-heading');
        this.contentId = uniqueId('modal-content');
        this.open = true;
        this.closeButtonAssistiveText = 'Close';
        this.openChange = new EventEmitter();
        this.dismissOnClickOutside = true;
        /** Element that was focused before the dialog was opened. Save this to restore upon close. */
        this.elementFocusedBeforeDialogWasOpened = null;
        this.scrollStrategy = this.overlay.scrollStrategies.block();
    }
    Object.defineProperty(NglModal.prototype, "hasHeader", {
        get: function () {
            return this.header || this.headerTpl;
        },
        enumerable: true,
        configurable: true
    });
    NglModal.prototype.close = function (evt) {
        if (evt) {
            evt.stopPropagation();
        }
        this.openChange.emit(false);
    };
    NglModal.prototype.ngOnChanges = function (changes) {
        if ('open' in changes) {
            this.handleOpen();
        }
    };
    NglModal.prototype.ngAfterContentInit = function () {
        this.handleOpen();
    };
    NglModal.prototype.clickOutside = function (evt) {
        if (!this.dismissOnClickOutside) {
            return;
        }
        var classList = evt.target.classList;
        if (classList.contains('slds-modal') || classList.contains('slds-modal__container')) {
            this.close();
        }
    };
    NglModal.prototype.ngOnDestroy = function () {
        this.handleOpen(false);
        this.scrollStrategy = null;
    };
    NglModal.prototype.modalClass = function () {
        var _a;
        return _a = {},
            _a["slds-modal_" + this.size] = !!this.size,
            _a["slds-fade-in-open"] = this.open,
            _a["slds-modal_prompt"] = !!this.prompt,
            _a;
    };
    NglModal.prototype.modalHeaderClass = function () {
        var _a;
        return _a = {},
            _a["slds-modal__header_empty"] = !this.hasHeader,
            _a["slds-theme_" + this.prompt] = !!this.prompt,
            _a;
    };
    NglModal.prototype.modalFooterClass = function () {
        var _a;
        return _a = {},
            _a["slds-modal__footer_directional"] = !!this.directional,
            _a["slds-theme_default"] = !!this.prompt,
            _a;
    };
    NglModal.prototype.handleOpen = function (open) {
        if (open === void 0) { open = this.open; }
        if (open) {
            if (this.document) {
                this.elementFocusedBeforeDialogWasOpened = this.document.activeElement;
            }
            this.container = this.overlay.create();
            // Attach the dom to overlay, the view container is not changed
            this.container.overlayElement.appendChild(this.element.nativeElement);
            this.focusTrap = this.focusTrapFactory.create(this.element.nativeElement);
            this.focusTrap.focusInitialElementWhenReady();
            this.scrollStrategy.enable();
        }
        else {
            if (this.elementFocusedBeforeDialogWasOpened && typeof this.elementFocusedBeforeDialogWasOpened.focus === 'function') {
                this.elementFocusedBeforeDialogWasOpened.focus();
            }
            if (this.container) {
                this.container.dispose();
                this.container = null;
            }
            if (this.focusTrap) {
                this.focusTrap.destroy();
            }
            this.scrollStrategy.disable();
        }
    };
    NglModal.ctorParameters = function () { return [
        { type: FocusTrapFactory },
        { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] },
        { type: Overlay },
        { type: ElementRef }
    ]; };
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], NglModal.prototype, "header", void 0);
    __decorate([
        Input(),
        __metadata("design:type", String)
    ], NglModal.prototype, "size", void 0);
    __decorate([
        Input(), InputBoolean(),
        __metadata("design:type", Object)
    ], NglModal.prototype, "directional", void 0);
    __decorate([
        Input(), InputBoolean(),
        __metadata("design:type", Object)
    ], NglModal.prototype, "open", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], NglModal.prototype, "closeButtonAssistiveText", void 0);
    __decorate([
        Output(),
        __metadata("design:type", Object)
    ], NglModal.prototype, "openChange", void 0);
    __decorate([
        ContentChild(NglModalHeaderTemplate),
        __metadata("design:type", NglModalHeaderTemplate)
    ], NglModal.prototype, "headerTpl", void 0);
    __decorate([
        ContentChild(NglModalTaglineTemplate),
        __metadata("design:type", NglModalTaglineTemplate)
    ], NglModal.prototype, "taglineTpl", void 0);
    __decorate([
        ContentChild(NglModalFooterTemplate),
        __metadata("design:type", NglModalFooterTemplate)
    ], NglModal.prototype, "footer", void 0);
    __decorate([
        Input(), InputBoolean(),
        __metadata("design:type", Object)
    ], NglModal.prototype, "dismissOnClickOutside", void 0);
    __decorate([
        Input(),
        __metadata("design:type", String)
    ], NglModal.prototype, "prompt", void 0);
    __decorate([
        hasObservers('openChange'),
        __metadata("design:type", Boolean)
    ], NglModal.prototype, "showClose", void 0);
    __decorate([
        HostListener('keydown.esc', ['$event']),
        __metadata("design:type", Function),
        __metadata("design:paramtypes", [Event]),
        __metadata("design:returntype", void 0)
    ], NglModal.prototype, "close", null);
    __decorate([
        HostListener('click', ['$event']),
        __metadata("design:type", Function),
        __metadata("design:paramtypes", [Object]),
        __metadata("design:returntype", void 0)
    ], NglModal.prototype, "clickOutside", null);
    NglModal = __decorate([
        Component({
            selector: 'ngl-modal',
            template: "\n<section class=\"slds-modal\" [ngClass]=\"modalClass()\" [attr.aria-hidden]=\"!open\" [attr.aria-labelledby]=\"headingId\" [attr.aria-describedby]=\"contentId\" aria-modal=\"true\" [attr.role]=\"prompt ? 'alertdialog' : 'dialog'\" tabindex=\"-1\">\n  <div class=\"slds-modal__container\">\n    <header class=\"slds-modal__header\" [ngClass]=\"modalHeaderClass()\">\n      <button class=\"slds-button slds-button_icon slds-button_icon-inverse slds-modal__close\" *ngIf=\"showClose\" type=\"button\" (click)=\"close()\">\n        <svg class=\"slds-button__icon slds-button__icon_large\" nglIconName=\"utility:close\"></svg><span class=\"slds-assistive-text\" *ngIf=\"closeButtonAssistiveText\">{{closeButtonAssistiveText}}</span>\n      </button>\n      <ng-template #localHeader>\n        <h2 class=\"slds-text-heading_medium slds-hyphenate\" *ngIf=\"header\" [id]=\"headingId\">{{header}}</h2>\n      </ng-template>\n      <ng-template *ngIf=\"headerTpl; else localHeader\" [ngTemplateOutlet]=\"headerTpl.templateRef\" [ngTemplateOutletContext]=\"{id: headingId}\"></ng-template>\n      <p class=\"slds-m-top_x-small\" *ngIf=\"hasHeader &amp;&amp; taglineTpl\">\n        <ng-template [ngTemplateOutlet]=\"taglineTpl.templateRef\"></ng-template>\n      </p>\n    </header>\n    <div class=\"slds-modal__content\" [id]=\"contentId\" cdkScrollable>\n      <ng-content></ng-content>\n    </div>\n    <footer class=\"slds-modal__footer\" *ngIf=\"footer\" [ngClass]=\"modalFooterClass()\">\n      <ng-template [ngTemplateOutlet]=\"footer.templateRef\"></ng-template>\n    </footer>\n  </div>\n</section>\n<div class=\"slds-backdrop\" [class.slds-backdrop_open]=\"open\"></div>",
            changeDetection: ChangeDetectionStrategy.OnPush
        }),
        __param(1, Inject(DOCUMENT)),
        __metadata("design:paramtypes", [FocusTrapFactory, Object, Overlay,
            ElementRef])
    ], NglModal);
    return NglModal;
}());
export { NglModal };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kYWwuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZy1saWdodG5pbmcvIiwic291cmNlcyI6WyJsaWIvbW9kYWxzL21vZGFsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBRSxZQUFZLEVBQUUsWUFBWSxFQUM5RSx1QkFBdUIsRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLGFBQWEsRUFBRSxnQkFBZ0IsRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdkgsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxTQUFTLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNoRSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2hGLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDeEMsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQy9DLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSx1QkFBdUIsRUFBRSxzQkFBc0IsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUN0RyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFPcEQ7SUEyQ0Usa0JBQW9CLGdCQUFrQyxFQUNoQixRQUFhLEVBQy9CLE9BQWdCLEVBQ2hCLE9BQW1CO1FBSG5CLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDaEIsYUFBUSxHQUFSLFFBQVEsQ0FBSztRQUMvQixZQUFPLEdBQVAsT0FBTyxDQUFTO1FBQ2hCLFlBQU8sR0FBUCxPQUFPLENBQVk7UUE3QzlCLFdBQU0sR0FBRyxFQUFFLENBQUM7UUFJSSxnQkFBVyxHQUFHLEtBQUssQ0FBQztRQUU3QyxjQUFTLEdBQUcsUUFBUSxDQUFDLGVBQWUs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QjsrQ0FBQztJQUVqQztRQUF0QyxZQUFZLENBQUMsdUJBQXVCLENBQUM7a0NBQWEsdUJBQXVCO2dEQUFDO0lBRXJDO1FBQXJDLFlBQVksQ0FBQyxzQkFBc0IsQ0FBQztrQ0FBUyxzQkFBc0I7NENBQUM7SUFFNUM7UUFBeEIsS0FBSyxFQUFFLEVBQUUsWUFBWSxFQUFFOzsyREFBOEI7SUFFN0M7UUFBUixLQUFLLEVBQUU7OzRDQUF5RTtJQUVyRDtRQUEzQixZQUFZLENBQUMsWUFBWSxDQUFDOzsrQ0FBb0I7SUFvQi9DO1FBREMsWUFBWSxDQUFDLGFBQWEsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDOzt5Q0FDNUIsS0FBSzs7eUNBS2hCO0lBYUQ7UUFEQyxZQUFZLENBQUMsT0FBTyxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUM7Ozs7Z0RBVWpDO0lBOUVVLFFBQVE7UUFMcEIsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLFdBQVc7WUFDckIsb3BEQUEyQjtZQUMzQixlQUFlLEVBQUUsdUJBQXVCLENBQUMsTUFBTTtTQUNoRCxDQUFDO1FBNkNhLFdBQUEsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFBO3lDQURTLGdCQUFnQixVQUV6QixPQUFPO1lBQ1AsVUFBVTtPQTlDNUIsUUFBUSxDQXdJcEI7SUFBRCxlQUFDO0NBQUEsQUF4SUQsSUF3SUM7U0F4SVksUUFBUSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgSW5wdXQsIE91dHB1dCwgRWxlbWVudFJlZiwgRXZlbnRFbWl0dGVyLCBIb3N0TGlzdGVuZXIsIENvbnRlbnRDaGlsZCxcbiAgICAgICAgIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LCBJbmplY3QsIE9uQ2hhbmdlcywgU2ltcGxlQ2hhbmdlcywgQWZ0ZXJDb250ZW50SW5pdCwgT25EZXN0cm95IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBET0NVTUVOVCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBGb2N1c1RyYXAsIEZvY3VzVHJhcEZhY3RvcnkgfSBmcm9tICdAYW5ndWxhci9jZGsvYTExeSc7XG5pbXBvcnQgeyBCbG9ja1Njcm9sbFN0cmF0ZWd5LCBPdmVybGF5LCBPdmVybGF5UmVmIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL292ZXJsYXknO1xuaW1wb3J0IHsgdW5pcXVlSWQgfSBmcm9tICcuLi91dGlsL3V0aWwnO1xuaW1wb3J0IHsgSW5wdXRCb29sZWFuIH0gZnJvbSAnLi4vdXRpbC9jb252ZXJ0JztcbmltcG9ydCB7IE5nbE1vZGFsSGVhZGVyVGVtcGxhdGUsIE5nbE1vZGFsVGFnbGluZVRlbXBsYXRlLCBOZ2xNb2RhbEZvb3RlclRlbXBsYXRlIH0gZnJvbSAnLi90ZW1wbGF0ZXMnO1xuaW1wb3J0IHsgaGFzT2JzZXJ2ZXJzIH0gZnJvbSAnLi4vdXRpbC9oYXNPYnNlcnZlcnMnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICduZ2wtbW9kYWwnLFxuICB0ZW1wbGF0ZVVybDogJy4vbW9kYWwuaHRtbCcsXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxufSlcbmV4cG9ydCBjbGFzcyBOZ2xNb2RhbCBpbXBsZW1lbnRzIE9uQ2hhbmdlcywgQWZ0ZXJDb250ZW50SW5pdCwgT25EZXN0cm95IHtcbiAgQElucHV0KCkgaGVhZGVyID0gJyc7XG5cbiAgQElucHV0KCkgc2l6ZTogc3RyaW5nO1xuXG4gIEBJbnB1dCgpIEBJbnB1dEJvb2xlYW4oKSBkaXJlY3Rpb25hbCA9IGZhbHNlO1xuXG4gIGhlYWRpbmdJZCA9IHVuaXF1ZUlkKCdtb2RhbC1oZWFkaW5nJyk7XG5cbiAgY29udGVudElkID0gdW5pcXVlSWQoJ21vZGFsLWNvbnRlbnQnKTtcblxuICBASW5wdXQoKSBASW5wdXRCb29sZWFuKCkgb3BlbiA9IHRydWU7XG5cbiAgZ2V0IGhhc0hlYWRlcigpIHtcbiAgICByZXR1cm4gdGhpcy5oZWFkZXIgfHwgdGhpcy5oZWFkZXJUcGw7XG4gIH1cblxuICBASW5wdXQoKSBjbG9zZUJ1dHRvbkFzc2lzdGl2ZVRleHQgPSAnQ2xvc2UnO1xuXG4gIEBPdXRwdXQoKSBvcGVuQ2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gIEBDb250ZW50Q2hpbGQoTmdsTW9kYWxIZWFkZXJUZW1wbGF0ZSkgaGVhZGVyVHBsOiBOZ2xNb2RhbEhlYWRlclRlbXBsYXRlO1xuXG4gIEBDb250ZW50Q2hpbGQoTmdsTW9kYWxUYWdsaW5lVGVtcGxhdGUpIHRhZ2xpbmVUcGw6IE5nbE1vZGFsVGFnbGluZVRlbXBsYXRlO1xuXG4gIEBDb250ZW50Q2hpbGQoTmdsTW9kYWxGb290ZXJUZW1wbGF0ZSkgZm9vdGVyOiBOZ2xNb2RhbEZvb3RlclRlbXBsYXRlO1xuXG4gIEBJbnB1dCgpIEBJbnB1dEJvb2xlYW4oKSBkaXNtaXNzT25DbGlja091dHNpZGUgPSB0cnVlO1xuXG4gIEBJbnB1dCgpIHByb21wdDogJ3N1Y2Nlc3MnIHwgJ3dhcm5pbmcnIHwgJ2Vycm9yJyB8ICd3cmVuY2gnIHwgJ29mZmxpbmUnIHwgJ2luZm8nO1xuXG4gIEBoYXNPYnNlcnZlcnMoJ29wZW5DaGFuZ2UnKSBzaG93Q2xvc2U6IGJvb2xlYW47XG5cbiAgLyoqIFRoZSBjbGFzcyB0aGF0IHRyYXBzIGFuZCBtYW5hZ2VzIGZvY3VzIHdpdGhpbiB0aGUgZGlhbG9nLiAqL1xuICBwcml2YXRlIGZvY3VzVHJhcDogRm9jdXNUcmFwO1xuXG4gIHByaXZhdGUgY29udGFpbmVyOiBPdmVybGF5UmVmO1xuXG4gIC8qKiBFbGVtZW50IHRoYXQgd2FzIGZvY3VzZWQgYmVmb3JlIHRoZSBkaWFsb2cgd2FzIG9wZW5lZC4gU2F2ZSB0aGlzIHRvIHJlc3RvcmUgdXBvbiBjbG9zZS4gKi9cbiAgcHJpdmF0ZSBlbGVtZW50Rm9jdXNlZEJlZm9yZURpYWxvZ1dhc09wZW5lZDogSFRNTEVsZW1lbnQgfCBudWxsID0gbnVsbDtcblxuICBwcml2YXRlIHNjcm9sbFN0cmF0ZWd5OiBCbG9ja1Njcm9sbFN0cmF0ZWd5O1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZm9jdXNUcmFwRmFjdG9yeTogRm9jdXNUcmFwRmFjdG9yeSxcbiAgICAgICAgICAgICAgQEluamVjdChET0NVTUVOVCkgcHJpdmF0ZSBkb2N1bWVudDogYW55LFxuICAgICAgICAgICAgICBwcml2YXRlIG92ZXJsYXk6IE92ZXJsYXksXG4gICAgICAgICAgICAgIHByaXZhdGUgZWxlbWVudDogRWxlbWVudFJlZikge1xuICAgIHRoaXMuc2Nyb2xsU3RyYXRlZ3kgPSB0aGlzLm92ZXJsYXkuc2Nyb2xsU3RyYXRlZ2llcy5ibG9jaygpO1xuICB9XG5cbiAgQEhvc3RMaXN0ZW5lcigna2V5ZG93bi5lc2MnLCBbJyRldmVudCddKVxuICBjbG9zZShldnQ/OiBFdmVudCkge1xuICAgIGlmIChldnQpIHtcbiAgICAgIGV2dC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICB9XG4gICAgdGhpcy5vcGVuQ2hhbmdlLmVtaXQoZmFsc2UpO1xuICB9XG5cbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xuICAgIGlmICgnb3BlbicgaW4gY2hhbmdlcykge1xuICAgICAgdGhpcy5oYW5kbGVPcGVuKCk7XG4gICAgfVxuICB9XG5cbiAgbmdBZnRlckNvbnRlbnRJbml0KCkge1xuICAgIHRoaXMuaGFuZGxlT3BlbigpO1xuICB9XG5cbiAgQEhvc3RMaXN0ZW5lcignY2xpY2snLCBbJyRldmVudCddKVxuICBjbGlja091dHNpZGUoZXZ0KSB7XG4gICAgaWYgKCF0aGlzLmRpc21pc3NPbkNsaWNrT3V0c2lkZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHsgY2xhc3NMaXN0IH0gPSBldnQudGFyZ2V0O1xuICAgIGlmIChjbGFzc0xpc3QuY29udGFpbnMoJ3NsZHMtbW9kYWwnKSB8fCBjbGFzc0xpc3QuY29udGFpbnMoJ3NsZHMtbW9kYWxfX2NvbnRhaW5lcicpKSB7XG4gICAgICB0aGlzLmNsb3NlKCk7XG4gICAgfVxuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5oYW5kbGVPcGVuKGZhbHNlKTtcbiAgICB0aGlzLnNjcm9sbFN0cmF0ZWd5ID0gbnVsbDtcbiAgfVxuXG4gIG1vZGFsQ2xhc3MoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIFtgc2xkcy1tb2RhbF8ke3RoaXMuc2l6ZX1gXTogISF0aGlzLnNpemUsXG4gICAgICBbYHNsZHMtZmFkZS1pbi1vcGVuYF06IHRoaXMub3BlbixcbiAgICAgIFtgc2xkcy1tb2RhbF9wcm9tcHRgXTogISF0aGlzLnByb21wdCxcbiAgICB9O1xuICB9XG5cbiAgbW9kYWxIZWFkZXJDbGFzcygpIHtcbiAgICByZXR1cm4ge1xuICAgICAgW2BzbGRzLW1vZGFsX19oZWFkZXJfZW1wdHlgXTogIXRoaXMuaGFzSGVhZGVyLFxuICAgICAgW2BzbGRzLXRoZW1lXyR7dGhpcy5wcm9tcHR9YF06ICEhdGhpcy5wcm9tcHQsXG4gICAgfTtcbiAgfVxuXG4gIG1vZGFsRm9vdGVyQ2xhc3MoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIFtgc2xkcy1tb2RhbF9fZm9vdGVyX2RpcmVjdGlvbmFsYF06ICEhdGhpcy5kaXJlY3Rpb25hbCxcbiAgICAgIFtgc2xkcy10aGVtZV9kZWZhdWx0YF06ICEhdGhpcy5wcm9tcHQsXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlT3BlbihvcGVuID0gdGhpcy5vcGVuKSB7XG4gICAgaWYgKG9wZW4pIHtcbiAgICAgIGlmICh0aGlzLmRvY3VtZW50KSB7XG4gICAgICAgIHRoaXMuZWxlbWVudEZvY3VzZWRCZWZvcmVEaWFsb2dXYXNPcGVuZWQgPSB0aGlzLmRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgYXMgSFRNTEVsZW1lbnQ7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuY29udGFpbmVyID0gdGhpcy5vdmVybGF5LmNyZWF0ZSgpO1xuICAgICAgLy8gQXR0YWNoIHRoZSBkb20gdG8gb3ZlcmxheSwgdGhlIHZpZXcgY29udGFpbmVyIGlzIG5vdCBjaGFuZ2VkXG4gICAgICB0aGlzLmNvbnRhaW5lci5vdmVybGF5RWxlbWVudC5hcHBlbmRDaGlsZCh0aGlzLmVsZW1lbnQubmF0aXZlRWxlbWVudCk7XG5cbiAgICAgIHRoaXMuZm9jdXNUcmFwID0gdGhpcy5mb2N1c1RyYXBGYWN0b3J5LmNyZWF0ZSh0aGlzLmVsZW1lbnQubmF0aXZlRWxlbWVudCk7XG4gICAgICB0aGlzLmZvY3VzVHJhcC5mb2N1c0luaXRpYWxFbGVtZW50V2hlblJlYWR5KCk7XG4gICAgICB0aGlzLnNjcm9sbFN0cmF0ZWd5LmVuYWJsZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodGhpcy5lbGVtZW50Rm9jdXNlZEJlZm9yZURpYWxvZ1dhc09wZW5lZCAmJiB0eXBlb2YgdGhpcy5lbGVtZW50Rm9jdXNlZEJlZm9yZURpYWxvZ1dhc09wZW5lZC5mb2N1cyA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICB0aGlzLmVsZW1lbnRGb2N1c2VkQmVmb3JlRGlhbG9nV2FzT3BlbmVkLmZvY3VzKCk7XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLmNvbnRhaW5lcikge1xuICAgICAgICB0aGlzLmNvbnRhaW5lci5kaXNwb3NlKCk7XG4gICAgICAgIHRoaXMuY29udGFpbmVyID0gbnVsbDtcbiAgICAgIH1cblxuICAgICAgaWYgKHRoaXMuZm9jdXNUcmFwKSB7XG4gICAgICAgIHRoaXMuZm9jdXNUcmFwLmRlc3Ryb3koKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuc2Nyb2xsU3RyYXRlZ3kuZGlzYWJsZSgpO1xuICAgIH1cbiAgfVxufVxuIl19