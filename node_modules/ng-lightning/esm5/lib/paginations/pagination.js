import { __decorate, __metadata, __read, __spread } from "tslib";
import { Component, EventEmitter, Input, Output, ChangeDetectionStrategy } from '@angular/core';
import { InputBoolean } from '../util/convert';
var NglPagination = /** @class */ (function () {
    function NglPagination() {
        this.pages = [];
        this.pageChange = new EventEmitter();
        this.perPage = 10;
        this.limit = 0;
        this.boundaryNumbers = 0;
        this.firstText = 'First';
        this.previousText = 'Previous';
        this.nextText = 'Next';
        this.lastText = 'Last';
        this.boundaryLinks = false;
    }
    Object.defineProperty(NglPagination.prototype, "page", {
        set: function (page) {
            this.current = +page;
        },
        enumerable: true,
        configurable: true
    });
    NglPagination.prototype.hasPrevious = function () {
        return this.current > 1;
    };
    NglPagination.prototype.hasNext = function () {
        return this.current < this.totalPages;
    };
    NglPagination.prototype.goto = function (page) {
        if (page === this.current) {
            return;
        }
        this.pageChange.emit(+page);
    };
    NglPagination.prototype.ngOnChanges = function () {
        var _a, _b;
        var _this = this;
        this.totalPages = Math.ceil(+this.total / +this.perPage);
        var _c = this.limits(), start = _c.start, end = _c.end;
        this.pages = this.getPageArray(start, end);
        if (this.boundaryNumbers > 0) {
            if (start > 1) {
                var preGap = this.getPageArray(1, Math.min(start - 1, this.boundaryNumbers));
                var lastGapNumber = +preGap[preGap.length - 1].number;
                if (lastGapNumber < start - 1) {
                    this.pages.unshift(this.getGapPage(lastGapNumber, start));
                }
                (_a = this.pages).unshift.apply(_a, __spread(preGap));
            }
            if (end < this.totalPages) {
                var postGap = this.getPageArray(Math.max(this.totalPages - this.boundaryNumbers + 1, end + 1), this.totalPages);
                var firstGapNumber = +postGap[0].number;
                if (firstGapNumber > end + 1) {
                    this.pages.push(this.getGapPage(end, firstGapNumber));
                }
                (_b = this.pages).push.apply(_b, __spread(postGap));
            }
        }
        if (this.current > this.totalPages) {
            setTimeout(function () { return _this.goto(_this.totalPages); });
        }
        else if (!this.current && this.totalPages > 0) {
            setTimeout(function () { return _this.goto(1); });
        }
    };
    NglPagination.prototype.pageTrackBy = function (index, page) {
        return page.number;
    };
    Object.defineProperty(NglPagination.prototype, "start", {
        get: function () {
            return Math.min(Math.max(1 + (+this.current - 1) * +this.perPage, 0), +this.total);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NglPagination.prototype, "end", {
        get: function () {
            return Math.min(this.start + (+this.perPage - 1), +this.total);
        },
        enumerable: true,
        configurable: true
    });
    NglPagination.prototype.getPageArray = function (start, end) {
        var _this = this;
        return Array.apply(null, { length: end - start + 1 }).map(function (value, index) { return _this.getPage(start + index); });
    };
    NglPagination.prototype.getPage = function (number, disabled) {
        if (disabled === void 0) { disabled = false; }
        return { number: number, disabled: disabled };
    };
    NglPagination.prototype.getGapPage = function (before, after) {
        var isConsecutive = before + 1 === after - 1;
        return this.getPage(isConsecutive ? before + 1 : '...', !isConsecutive);
    };
    /**
     * Calculate first and last visible page numbers
     */
    NglPagination.prototype.limits = function () {
        var start = 1, end = this.totalPages;
        if (this.limit < 1) {
            return { start: start, end: end };
        }
        // Current page is displayed in the middle of the visible ones
        start = Math.max(+this.current - Math.floor(+this.limit / 2), 1);
        end = start + +this.limit - 1;
        // Adjust if limit is exceeded
        if (end > this.totalPages) {
            end = this.totalPages;
            start = Math.max(end - +this.limit + 1, 1);
        }
        return { start: start, end: end };
    };
    __decorate([
        Input(),
        __metadata("design:type", Object),
        __metadata("design:paramtypes", [Object])
    ], NglPagination.prototype, "page", null);
    __decorate([
        Output(),
        __metadata("design:type", Object)
    ], NglPagination.prototype, "pageChange", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], NglPagination.prototype, "total", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], NglPagination.prototype, "perPage", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], NglPagination.prototype, "limit", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], NglPagination.prototype, "boundaryNumbers", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], NglPagination.prototype, "firstText", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], NglPagination.prototype, "previousText", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], NglPagination.prototype, "nextText", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], NglPagination.prototype, "lastText", void 0);
    __decorate([
        Input(), InputBoolean(),
        __metadata("design:type", Object)
    ], NglPagination.prototype, "boundaryLinks", void 0);
    NglPagination = __decorate([
        Component({
            selector: 'ngl-pagination',
            changeDetection: ChangeDetectionStrategy.OnPush,
            template: "\n<div class=\"slds-button-group\" role=\"group\">\n  <button class=\"slds-button slds-button_neutral\" *ngIf=\"boundaryLinks\" [disabled]=\"!hasPrevious()\" (click)=\"goto(1)\">{{firstText}}</button>\n  <button class=\"slds-button slds-button_neutral\" [disabled]=\"!hasPrevious()\" (click)=\"goto(current - 1)\">{{previousText}}</button>\n  <button class=\"slds-button\" *ngFor=\"let page of pages; trackBy:pageTrackBy\" [ngClass]=\"'slds-button_' + (page.number === current ? 'brand' : 'neutral')\" (click)=\"goto(page.number)\" [disabled]=\"page.disabled\">{{page.number}}</button>\n  <button class=\"slds-button slds-button_neutral\" [disabled]=\"!hasNext()\" (click)=\"goto(current + 1)\">{{nextText}}</button>\n  <button class=\"slds-button slds-button_neutral\" *ngIf=\"boundaryLinks\" [disabled]=\"!hasNext()\" (click)=\"goto(totalPages)\">{{lastText}}</button>\n</div>",
            exportAs: 'nglPagination'
        })
    ], NglPagination);
    return NglPagination;
}());
export { NglPagination };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFnaW5hdGlvbi5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25nLWxpZ2h0bmluZy8iLCJzb3VyY2VzIjpbImxpYi9wYWdpbmF0aW9ucy9wYWdpbmF0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFhLHVCQUF1QixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNHLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQVUvQztJQUFBO1FBRUUsVUFBSyxHQUFjLEVBQUUsQ0FBQztRQU1aLGVBQVUsR0FBRyxJQUFJLFlBQVksRUFBVSxDQUFDO1FBR3pDLFlBQU8sR0FBb0IsRUFBRSxDQUFDO1FBQzlCLFVBQUssR0FBb0IsQ0FBQyxDQUFDO1FBQzNCLG9CQUFlLEdBQUcsQ0FBQyxDQUFDO1FBQ3BCLGNBQVMsR0FBRyxPQUFPLENBQUM7UUFDcEIsaUJBQVksR0FBRyxVQUFVLENBQUM7UUFDMUIsYUFBUSxHQUFHLE1BQU0sQ0FBQztRQUNsQixhQUFRLEdBQUcsTUFBTSxDQUFDO1FBQ0Ysa0JBQWEsR0FBRyxLQUFLLENBQUM7SUFpR2pELENBQUM7SUE5R1Usc0JBQUksK0JBQUk7YUFBUixVQUFTLElBQXFCO1lBQ3JDLElBQUksQ0FBQyxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUM7UUFDdkIsQ0FBQzs7O09BQUE7SUFlRCxtQ0FBVyxHQUFYO1FBQ0UsT0FBTyxJQUFJLENBQUMsT0FBTyxHQUFHLENBQUMsQ0FBQztJQUMxQixDQUFDO0lBRUQsK0JBQU8sR0FBUDtRQUNFLE9BQU8sSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDO0lBQ3hDLENBQUM7SUFFRCw0QkFBSSxHQUFKLFVBQUssSUFBWTtRQUNmLElBQUksSUFBSSxLQUFLLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFBRSxPQUFPO1NBQUU7UUFDdEMsSUFBSSxDQUFDLFVBQVUsQ0FB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QixTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUsZ0JBQWdCO1lBQzFCLGVBQWUsRUFBRSx1QkFBdUIsQ0FBQyxNQUFNO1lBQy9DLDAzQkFBZ0M7WUFDaEMsUUFBUSxFQUFFLGVBQWU7U0FDMUIsQ0FBQztPQUNXLGFBQWEsQ0FtSHpCO0lBQUQsb0JBQUM7Q0FBQSxBQW5IRCxJQW1IQztTQW5IWSxhQUFhIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBFdmVudEVtaXR0ZXIsIElucHV0LCBPdXRwdXQsIE9uQ2hhbmdlcywgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IElucHV0Qm9vbGVhbiB9IGZyb20gJy4uL3V0aWwvY29udmVydCc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgTmdsUGFnZSB7IG51bWJlcjogbnVtYmVyIHwgc3RyaW5nOyBkaXNhYmxlZD86IGJvb2xlYW47IH1cblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnbmdsLXBhZ2luYXRpb24nLFxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaCxcbiAgdGVtcGxhdGVVcmw6ICcuL3BhZ2luYXRpb24uaHRtbCcsXG4gIGV4cG9ydEFzOiAnbmdsUGFnaW5hdGlvbicsXG59KVxuZXhwb3J0IGNsYXNzIE5nbFBhZ2luYXRpb24gaW1wbGVtZW50cyBPbkNoYW5nZXMge1xuXG4gIHBhZ2VzOiBOZ2xQYWdlW10gPSBbXTtcblxuICBjdXJyZW50OiBudW1iZXI7XG4gIEBJbnB1dCgpIHNldCBwYWdlKHBhZ2U6IG51bWJlciB8IHN0cmluZykge1xuICAgIHRoaXMuY3VycmVudCA9ICtwYWdlO1xuICB9XG4gIEBPdXRwdXQoKSBwYWdlQ2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcjxudW1iZXI+KCk7XG5cbiAgQElucHV0KCkgdG90YWw6IG51bWJlciB8IHN0cmluZztcbiAgQElucHV0KCkgcGVyUGFnZTogbnVtYmVyIHwgc3RyaW5nID0gMTA7XG4gIEBJbnB1dCgpIGxpbWl0OiBudW1iZXIgfCBzdHJpbmcgPSAwO1xuICBASW5wdXQoKSBib3VuZGFyeU51bWJlcnMgPSAwO1xuICBASW5wdXQoKSBmaXJzdFRleHQgPSAnRmlyc3QnO1xuICBASW5wdXQoKSBwcmV2aW91c1RleHQgPSAnUHJldmlvdXMnO1xuICBASW5wdXQoKSBuZXh0VGV4dCA9ICdOZXh0JztcbiAgQElucHV0KCkgbGFzdFRleHQgPSAnTGFzdCc7XG4gIEBJbnB1dCgpIEBJbnB1dEJvb2xlYW4oKSBib3VuZGFyeUxpbmtzID0gZmFsc2U7XG5cbiAgdG90YWxQYWdlczogbnVtYmVyO1xuXG4gIGhhc1ByZXZpb3VzKCkge1xuICAgIHJldHVybiB0aGlzLmN1cnJlbnQgPiAxO1xuICB9XG5cbiAgaGFzTmV4dCgpIHtcbiAgICByZXR1cm4gdGhpcy5jdXJyZW50IDwgdGhpcy50b3RhbFBhZ2VzO1xuICB9XG5cbiAgZ290byhwYWdlOiBudW1iZXIpIHtcbiAgICBpZiAocGFnZSA9PT0gdGhpcy5jdXJyZW50KSB7IHJldHVybjsgfVxuICAgIHRoaXMucGFnZUNoYW5nZS5lbWl0KCtwYWdlKTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKCkge1xuICAgIHRoaXMudG90YWxQYWdlcyA9IE1hdGguY2VpbCgrdGhpcy50b3RhbCAvICt0aGlzLnBlclBhZ2UpO1xuXG4gICAgY29uc3QgeyBzdGFydCwgZW5kIH0gPSB0aGlzLmxpbWl0cygpO1xuXG4gICAgdGhpcy5wYWdlcyA9IHRoaXMuZ2V0UGFnZUFycmF5KHN0YXJ0LCBlbmQpO1xuXG4gICAgaWYgKHRoaXMuYm91bmRhcnlOdW1iZXJzID4gMCkge1xuICAgICAgaWYgKHN0YXJ0ID4gMSkge1xuICAgICAgICBjb25zdCBwcmVHYXAgPSB0aGlzLmdldFBhZ2VBcnJheSgxLCBNYXRoLm1pbihzdGFydCAtIDEsIHRoaXMuYm91bmRhcnlOdW1iZXJzKSk7XG4gICAgICAgIGNvbnN0IGxhc3RHYXBOdW1iZXIgPSArcHJlR2FwW3ByZUdhcC5sZW5ndGggLSAxXS5udW1iZXI7XG4gICAgICAgIGlmIChsYXN0R2FwTnVtYmVyIDwgc3RhcnQgLSAxKSB7XG4gICAgICAgICAgdGhpcy5wYWdlcy51bnNoaWZ0KHRoaXMuZ2V0R2FwUGFnZShsYXN0R2FwTnVtYmVyLCBzdGFydCkpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMucGFnZXMudW5zaGlmdCguLi5wcmVHYXApO1xuICAgICAgfVxuXG4gICAgICBpZiAoZW5kIDwgdGhpcy50b3RhbFBhZ2VzKSB7XG4gICAgICAgIGNvbnN0IHBvc3RHYXAgPSB0aGlzLmdldFBhZ2VBcnJheShNYXRoLm1heCh0aGlzLnRvdGFsUGFnZXMgLSB0aGlzLmJvdW5kYXJ5TnVtYmVycyArIDEsIGVuZCArIDEpLCB0aGlzLnRvdGFsUGFnZXMpO1xuICAgICAgICBjb25zdCBmaXJzdEdhcE51bWJlciA9ICtwb3N0R2FwWzBdLm51bWJlcjtcbiAgICAgICAgaWYgKGZpcnN0R2FwTnVtYmVyID4gZW5kICsgMSkge1xuICAgICAgICAgIHRoaXMucGFnZXMucHVzaCh0aGlzLmdldEdhcFBhZ2UoZW5kLCBmaXJzdEdhcE51bWJlcikpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMucGFnZXMucHVzaCguLi5wb3N0R2FwKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAodGhpcy5jdXJyZW50ID4gdGhpcy50b3RhbFBhZ2VzKSB7XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuZ290byh0aGlzLnRvdGFsUGFnZXMpKTtcbiAgICB9IGVsc2UgaWYgKCF0aGlzLmN1cnJlbnQgJiYgdGhpcy50b3RhbFBhZ2VzID4gMCkge1xuICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLmdvdG8oMSkpO1xuICAgIH1cbiAgfVxuXG4gIHBhZ2VUcmFja0J5KGluZGV4OiBudW1iZXIsIHBhZ2U6IE5nbFBhZ2UpIHtcbiAgICByZXR1cm4gcGFnZS5udW1iZXI7XG4gIH1cblxuICBnZXQgc3RhcnQoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gTWF0aC5taW4oTWF0aC5tYXgoMSArICgrdGhpcy5jdXJyZW50IC0gMSkgKiArdGhpcy5wZXJQYWdlLCAwKSwgK3RoaXMudG90YWwpO1xuICB9XG5cbiAgZ2V0IGVuZCgpOiBudW1iZXIge1xuICAgIHJldHVybiBNYXRoLm1pbih0aGlzLnN0YXJ0ICsgKCt0aGlzLnBlclBhZ2UgLSAxKSwgK3RoaXMudG90YWwpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRQYWdlQXJyYXkoc3RhcnQ6IG51bWJlciwgZW5kOiBudW1iZXIpIHtcbiAgICByZXR1cm4gQXJyYXkuYXBwbHkobnVsbCwge2xlbmd0aDogZW5kIC0gc3RhcnQgKyAxfSkubWFwKCh2YWx1ZTogYW55LCBpbmRleDogbnVtYmVyKSA9PiB0aGlzLmdldFBhZ2Uoc3RhcnQgKyBpbmRleCkpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRQYWdlKG51bWJlcjogc3RyaW5nIHwgbnVtYmVyLCBkaXNhYmxlZCA9IGZhbHNlKTogTmdsUGFnZSB7XG4gICAgcmV0dXJuIHsgbnVtYmVyLCBkaXNhYmxlZCB9O1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRHYXBQYWdlKGJlZm9yZTogbnVtYmVyLCBhZnRlcjogbnVtYmVyKSB7XG4gICAgY29uc3QgaXNDb25zZWN1dGl2ZSA9IGJlZm9yZSArIDEgPT09IGFmdGVyIC0gMTtcbiAgICByZXR1cm4gdGhpcy5nZXRQYWdlKGlzQ29uc2VjdXRpdmUgPyBiZWZvcmUgKyAxIDogJy4uLicsICFpc0NvbnNlY3V0aXZlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDYWxjdWxhdGUgZmlyc3QgYW5kIGxhc3QgdmlzaWJsZSBwYWdlIG51bWJlcnNcbiAgICovXG4gIHByaXZhdGUgbGltaXRzKCkge1xuICAgIGxldCBzdGFydCA9IDEsIGVuZCA9IHRoaXMudG90YWxQYWdlcztcblxuICAgIGlmICh0aGlzLmxpbWl0IDwgMSkgeyByZXR1cm4ge3N0YXJ0LCBlbmR9OyB9XG5cbiAgICAvLyBDdXJyZW50IHBhZ2UgaXMgZGlzcGxheWVkIGluIHRoZSBtaWRkbGUgb2YgdGhlIHZpc2libGUgb25lc1xuICAgIHN0YXJ0ID0gTWF0aC5tYXgoK3RoaXMuY3VycmVudCAtIE1hdGguZmxvb3IoK3RoaXMubGltaXQgLyAyKSwgMSk7XG4gICAgZW5kID0gc3RhcnQgKyArdGhpcy5saW1pdCAtIDE7XG5cbiAgICAvLyBBZGp1c3QgaWYgbGltaXQgaXMgZXhjZWVkZWRcbiAgICBpZiAoZW5kID4gdGhpcy50b3RhbFBhZ2VzKSB7XG4gICAgICBlbmQgPSB0aGlzLnRvdGFsUGFnZXM7XG4gICAgICBzdGFydCA9IE1hdGgubWF4KGVuZCAtICt0aGlzLmxpbWl0ICsgMSwgMSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtzdGFydCwgZW5kfTtcbiAgfVxuXG59XG4iXX0=