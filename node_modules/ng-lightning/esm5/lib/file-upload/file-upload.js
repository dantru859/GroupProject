import { __decorate, __metadata } from "tslib";
import { Component, Input, ChangeDetectionStrategy, ElementRef, Renderer2, TemplateRef, HostBinding, OnChanges, SimpleChanges } from '@angular/core';
import { NG_VALUE_ACCESSOR, NG_VALIDATORS } from '@angular/forms';
import { trapEvent, uniqueId } from '../util/util';
import { InputBoolean, InputNumber } from '../util/convert';
import { isFileTypeAccepted } from './file-upload.util';
var NglFileUpload = /** @class */ (function () {
    function NglFileUpload(element, renderer) {
        this.element = element;
        this.renderer = renderer;
        /**
         * File types that can be accepted. See [input accept Attribute](https://www.w3schools.com/tags/att_input_accept.asp).
         */
        this.accept = null;
        /**
         * Whether file selection is disabled.
         */
        this.disabled = false;
        /**
          * How many files can be selected simultaneously. `0` means unlimited.
          */
        this.maxFiles = 1;
        /**
         * File size limit in bytes. `0` means unlimited.
         */
        this.maxFilesize = 0;
        /**
         * Message to display when there is in an error state.
         */
        this.error = null;
        /**
         * Text for button to open file selector.
         */
        this.uploadButtonLabel = 'Upload Files';
        /**
         * Text to display inside drop zone.
         */
        this.dropZoneLabel = 'or Drop Files';
        this.uid = uniqueId('file-upload');
        this.isDragOver = false;
        this.files = [];
        this.onChange = null;
        this.onTouched = function () { };
        this.validatorChange = function () { };
        this.renderer.addClass(this.element.nativeElement, 'slds-form-element');
    }
    NglFileUpload_1 = NglFileUpload;
    NglFileUpload.prototype.writeValue = function (value) {
        this.files = value;
    };
    NglFileUpload.prototype.registerOnChange = function (fn) { this.onChange = fn; };
    NglFileUpload.prototype.registerOnTouched = function (fn) { this.onTouched = fn; };
    NglFileUpload.prototype.registerOnValidatorChange = function (fn) { this.validatorChange = fn; };
    NglFileUpload.prototype.setDisabledState = function (isDisabled) { this.disabled = isDisabled; };
    NglFileUpload.prototype.validate = function (c) {
        var files = c.value;
        if (!files || files.length === 0) {
            return null;
        }
        if (this.maxFiles > 0 && files.length > this.maxFiles) {
            return { nglFileUpload: { maxFiles: files.length } };
        }
        for (var i = 0, n = files.length; i < n; i++) {
            var file = files[i];
            if (this.accept && !isFileTypeAccepted(this.accept, file)) {
                return { nglFileUpload: { invalidType: file } };
            }
            if (this.maxFilesize && file.size > this.maxFilesize) {
                return { nglFileUpload: { maxFilesize: file } };
            }
        }
        return null;
    };
    NglFileUpload.prototype.ngOnChanges = function (changes) {
        if (changes['maxFiles'] || changes['maxFilesize'] || changes['accept']) {
            this.validatorChange();
        }
    };
    NglFileUpload.prototype.onDropZone = function (evt) {
        trapEvent(evt);
        if (this.disabled) {
            return;
        }
        this.isDragOver = evt.type === 'dragover';
        if (evt.type === 'drop' && evt.dataTransfer) {
            this.select(evt.dataTransfer.files);
        }
    };
    NglFileUpload.prototype.onInputChange = function (files) {
        this.select(files);
    };
    NglFileUpload.prototype.select = function (files) {
        this.onChange(Array.from(files));
    };
    var NglFileUpload_1;
    NglFileUpload.ctorParameters = function () { return [
        { type: ElementRef },
        { type: Renderer2 }
    ]; };
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], NglFileUpload.prototype, "label", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], NglFileUpload.prototype, "accept", void 0);
    __decorate([
        Input(), InputBoolean(),
        __metadata("design:type", Object)
    ], NglFileUpload.prototype, "disabled", void 0);
    __decorate([
        Input(), InputNumber(),
        __metadata("design:type", Object)
    ], NglFileUpload.prototype, "maxFiles", void 0);
    __decorate([
        Input(), InputNumber(),
        __metadata("design:type", Object)
    ], NglFileUpload.prototype, "maxFilesize", void 0);
    __decorate([
        HostBinding('class.slds-has-error'),
        Input(),
        __metadata("design:type", Object)
    ], NglFileUpload.prototype, "error", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], NglFileUpload.prototype, "uploadButtonLabel", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], NglFileUpload.prototype, "dropZoneLabel", void 0);
    NglFileUpload = NglFileUpload_1 = __decorate([
        Component({
            selector: 'ngl-file-upload',
            changeDetection: ChangeDetectionStrategy.OnPush,
            template: "<span class=\"slds-form-element__label\" *ngIf=\"label\" [id]=\"uid + '-primary-label'\" [nglInternalOutlet]=\"label\"></span>\n<div class=\"slds-form-element__control\">\n  <div class=\"slds-file-selector slds-file-selector_files\">\n    <div class=\"slds-file-selector__dropzone\" [class.slds-has-drag-over]=\"isDragOver\" (dragover)=\"onDropZone($event)\" (dragleave)=\"onDropZone($event)\" (drop)=\"onDropZone($event)\">\n      <input class=\"slds-file-selector__input slds-assistive-text\" type=\"file\" [id]=\"uid\" [attr.accept]=\"accept\" [disabled]=\"disabled\" [multiple]=\"maxFiles !== 1\" [attr.aria-describedby]=\"error ? uid + '-error' : null\" [attr.aria-labelledby]=\"uid + '-primary-label ' + uid + '-secondary-label'\" (change)=\"onInputChange($event.target.files)\">\n      <label class=\"slds-file-selector__body\" [attr.for]=\"uid\" [id]=\"uid + '-secondary-label'\"><span class=\"slds-file-selector__button slds-button slds-button_neutral\">\n          <svg class=\"slds-button__icon slds-button__icon_left\" nglIconName=\"utility:upload\"></svg>{{ uploadButtonLabel }}</span><span class=\"slds-file-selector__text slds-medium-show\">{{ dropZoneLabel }}</span></label>\n    </div>\n  </div>\n</div>\n<div class=\"slds-form-element__help\" *ngIf=\"error\" [id]=\"uid + '-error'\" [nglInternalOutlet]=\"error\"></div>",
            providers: [
                {
                    provide: NG_VALUE_ACCESSOR,
                    useExisting: NglFileUpload_1,
                    multi: true
                },
                {
                    provide: NG_VALIDATORS,
                    useExisting: NglFileUpload_1,
                    multi: true
                }
            ]
        }),
        __metadata("design:paramtypes", [ElementRef, Renderer2])
    ], NglFileUpload);
    return NglFileUpload;
}());
export { NglFileUpload };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZS11cGxvYWQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZy1saWdodG5pbmcvIiwic291cmNlcyI6WyJsaWIvZmlsZS11cGxvYWQvZmlsZS11cGxvYWQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLHVCQUF1QixFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsV0FBVyxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsYUFBYSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JKLE9BQU8sRUFBRSxpQkFBaUIsRUFBd0IsYUFBYSxFQUFnRCxNQUFNLGdCQUFnQixDQUFDO0FBQ3RJLE9BQU8sRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ25ELE9BQU8sRUFBRSxZQUFZLEVBQUUsV0FBVyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDNUQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFtQnhEO0lBaURFLHVCQUFvQixPQUFtQixFQUFVLFFBQW1CO1FBQWhELFlBQU8sR0FBUCxPQUFPLENBQVk7UUFBVSxhQUFRLEdBQVIsUUFBUSxDQUFXO1FBMUNwRTs7V0FFRztRQUNNLFdBQU0sR0FBc0IsSUFBSSxDQUFDO1FBRTFDOztXQUVHO1FBQ3NCLGFBQVEsR0FBRyxLQUFLLENBQUM7UUFFMUM7O1lBRUk7UUFDb0IsYUFBUSxHQUFHLENBQUMsQ0FBQztRQUVyQzs7V0FFRztRQUNxQixnQkFBVyxHQUFHLENBQUMsQ0FBQztRQUV4Qzs7V0FFRztRQUVNLFVBQUssR0FBOEIsSUFBSSxDQUFDO1FBRWpEOztXQUVHO1FBQ00sc0JBQWlCLEdBQUcsY0FBYyxDQUFDO1FBRTVDOztXQUVHO1FBQ00sa0JBQWEsR0FBRyxlQUFlLENBQUM7UUFFekMsUUFBRyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUU5QixlQUFVLEdBQUcsS0FBSyxDQUFDO1FBRW5CLFVB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WSxhQUFhIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBJbnB1dCwgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksIEVsZW1lbnRSZWYsIFJlbmRlcmVyMiwgVGVtcGxhdGVSZWYsIEhvc3RCaW5kaW5nLCBPbkNoYW5nZXMsIFNpbXBsZUNoYW5nZXMgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE5HX1ZBTFVFX0FDQ0VTU09SLCBDb250cm9sVmFsdWVBY2Nlc3NvciwgTkdfVkFMSURBVE9SUywgVmFsaWRhdG9yLCBBYnN0cmFjdENvbnRyb2wsIFZhbGlkYXRpb25FcnJvcnMgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQgeyB0cmFwRXZlbnQsIHVuaXF1ZUlkIH0gZnJvbSAnLi4vdXRpbC91dGlsJztcbmltcG9ydCB7IElucHV0Qm9vbGVhbiwgSW5wdXROdW1iZXIgfSBmcm9tICcuLi91dGlsL2NvbnZlcnQnO1xuaW1wb3J0IHsgaXNGaWxlVHlwZUFjY2VwdGVkIH0gZnJvbSAnLi9maWxlLXVwbG9hZC51dGlsJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnbmdsLWZpbGUtdXBsb2FkJyxcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2gsXG4gIHRlbXBsYXRlVXJsOiAnLi9maWxlLXVwbG9hZC5odG1sJyxcbiAgcHJvdmlkZXJzOiBbXG4gICAge1xuICAgICAgcHJvdmlkZTogTkdfVkFMVUVfQUNDRVNTT1IsXG4gICAgICB1c2VFeGlzdGluZzogTmdsRmlsZVVwbG9hZCxcbiAgICAgIG11bHRpOiB0cnVlXG4gICAgfSxcbiAgICB7XG4gICAgICBwcm92aWRlOiBOR19WQUxJREFUT1JTLFxuICAgICAgdXNlRXhpc3Rpbmc6IE5nbEZpbGVVcGxvYWQsXG4gICAgICBtdWx0aTogdHJ1ZVxuICAgIH1cbiAgXSxcbn0pXG5leHBvcnQgY2xhc3MgTmdsRmlsZVVwbG9hZCBpbXBsZW1lbnRzIENvbnRyb2xWYWx1ZUFjY2Vzc29yLCBWYWxpZGF0b3IsIE9uQ2hhbmdlcyB7XG5cbiAgLyoqXG4gICAqIExhYmVsIHRoYXQgYXBwZWFycyBhYm92ZSB0aGUgdXBsb2FkIGFyZWEuXG4gICAqL1xuICBASW5wdXQoKSBsYWJlbDogc3RyaW5nIHwgVGVtcGxhdGVSZWY8YW55PjtcblxuICAvKipcbiAgICogRmlsZSB0eXBlcyB0aGF0IGNhbiBiZSBhY2NlcHRlZC4gU2VlIFtpbnB1dCBhY2NlcHQgQXR0cmlidXRlXShodHRwczovL3d3dy53M3NjaG9vbHMuY29tL3RhZ3MvYXR0X2lucHV0X2FjY2VwdC5hc3ApLlxuICAgKi9cbiAgQElucHV0KCkgYWNjZXB0OiBzdHJpbmcgfCBzdHJpbmdbXSA9IG51bGw7XG5cbiAgLyoqXG4gICAqIFdoZXRoZXIgZmlsZSBzZWxlY3Rpb24gaXMgZGlzYWJsZWQuXG4gICAqL1xuICBASW5wdXQoKSBASW5wdXRCb29sZWFuKCkgZGlzYWJsZWQgPSBmYWxzZTtcblxuICAvKipcbiAgICAqIEhvdyBtYW55IGZpbGVzIGNhbiBiZSBzZWxlY3RlZCBzaW11bHRhbmVvdXNseS4gYDBgIG1lYW5zIHVubGltaXRlZC5cbiAgICAqL1xuICBASW5wdXQoKSBASW5wdXROdW1iZXIoKSBtYXhGaWxlcyA9IDE7XG5cbiAgLyoqXG4gICAqIEZpbGUgc2l6ZSBsaW1pdCBpbiBieXRlcy4gYDBgIG1lYW5zIHVubGltaXRlZC5cbiAgICovXG4gIEBJbnB1dCgpIEBJbnB1dE51bWJlcigpIG1heEZpbGVzaXplID0gMDtcblxuICAvKipcbiAgICogTWVzc2FnZSB0byBkaXNwbGF5IHdoZW4gdGhlcmUgaXMgaW4gYW4gZXJyb3Igc3RhdGUuXG4gICAqL1xuICBASG9zdEJpbmRpbmcoJ2NsYXNzLnNsZHMtaGFzLWVycm9yJylcbiAgQElucHV0KCkgZXJyb3I6IHN0cmluZyB8IFRlbXBsYXRlUmVmPGFueT4gPSBudWxsO1xuXG4gIC8qKlxuICAgKiBUZXh0IGZvciBidXR0b24gdG8gb3BlbiBmaWxlIHNlbGVjdG9yLlxuICAgKi9cbiAgQElucHV0KCkgdXBsb2FkQnV0dG9uTGFiZWwgPSAnVXBsb2FkIEZpbGVzJztcblxuICAvKipcbiAgICogVGV4dCB0byBkaXNwbGF5IGluc2lkZSBkcm9wIHpvbmUuXG4gICAqL1xuICBASW5wdXQoKSBkcm9wWm9uZUxhYmVsID0gJ29yIERyb3AgRmlsZXMnO1xuXG4gIHVpZCA9IHVuaXF1ZUlkKCdmaWxlLXVwbG9hZCcpO1xuXG4gIGlzRHJhZ092ZXIgPSBmYWxzZTtcblxuICBmaWxlczogRmlsZVtdID0gW107XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBlbGVtZW50OiBFbGVtZW50UmVmLCBwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIpIHtcbiAgICB0aGlzLnJlbmRlcmVyLmFkZENsYXNzKHRoaXMuZWxlbWVudC5uYXRpdmVFbGVtZW50LCAnc2xkcy1mb3JtLWVsZW1lbnQnKTtcbiAgfVxuXG4gIG9uQ2hhbmdlOiBGdW5jdGlvbiB8IG51bGwgPSBudWxsO1xuXG4gIG9uVG91Y2hlZCA9ICgpID0+IHt9O1xuXG4gIHZhbGlkYXRvckNoYW5nZSA9ICgpID0+IHt9O1xuXG4gIHdyaXRlVmFsdWUodmFsdWU6IEZpbGVbXSkge1xuICAgIHRoaXMuZmlsZXMgPSB2YWx1ZTtcbiAgfVxuXG4gIHJlZ2lzdGVyT25DaGFuZ2UoZm46ICh2YWx1ZTogYW55KSA9PiBhbnkpOiB2b2lkIHsgdGhpcy5vbkNoYW5nZSA9IGZuOyB9XG5cbiAgcmVnaXN0ZXJPblRvdWNoZWQoZm46ICgpID0+IGFueSk6IHZvaWQgeyB0aGlzLm9uVG91Y2hlZCA9IGZuOyB9XG5cbiAgcmVnaXN0ZXJPblZhbGlkYXRvckNoYW5nZShmbjogKCkgPT4gdm9pZCk6IHZvaWQgeyB0aGlzLnZhbGlkYXRvckNoYW5nZSA9IGZuOyB9XG5cbiAgc2V0RGlzYWJsZWRTdGF0ZShpc0Rpc2FibGVkOiBib29sZWFuKSB7IHRoaXMuZGlzYWJsZWQgPSBpc0Rpc2FibGVkOyB9XG5cbiAgdmFsaWRhdGUoYzogQWJzdHJhY3RDb250cm9sKTogVmFsaWRhdGlvbkVycm9ycyB8IG51bGwge1xuICAgIGNvbnN0IGZpbGVzID0gYy52YWx1ZSBhcyBGaWxlW107XG5cbiAgICBpZiAoIWZpbGVzIHx8IGZpbGVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMubWF4RmlsZXMgPiAwICYmIGZpbGVzLmxlbmd0aCA+IHRoaXMubWF4RmlsZXMpIHtcbiAgICAgIHJldHVybiB7IG5nbEZpbGVVcGxvYWQ6IHsgbWF4RmlsZXM6IGZpbGVzLmxlbmd0aCB9IH07XG4gICAgfVxuXG4gICAgZm9yIChsZXQgaSA9IDAsIG4gPSBmaWxlcy5sZW5ndGg7IGkgPCBuOyBpKyspIHtcbiAgICAgIGNvbnN0IGZpbGUgPSBmaWxlc1tpXTtcbiAgICAgIGlmICh0aGlzLmFjY2VwdCAmJiAhaXNGaWxlVHlwZUFjY2VwdGVkKHRoaXMuYWNjZXB0LCBmaWxlKSkge1xuICAgICAgICByZXR1cm4geyBuZ2xGaWxlVXBsb2FkOiB7IGludmFsaWRUeXBlOiBmaWxlIH0gfTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLm1heEZpbGVzaXplICYmIGZpbGUuc2l6ZSA+IHRoaXMubWF4RmlsZXNpemUpIHtcbiAgICAgICAgcmV0dXJuIHsgbmdsRmlsZVVwbG9hZDogeyBtYXhGaWxlc2l6ZTogZmlsZSB9IH07XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XG4gICAgaWYgKGNoYW5nZXNbJ21heEZpbGVzJ10gfHwgY2hhbmdlc1snbWF4RmlsZXNpemUnXSB8fCBjaGFuZ2VzWydhY2NlcHQnXSkge1xuICAgICAgdGhpcy52YWxpZGF0b3JDaGFuZ2UoKTtcbiAgICB9XG4gIH1cblxuICBvbkRyb3Bab25lKGV2dDogRHJhZ0V2ZW50KSB7XG4gICAgdHJhcEV2ZW50KGV2dCk7XG4gICAgaWYgKHRoaXMuZGlzYWJsZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLmlzRHJhZ092ZXIgPSBldnQudHlwZSA9PT0gJ2RyYWdvdmVyJztcblxuICAgIGlmIChldnQudHlwZSA9PT0gJ2Ryb3AnICYmIGV2dC5kYXRhVHJhbnNmZXIpIHtcbiAgICAgIHRoaXMuc2VsZWN0KGV2dC5kYXRhVHJhbnNmZXIuZmlsZXMpO1xuICAgIH1cbiAgfVxuXG4gIG9uSW5wdXRDaGFuZ2UoZmlsZXM6IEZpbGVMaXN0KSB7XG4gICAgdGhpcy5zZWxlY3QoZmlsZXMpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZWxlY3QoZmlsZXM6IEZpbGVMaXN0KSB7XG4gICAgdGhpcy5vbkNoYW5nZShBcnJheS5mcm9tKGZpbGVzKSk7XG4gIH1cbn1cbiJdfQ==