import { __decorate, __metadata } from "tslib";
import { Directive, ElementRef, Renderer2, HostListener, HostBinding } from '@angular/core';
import { uniqueId, trapEvent } from '../util/util';
import { DOWN_ARROW, ENTER, ESCAPE } from '@angular/cdk/keycodes';
import { fromEvent } from 'rxjs';
import { buffer, debounceTime, map } from 'rxjs/operators';
import { NglComboboxService } from './combobox.service';
var MAX_INTERVAL_BETWEEN_KEYSTROKES = 300; // ms
var NglComboboxInput = /** @class */ (function () {
    function NglComboboxInput(service, el, renderer) {
        this.service = service;
        this.el = el;
        this.renderer = renderer;
        var nativeElement = this.el.nativeElement;
        this.renderer.addClass(nativeElement, 'slds-input');
        this.renderer.addClass(nativeElement, 'slds-combobox__input');
        this.renderer.setAttribute(nativeElement, 'autoComplete', 'off');
        this.renderer.setAttribute(nativeElement, 'role', 'textbox');
        this.renderer.setAttribute(nativeElement, 'aria-controls', this.service.combobox.uid);
        if (!nativeElement.id) {
            this.renderer.setAttribute(nativeElement, 'id', uniqueId('combobox-input'));
        }
        var keyboardEvent$ = fromEvent(nativeElement, 'keypress').pipe(map(function (e) { return e.keyCode; }));
        this.keyboardBuffer$ = keyboardEvent$.pipe(buffer(keyboardEvent$.pipe(debounceTime(MAX_INTERVAL_BETWEEN_KEYSTROKES))), map(function (keyCodes) { return keyCodes.map(function (c) { return String.fromCharCode(c); }).join(''); }));
    }
    Object.defineProperty(NglComboboxInput.prototype, "isReadonly", {
        get: function () {
            return this.service.combobox.variant === 'base' || this.service.combobox.hasLookupSingleSelection;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NglComboboxInput.prototype, "ariaAutocomplete", {
        get: function () {
            return this.service.combobox.isLookup ? 'list' : null;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NglComboboxInput.prototype, "hasReadonlyValue", {
        get: function () {
            return this.service.combobox.hasLookupSingleSelection;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NglComboboxInput.prototype, "id", {
        get: function () {
            return this.el.nativeElement.id;
        },
        enumerable: true,
        configurable: true
    });
    NglComboboxInput.prototype.setAriaActiveDescendant = function (uid) {
        if (uid) {
            this.renderer.setAttribute(this.el.nativeElement, 'aria-activedescendant', uid);
        }
        else {
            this.renderer.removeAttribute(this.el.nativeElement, 'aria-activedescendant');
        }
    };
    NglComboboxInput.prototype.setValue = function (value) {
        this.renderer.setProperty(this.el.nativeElement, 'value', value !== null ? value : '');
    };
    NglComboboxInput.prototype.focus = function () {
        this.el.nativeElement.focus();
    };
    NglComboboxInput.prototype.onMouseInteraction = function () {
        if (this.service.combobox.hasLookupSingleSelection || (this.service.combobox.open && this.service.combobox.isLookup)) {
            return;
        }
        this.service.combobox.openChange.emit(!this.service.combobox.open);
    };
    NglComboboxInput.prototype.onBlur = function () {
        this.service.combobox.openChange.emit(false);
    };
    NglComboboxInput.prototype.onKeyboard = function (evt) {
        var _this = this;
        var keyCode = evt.keyCode;
        if (keyCode === ESCAPE) {
            // This is handled by CDK, and detaches overlay
            return;
        }
        if (this.service.combobox.open) {
            switch (keyCode) {
                // User selects currently active option by pressing the `Enter` key
                case ENTER:
                    trapEvent(evt);
                    this.service.combobox.onOptionSelection();
                    return;
                // Propagate to keymanager
                default:
                    this.service.combobox.keyManager.onKeydown(evt);
                    return;
            }
        }
        else {
            // Do nothing if readonly Lookup
            if (this.service.combobox.hasLookupSingleSelection) {
                return;
            }
            // Pressing the `Down` or `Enter` key will expand the collapsed menu
            if (keyCode === DOWN_ARROW || keyCode === ENTER) {
                trapEvent(evt);
                this.service.combobox.openChange.emit(true);
                return;
            }
            // Any key on Lookup should expand the collapsed menu
            if (this.service.combobox.isLookup) {
                // Delay emission so actual value of the input has been updated
                setTimeout(function () { return _this.service.combobox.openChange.emit(true); }, 0);
            }
        }
    };
    NglComboboxInput.ctorParameters = function () { return [
        { type: NglComboboxService },
        { type: ElementRef },
        { type: Renderer2 }
    ]; };
    __decorate([
        HostBinding('readOnly'),
        __metadata("design:type", Object),
        __metadata("design:paramtypes", [])
    ], NglComboboxInput.prototype, "isReadonly", null);
    __decorate([
        HostBinding('attr.aria-autocomplete'),
        __metadata("design:type", Object),
        __metadata("design:paramtypes", [])
    ], NglComboboxInput.prototype, "ariaAutocomplete", null);
    __decorate([
        HostBinding('class.slds-combobox__input-value'),
        __metadata("design:type", Object),
        __metadata("design:paramtypes", [])
    ], NglComboboxInput.prototype, "hasReadonlyValue", null);
    __decorate([
        HostListener('click'),
        __metadata("design:type", Function),
        __metadata("design:paramtypes", []),
        __metadata("design:returntype", void 0)
    ], NglComboboxInput.prototype, "onMouseInteraction", null);
    __decorate([
        HostListener('blur'),
        __metadata("design:type", Function),
        __metadata("design:paramtypes", []),
        __metadata("design:returntype", void 0)
    ], NglComboboxInput.prototype, "onBlur", null);
    __decorate([
        HostListener('keydown', ['$event']),
        __metadata("design:type", Function),
        __metadata("design:paramtypes", [KeyboardEvent]),
        __metadata("design:returntype", void 0)
    ], NglComboboxInput.prototype, "onKeyboard", null);
    NglComboboxInput = __decorate([
        Directive({
            selector: 'input[nglCombobox]',
        }),
        __metadata("design:paramtypes", [NglComboboxService,
            ElementRef,
            Renderer2])
    ], NglComboboxInput);
    return NglComboboxInput;
}());
export { NglComboboxInput };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tYm9ib3gtaW5wdXQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZy1saWdodG5pbmcvIiwic291cmNlcyI6WyJsaWIvY29tYm9ib3hlcy9jb21ib2JveC1pbnB1dC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDNUYsT0FBTyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDbkQsT0FBTyxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDbEUsT0FBTyxFQUFjLFNBQVMsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM3QyxPQUFPLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUV4RCxJQUFNLCtCQUErQixHQUFHLEdBQUcsQ0FBQyxDQUFDLEtBQUs7QUFLbEQ7SUF1QkUsMEJBQW9CLE9BQTJCLEVBQzNCLEVBQWMsRUFDZCxRQUFtQjtRQUZuQixZQUFPLEdBQVAsT0FBTyxDQUFvQjtRQUMzQixPQUFFLEdBQUYsRUFBRSxDQUFZO1FBQ2QsYUFBUSxHQUFSLFFBQVEsQ0FBVztRQUM3QixJQUFBLHFDQUFhLENBQWE7UUFDbEMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsYUFBYSxFQUFFLFlBQVksQ0FBQyxDQUFDO1FBQ3BELElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLGFBQWEsRUFBRSxzQkFBc0IsQ0FBQyxDQUFDO1FBQzlELElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLGFBQWEsRUFBRSxjQUFjLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDakUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZ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ZixJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUM1QyxPQUFPO2FBQ1I7WUFFRCxxREFBcUQ7WUFDckQsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUU7Z0JBQ2xDLCtEQUErRDtnQkFDL0QsVUFBVSxDQUFDLGNBQU0sT0FBQSxLQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUEzQyxDQUEyQyxFQUFFLENBQUMsQ0FBQyxDQUFDO2FBQ2xFO1NBQ0Y7SUFDSCxDQUFDOztnQkEzRjRCLGtCQUFrQjtnQkFDdkIsVUFBVTtnQkFDSixTQUFTOztJQXBCdkM7UUFEQyxXQUFXLENBQUMsVUFBVSxDQUFDOzs7c0RBR3ZCO0lBR0Q7UUFEQyxXQUFXLENBQUMsd0JBQXdCLENBQUM7Ozs0REFHckM7SUFHRDtRQURDLFdBQVcsQ0FBQyxrQ0FBa0MsQ0FBQzs7OzREQUcvQztJQTJDRDtRQURDLFlBQVksQ0FBQyxPQUFPLENBQUM7Ozs7OERBTXJCO0lBR0Q7UUFEQyxZQUFZLENBQUMsTUFBTSxDQUFDOzs7O2tEQUdwQjtJQUdEO1FBREMsWUFBWSxDQUFDLFNBQVMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDOzt5Q0FDcEIsYUFBYTs7c0RBeUM1QjtJQWxIVSxnQkFBZ0I7UUFINUIsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLG9CQUFvQjtTQUMvQixDQUFDO3lDQXdCNkIsa0JBQWtCO1lBQ3ZCLFVBQVU7WUFDSixTQUFTO09BekI1QixnQkFBZ0IsQ0FvSDVCO0lBQUQsdUJBQUM7Q0FBQSxBQXBIRCxJQW9IQztTQXBIWSxnQkFBZ0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEaXJlY3RpdmUsIEVsZW1lbnRSZWYsIFJlbmRlcmVyMiwgSG9zdExpc3RlbmVyLCBIb3N0QmluZGluZyB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgdW5pcXVlSWQsIHRyYXBFdmVudCB9IGZyb20gJy4uL3V0aWwvdXRpbCc7XG5pbXBvcnQgeyBET1dOX0FSUk9XLCBFTlRFUiwgRVNDQVBFIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL2tleWNvZGVzJztcbmltcG9ydCB7IE9ic2VydmFibGUsIGZyb21FdmVudCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgYnVmZmVyLCBkZWJvdW5jZVRpbWUsIG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IE5nbENvbWJvYm94U2VydmljZSB9IGZyb20gJy4vY29tYm9ib3guc2VydmljZSc7XG5cbmNvbnN0IE1BWF9JTlRFUlZBTF9CRVRXRUVOX0tFWVNUUk9LRVMgPSAzMDA7IC8vIG1zXG5cbkBEaXJlY3RpdmUoe1xuICBzZWxlY3RvcjogJ2lucHV0W25nbENvbWJvYm94XScsXG59KVxuZXhwb3J0IGNsYXNzIE5nbENvbWJvYm94SW5wdXQge1xuXG4gIGtleWJvYXJkQnVmZmVyJDogT2JzZXJ2YWJsZTxzdHJpbmc+O1xuXG4gIEBIb3N0QmluZGluZygncmVhZE9ubHknKVxuICBnZXQgaXNSZWFkb25seSgpIHtcbiAgICByZXR1cm4gdGhpcy5zZXJ2aWNlLmNvbWJvYm94LnZhcmlhbnQgPT09ICdiYXNlJyB8fCB0aGlzLnNlcnZpY2UuY29tYm9ib3guaGFzTG9va3VwU2luZ2xlU2VsZWN0aW9uO1xuICB9XG5cbiAgQEhvc3RCaW5kaW5nKCdhdHRyLmFyaWEtYXV0b2NvbXBsZXRlJylcbiAgZ2V0IGFyaWFBdXRvY29tcGxldGUoKSB7XG4gICAgcmV0dXJuIHRoaXMuc2VydmljZS5jb21ib2JveC5pc0xvb2t1cCA/ICdsaXN0JyA6IG51bGw7XG4gIH1cblxuICBASG9zdEJpbmRpbmcoJ2NsYXNzLnNsZHMtY29tYm9ib3hfX2lucHV0LXZhbHVlJylcbiAgZ2V0IGhhc1JlYWRvbmx5VmFsdWUoKSB7XG4gICAgcmV0dXJuIHRoaXMuc2VydmljZS5jb21ib2JveC5oYXNMb29rdXBTaW5nbGVTZWxlY3Rpb247XG4gIH1cblxuICBnZXQgaWQoKSB7XG4gICAgcmV0dXJuIHRoaXMuZWwubmF0aXZlRWxlbWVudC5pZDtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgc2VydmljZTogTmdsQ29tYm9ib3hTZXJ2aWNlLFxuICAgICAgICAgICAgICBwcml2YXRlIGVsOiBFbGVtZW50UmVmLFxuICAgICAgICAgICAgICBwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIpIHtcbiAgICBjb25zdCB7IG5hdGl2ZUVsZW1lbnQgfSA9IHRoaXMuZWw7XG4gICAgdGhpcy5yZW5kZXJlci5hZGRDbGFzcyhuYXRpdmVFbGVtZW50LCAnc2xkcy1pbnB1dCcpO1xuICAgIHRoaXMucmVuZGVyZXIuYWRkQ2xhc3MobmF0aXZlRWxlbWVudCwgJ3NsZHMtY29tYm9ib3hfX2lucHV0Jyk7XG4gICAgdGhpcy5yZW5kZXJlci5zZXRBdHRyaWJ1dGUobmF0aXZlRWxlbWVudCwgJ2F1dG9Db21wbGV0ZScsICdvZmYnKTtcbiAgICB0aGlzLnJlbmRlcmVyLnNldEF0dHJpYnV0ZShuYXRpdmVFbGVtZW50LCAncm9sZScsICd0ZXh0Ym94Jyk7XG4gICAgdGhpcy5yZW5kZXJlci5zZXRBdHRyaWJ1dGUobmF0aXZlRWxlbWVudCwgJ2FyaWEtY29udHJvbHMnLCB0aGlzLnNlcnZpY2UuY29tYm9ib3gudWlkKTtcbiAgICBpZiAoIW5hdGl2ZUVsZW1lbnQuaWQpIHtcbiAgICAgIHRoaXMucmVuZGVyZXIuc2V0QXR0cmlidXRlKG5hdGl2ZUVsZW1lbnQsICdpZCcsIHVuaXF1ZUlkKCdjb21ib2JveC1pbnB1dCcpKTtcbiAgICB9XG5cbiAgICBjb25zdCBrZXlib2FyZEV2ZW50JCA9IGZyb21FdmVudChuYXRpdmVFbGVtZW50LCAna2V5cHJlc3MnKS5waXBlKG1hcCgoZTogS2V5Ym9hcmRFdmVudCkgPT4gZS5rZXlDb2RlKSk7XG4gICAgdGhpcy5rZXlib2FyZEJ1ZmZlciQgPSBrZXlib2FyZEV2ZW50JC5waXBlKFxuICAgICAgYnVmZmVyKGtleWJvYXJkRXZlbnQkLnBpcGUoZGVib3VuY2VUaW1lKE1BWF9JTlRFUlZBTF9CRVRXRUVOX0tFWVNUUk9LRVMpKSksXG4gICAgICBtYXAoKGtleUNvZGVzOiBudW1iZXJbXSkgPT4ga2V5Q29kZXMubWFwKChjKSA9PiBTdHJpbmcuZnJvbUNoYXJDb2RlKGMpKS5qb2luKCcnKSlcbiAgICApO1xuICB9XG5cbiAgc2V0QXJpYUFjdGl2ZURlc2NlbmRhbnQodWlkOiBzdHJpbmcgfCBudWxsKSB7XG4gICAgaWYgKHVpZCkge1xuICAgICAgdGhpcy5yZW5kZXJlci5zZXRBdHRyaWJ1dGUodGhpcy5lbC5uYXRpdmVFbGVtZW50LCAnYXJpYS1hY3RpdmVkZXNjZW5kYW50JywgdWlkKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5yZW5kZXJlci5yZW1vdmVBdHRyaWJ1dGUodGhpcy5lbC5uYXRpdmVFbGVtZW50LCAnYXJpYS1hY3RpdmVkZXNjZW5kYW50Jyk7XG4gICAgfVxuICB9XG5cbiAgc2V0VmFsdWUodmFsdWU6IGFueSk6IHZvaWQge1xuICAgIHRoaXMucmVuZGVyZXIuc2V0UHJvcGVydHkodGhpcy5lbC5uYXRpdmVFbGVtZW50LCAndmFsdWUnLCB2YWx1ZSAhPT0gbnVsbCA/IHZhbHVlIDogJycpO1xuICB9XG5cbiAgZm9jdXMoKSB7XG4gICAgdGhpcy5lbC5uYXRpdmVFbGVtZW50LmZvY3VzKCk7XG4gIH1cblxuICBASG9zdExpc3RlbmVyKCdjbGljaycpXG4gIG9uTW91c2VJbnRlcmFjdGlvbigpIHtcbiAgICBpZiAodGhpcy5zZXJ2aWNlLmNvbWJvYm94Lmhhc0xvb2t1cFNpbmdsZVNlbGVjdGlvbiB8fCAodGhpcy5zZXJ2aWNlLmNvbWJvYm94Lm9wZW4gJiYgdGhpcy5zZXJ2aWNlLmNvbWJvYm94LmlzTG9va3VwKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLnNlcnZpY2UuY29tYm9ib3gub3BlbkNoYW5nZS5lbWl0KCF0aGlzLnNlcnZpY2UuY29tYm9ib3gub3Blbik7XG4gIH1cblxuICBASG9zdExpc3RlbmVyKCdibHVyJylcbiAgb25CbHVyKCkge1xuICAgIHRoaXMuc2VydmljZS5jb21ib2JveC5vcGVuQ2hhbmdlLmVtaXQoZmFsc2UpO1xuICB9XG5cbiAgQEhvc3RMaXN0ZW5lcigna2V5ZG93bicsIFsnJGV2ZW50J10pXG4gIG9uS2V5Ym9hcmQoZXZ0OiBLZXlib2FyZEV2ZW50KSB7XG4gICAgY29uc3Qga2V5Q29kZSA9IGV2dC5rZXlDb2RlO1xuXG4gICAgaWYgKGtleUNvZGUgPT09IEVTQ0FQRSkge1xuICAgICAgLy8gVGhpcyBpcyBoYW5kbGVkIGJ5IENESywgYW5kIGRldGFjaGVzIG92ZXJsYXlcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5zZXJ2aWNlLmNvbWJvYm94Lm9wZW4pIHtcbiAgICAgIHN3aXRjaCAoa2V5Q29kZSkge1xuICAgICAgICAvLyBVc2VyIHNlbGVjdHMgY3VycmVudGx5IGFjdGl2ZSBvcHRpb24gYnkgcHJlc3NpbmcgdGhlIGBFbnRlcmAga2V5XG4gICAgICAgIGNhc2UgRU5URVI6XG4gICAgICAgICAgdHJhcEV2ZW50KGV2dCk7XG4gICAgICAgICAgdGhpcy5zZXJ2aWNlLmNvbWJvYm94Lm9uT3B0aW9uU2VsZWN0aW9uKCk7XG4gICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIC8vIFByb3BhZ2F0ZSB0byBrZXltYW5hZ2VyXG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgdGhpcy5zZXJ2aWNlLmNvbWJvYm94LmtleU1hbmFnZXIub25LZXlkb3duKGV2dCk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG5cbiAgICAgIC8vIERvIG5vdGhpbmcgaWYgcmVhZG9ubHkgTG9va3VwXG4gICAgICBpZiAodGhpcy5zZXJ2aWNlLmNvbWJvYm94Lmhhc0xvb2t1cFNpbmdsZVNlbGVjdGlvbikge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIC8vIFByZXNzaW5nIHRoZSBgRG93bmAgb3IgYEVudGVyYCBrZXkgd2lsbCBleHBhbmQgdGhlIGNvbGxhcHNlZCBtZW51XG4gICAgICBpZiAoa2V5Q29kZSA9PT0gRE9XTl9BUlJPVyB8fCBrZXlDb2RlID09PSBFTlRFUikge1xuICAgICAgICB0cmFwRXZlbnQoZXZ0KTtcbiAgICAgICAgdGhpcy5zZXJ2aWNlLmNvbWJvYm94Lm9wZW5DaGFuZ2UuZW1pdCh0cnVlKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICAvLyBBbnkga2V5IG9uIExvb2t1cCBzaG91bGQgZXhwYW5kIHRoZSBjb2xsYXBzZWQgbWVudVxuICAgICAgaWYgKHRoaXMuc2VydmljZS5jb21ib2JveC5pc0xvb2t1cCkge1xuICAgICAgICAvLyBEZWxheSBlbWlzc2lvbiBzbyBhY3R1YWwgdmFsdWUgb2YgdGhlIGlucHV0IGhhcyBiZWVuIHVwZGF0ZWRcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLnNlcnZpY2UuY29tYm9ib3gub3BlbkNoYW5nZS5lbWl0KHRydWUpLCAwKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxufVxuIl19