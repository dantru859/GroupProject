import { __decorate, __metadata } from "tslib";
import { Directive, Input, Output, EventEmitter, HostListener, ElementRef, OnInit, OnDestroy, ContentChildren, QueryList, Renderer2 } from '@angular/core';
import { toBoolean, InputBoolean } from '../util/convert';
import { NglDropdownItem } from './dropdown-item';
var openEventEmitter = new EventEmitter();
var NglDropdown = /** @class */ (function () {
    function NglDropdown(element, renderer) {
        this.element = element;
        this.renderer = renderer;
        this.handlePageEvents = true;
        this.isOpenChange = new EventEmitter();
        this.triggerFocusEventEmitter = new EventEmitter();
        this._isOpen = false;
        this.globalClickEventUnsubscriber = null;
        this.clickEventUnsubscriber = null;
    }
    Object.defineProperty(NglDropdown.prototype, "isOpen", {
        get: function () {
            return this._isOpen;
        },
        set: function (isOpen) {
            var _this = this;
            this._isOpen = toBoolean(isOpen);
            if (this.isOpen) {
                this.clearGlobalClickTimeout();
                this.globalClickTimeout = setTimeout(function () {
                    if (_this.handlePageEvents) {
                        _this._subscribeToClickEvents();
                    }
                });
                this.renderer.addClass(this.element.nativeElement, 'slds-is-open');
            }
            else {
                this._unsubscribeFromClickEvents();
                this.renderer.removeClass(this.element.nativeElement, 'slds-is-open');
            }
            this.renderer.setAttribute(this.element.nativeElement, 'aria-expanded', "" + this.isOpen);
        },
        enumerable: true,
        configurable: true
    });
    NglDropdown.prototype.onKeydownClose = function (eventName) {
        this.toggle(false);
        if (eventName === 'esc') {
            this.triggerFocusEventEmitter.emit(null);
        }
    };
    NglDropdown.prototype.onKeydownFocusNext = function ($event, direction) {
        $event.preventDefault();
        this.focusItem(direction);
    };
    NglDropdown.prototype.ngOnInit = function () {
        this.openEventSubscription = openEventEmitter.subscribe(this.handleDropdownOpenEvent.bind(this));
    };
    NglDropdown.prototype.ngOnDestroy = function () {
        this.clearGlobalClickTimeout();
        if (this.openEventSubscription) {
            this.openEventSubscription.unsubscribe();
        }
        this._unsubscribeFromClickEvents();
    };
    NglDropdown.prototype.toggle = function (toggle, focus) {
        if (toggle === void 0) { toggle = !this.isOpen; }
        if (focus === void 0) { focus = false; }
        if (toggle === this.isOpen) {
            return;
        }
        this.isOpenChange.emit(toggle);
        if (toggle) {
            openEventEmitter.emit(this);
            if (focus) {
                this.focusItem('next');
            }
        }
    };
    NglDropdown.prototype.handleGlobalClickEvent = function ($event) {
        if (!this.handlePageEvents || $event.$nglStop) {
            return;
        }
        this.toggle(false);
    };
    NglDropdown.prototype._subscribeToClickEvents = function () {
        this._unsubscribeFromClickEvents();
        // Prevent document listener to close it, since click happened inside
        this.clickEventUnsubscriber = this.renderer.listen(this.element.nativeElement, 'click', function ($event) { return $event.$nglStop = true; });
        this.globalClickEventUnsubscriber = this.renderer.listen('document', 'click', this.handleGlobalClickEvent.bind(this));
    };
    NglDropdown.prototype._unsubscribeFromClickEvents = function () {
        if (this.clickEventUnsubscriber) {
            this.clickEventUnsubscriber();
            this.clickEventUnsubscriber = null;
        }
        if (this.globalClickEventUnsubscriber) {
            this.globalClickEventUnsubscriber();
            this.globalClickEventUnsubscriber = null;
        }
    };
    NglDropdown.prototype.clearGlobalClickTimeout = function () {
        clearTimeout(this.globalClickTimeout);
    };
    NglDropdown.prototype.focusItem = function (direction) {
        if (!this.items.length) {
            return;
        }
        var items = this.items.toArray();
        var activeElementIndex = items.findIndex(function (item) { return item.hasFocus(); }) + (direction === 'next' ? 1 : -1);
        if (activeElementIndex === items.length || activeElementIndex < 0) {
            return;
        }
        items[activeElementIndex].focus();
    };
    NglDropdown.prototype.handleDropdownOpenEvent = function (dropdown) {
        if (dropdown !== this) {
            this.toggle(false);
        }
    };
    NglDropdown.ctorParameters = function () { return [
        { type: ElementRef },
        { type: Renderer2 }
    ]; };
    __decorate([
        Input('open'),
        __metadata("design:type", Boolean),
        __metadata("design:paramtypes", [Boolean])
    ], NglDropdown.prototype, "isOpen", null);
    __decorate([
        Input(), InputBoolean(),
        __metadata("design:type", Object)
    ], NglDropdown.prototype, "handlePageEvents", void 0);
    __decorate([
        ContentChildren(NglDropdownItem, { descendants: true }),
        __metadata("design:type", QueryList)
    ], NglDropdown.prototype, "items", void 0);
    __decorate([
        Output('openChange'),
        __metadata("design:type", Object)
    ], NglDropdown.prototype, "isOpenChange", void 0);
    __decorate([
        HostListener('keydown.esc', ['"esc"']),
        HostListener('keydown.tab', ['"tab"']),
        __metadata("design:type", Function),
        __metadata("design:paramtypes", [String]),
        __metadata("design:returntype", void 0)
    ], NglDropdown.prototype, "onKeydownClose", null);
    __decorate([
        HostListener('keydown.arrowdown', ['$event', '"next"']),
        HostListener('keydown.arrowup', ['$event', '"previous"']),
        __metadata("design:type", Function),
        __metadata("design:paramtypes", [Event, String]),
        __metadata("design:returntype", void 0)
    ], NglDropdown.prototype, "onKeydownFocusNext", null);
    NglDropdown = __decorate([
        Directive({
            selector: '[nglDropdown]',
            host: {
                '[class.slds-dropdown-trigger]': 'true',
                '[class.slds-dropdown-trigger_click]': 'true',
            },
        }),
        __metadata("design:paramtypes", [ElementRef, Renderer2])
    ], NglDropdown);
    return NglDropdown;
}());
export { NglDropdown };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJvcGRvd24uanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZy1saWdodG5pbmcvIiwic291cmNlcyI6WyJsaWIvbWVudXMvZHJvcGRvd24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLGVBQWUsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNKLE9BQU8sRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDMUQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRWxELElBQU0sZ0JBQWdCLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztBQVNqRDtJQW1ERSxxQkFBbUIsT0FBbUIsRUFBUyxRQUFtQjtRQUEvQyxZQUFPLEdBQVAsT0FBTyxDQUFZO1FBQVMsYUFBUSxHQUFSLFFBQVEsQ0FBVztRQTNCekMscUJBQWdCLEdBQUcsSUFBSSxDQUFDO1FBRTNCLGlCQUFZLEdBQUcsSUFBSSxZQUFZLEVBQVcsQ0FBQztRQUVqRSw2QkFBd0IsR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBRXRDLFlBQU8sR0FBRyxLQUFLLENBQUM7UUFFaEIsaUNBQTRCLEdBQWEsSUFBSSxDQUFDO1FBQzlDLDJCQUFzQixHQUFhLElBQUksQ0FBQztJQWtCcUIsQ0FBQztJQWxEdkQsc0JBQUksK0JBQU07YUFtQnpCO1lBQ0UsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDO1FBQ3RCLENBQUM7YUFyQmMsVUFBVyxNQUFlO1lBQXpDLGlCQWtCQztZQWpCQyxJQUFJLENBQUMsT0FBTyxHQUFHLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUVqQyxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUU7Z0JBQ2YsSUFBSSxDQUFDLHVCQUF1QixFQUFFLENB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dExpc3RlbmVyLCBFbGVtZW50UmVmLCBPbkluaXQsIE9uRGVzdHJveSwgQ29udGVudENoaWxkcmVuLCBRdWVyeUxpc3QsIFJlbmRlcmVyMiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgdG9Cb29sZWFuLCBJbnB1dEJvb2xlYW4gfSBmcm9tICcuLi91dGlsL2NvbnZlcnQnO1xuaW1wb3J0IHsgTmdsRHJvcGRvd25JdGVtIH0gZnJvbSAnLi9kcm9wZG93bi1pdGVtJztcblxuY29uc3Qgb3BlbkV2ZW50RW1pdHRlciA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICdbbmdsRHJvcGRvd25dJyxcbiAgaG9zdDoge1xuICAgICdbY2xhc3Muc2xkcy1kcm9wZG93bi10cmlnZ2VyXSc6ICd0cnVlJyxcbiAgICAnW2NsYXNzLnNsZHMtZHJvcGRvd24tdHJpZ2dlcl9jbGlja10nOiAndHJ1ZScsXG4gIH0sXG59KVxuZXhwb3J0IGNsYXNzIE5nbERyb3Bkb3duIGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xuICBASW5wdXQoJ29wZW4nKSBzZXQgaXNPcGVuKGlzT3BlbjogYm9vbGVhbikge1xuICAgIHRoaXMuX2lzT3BlbiA9IHRvQm9vbGVhbihpc09wZW4pO1xuXG4gICAgaWYgKHRoaXMuaXNPcGVuKSB7XG4gICAgICB0aGlzLmNsZWFyR2xvYmFsQ2xpY2tUaW1lb3V0KCk7XG4gICAgICB0aGlzLmdsb2JhbENsaWNrVGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICBpZiAodGhpcy5oYW5kbGVQYWdlRXZlbnRzKSB7XG4gICAgICAgICAgdGhpcy5fc3Vic2NyaWJlVG9DbGlja0V2ZW50cygpO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgdGhpcy5yZW5kZXJlci5hZGRDbGFzcyh0aGlzLmVsZW1lbnQubmF0aXZlRWxlbWVudCwgJ3NsZHMtaXMtb3BlbicpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl91bnN1YnNjcmliZUZyb21DbGlja0V2ZW50cygpO1xuICAgICAgdGhpcy5yZW5kZXJlci5yZW1vdmVDbGFzcyh0aGlzLmVsZW1lbnQubmF0aXZlRWxlbWVudCwgJ3NsZHMtaXMtb3BlbicpO1xuICAgIH1cblxuICAgIHRoaXMucmVuZGVyZXIuc2V0QXR0cmlidXRlKHRoaXMuZWxlbWVudC5uYXRpdmVFbGVtZW50LCAnYXJpYS1leHBhbmRlZCcsIGAke3RoaXMuaXNPcGVufWApO1xuICB9XG4gIGdldCBpc09wZW4oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2lzT3BlbjtcbiAgfVxuXG4gIEBJbnB1dCgpIEBJbnB1dEJvb2xlYW4oKSBoYW5kbGVQYWdlRXZlbnRzID0gdHJ1ZTtcbiAgQENvbnRlbnRDaGlsZHJlbihOZ2xEcm9wZG93bkl0ZW0sIHtkZXNjZW5kYW50czogdHJ1ZX0pIGl0ZW1zOiBRdWVyeUxpc3Q8TmdsRHJvcGRvd25JdGVtPjtcbiAgQE91dHB1dCgnb3BlbkNoYW5nZScpIGlzT3BlbkNoYW5nZSA9IG5ldyBFdmVudEVtaXR0ZXI8Ym9vbGVhbj4oKTtcblxuICB0cmlnZ2VyRm9jdXNFdmVudEVtaXR0ZXIgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgcHJpdmF0ZSBfaXNPcGVuID0gZmFsc2U7XG4gIHByaXZhdGUgb3BlbkV2ZW50U3Vic2NyaXB0aW9uOiBhbnk7XG4gIHByaXZhdGUgZ2xvYmFsQ2xpY2tFdmVudFVuc3Vic2NyaWJlcjogRnVuY3Rpb24gPSBudWxsO1xuICBwcml2YXRlIGNsaWNrRXZlbnRVbnN1YnNjcmliZXI6IEZ1bmN0aW9uID0gbnVsbDtcbiAgcHJpdmF0ZSBnbG9iYWxDbGlja1RpbWVvdXQ6IG51bWJlcjtcblxuICBASG9zdExpc3RlbmVyKCdrZXlkb3duLmVzYycsIFsnXCJlc2NcIiddKVxuICBASG9zdExpc3RlbmVyKCdrZXlkb3duLnRhYicsIFsnXCJ0YWJcIiddKVxuICBvbktleWRvd25DbG9zZShldmVudE5hbWU6IHN0cmluZykge1xuICAgIHRoaXMudG9nZ2xlKGZhbHNlKTtcbiAgICBpZiAoZXZlbnROYW1lID09PSAnZXNjJykge1xuICAgICAgdGhpcy50cmlnZ2VyRm9jdXNFdmVudEVtaXR0ZXIuZW1pdChudWxsKTtcbiAgICB9XG4gIH1cbiAgQEhvc3RMaXN0ZW5lcigna2V5ZG93bi5hcnJvd2Rvd24nLCBbJyRldmVudCcsICdcIm5leHRcIiddKVxuICBASG9zdExpc3RlbmVyKCdrZXlkb3duLmFycm93dXAnLCBbJyRldmVudCcsICdcInByZXZpb3VzXCInXSlcbiAgb25LZXlkb3duRm9jdXNOZXh0KCRldmVudDogRXZlbnQsIGRpcmVjdGlvbjogJ25leHQnIHwgJ3ByZXZpb3VzJykge1xuICAgICRldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIHRoaXMuZm9jdXNJdGVtKGRpcmVjdGlvbik7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihwdWJsaWMgZWxlbWVudDogRWxlbWVudFJlZiwgcHVibGljIHJlbmRlcmVyOiBSZW5kZXJlcjIpIHt9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5vcGVuRXZlbnRTdWJzY3JpcHRpb24gPSBvcGVuRXZlbnRFbWl0dGVyLnN1YnNjcmliZSh0aGlzLmhhbmRsZURyb3Bkb3duT3BlbkV2ZW50LmJpbmQodGhpcykpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5jbGVhckdsb2JhbENsaWNrVGltZW91dCgpO1xuICAgIGlmICh0aGlzLm9wZW5FdmVudFN1YnNjcmlwdGlvbikge1xuICAgICAgdGhpcy5vcGVuRXZlbnRTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB9XG4gICAgdGhpcy5fdW5zdWJzY3JpYmVGcm9tQ2xpY2tFdmVudHMoKTtcbiAgfVxuXG4gIHRvZ2dsZSh0b2dnbGU6IGJvb2xlYW4gPSAhdGhpcy5pc09wZW4sIGZvY3VzOiBib29sZWFuID0gZmFsc2UpIHtcbiAgICBpZiAodG9nZ2xlID09PSB0aGlzLmlzT3Blbikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmlzT3BlbkNoYW5nZS5lbWl0KHRvZ2dsZSk7XG4gICAgaWYgKHRvZ2dsZSkge1xuICAgICAgb3BlbkV2ZW50RW1pdHRlci5lbWl0KHRoaXMpO1xuICAgICAgaWYgKGZvY3VzKSB7XG4gICAgICAgIHRoaXMuZm9jdXNJdGVtKCduZXh0Jyk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVHbG9iYWxDbGlja0V2ZW50KCRldmVudDogYW55KSB7XG4gICAgaWYgKCF0aGlzLmhhbmRsZVBhZ2VFdmVudHMgfHwgJGV2ZW50LiRuZ2xTdG9wKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMudG9nZ2xlKGZhbHNlKTtcbiAgfVxuXG4gIHByaXZhdGUgX3N1YnNjcmliZVRvQ2xpY2tFdmVudHMoKSB7XG4gICAgdGhpcy5fdW5zdWJzY3JpYmVGcm9tQ2xpY2tFdmVudHMoKTtcblxuICAgIC8vIFByZXZlbnQgZG9jdW1lbnQgbGlzdGVuZXIgdG8gY2xvc2UgaXQsIHNpbmNlIGNsaWNrIGhhcHBlbmVkIGluc2lkZVxuICAgIHRoaXMuY2xpY2tFdmVudFVuc3Vic2NyaWJlciA9IHRoaXMucmVuZGVyZXIubGlzdGVuKHRoaXMuZWxlbWVudC5uYXRpdmVFbGVtZW50LCAnY2xpY2snLCAoJGV2ZW50OiBhbnkpID0+ICRldmVudC4kbmdsU3RvcCA9IHRydWUpO1xuXG4gICAgdGhpcy5nbG9iYWxDbGlja0V2ZW50VW5zdWJzY3JpYmVyID0gdGhpcy5yZW5kZXJlci5saXN0ZW4oJ2RvY3VtZW50JywgJ2NsaWNrJywgdGhpcy5oYW5kbGVHbG9iYWxDbGlja0V2ZW50LmJpbmQodGhpcykpO1xuICB9XG5cbiAgcHJpdmF0ZSBfdW5zdWJzY3JpYmVGcm9tQ2xpY2tFdmVudHMoKSB7XG4gICAgaWYgKHRoaXMuY2xpY2tFdmVudFVuc3Vic2NyaWJlcikge1xuICAgICAgdGhpcy5jbGlja0V2ZW50VW5zdWJzY3JpYmVyKCk7XG4gICAgICB0aGlzLmNsaWNrRXZlbnRVbnN1YnNjcmliZXIgPSBudWxsO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmdsb2JhbENsaWNrRXZlbnRVbnN1YnNjcmliZXIpIHtcbiAgICAgIHRoaXMuZ2xvYmFsQ2xpY2tFdmVudFVuc3Vic2NyaWJlcigpO1xuICAgICAgdGhpcy5nbG9iYWxDbGlja0V2ZW50VW5zdWJzY3JpYmVyID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNsZWFyR2xvYmFsQ2xpY2tUaW1lb3V0KCkge1xuICAgIGNsZWFyVGltZW91dCh0aGlzLmdsb2JhbENsaWNrVGltZW91dCk7XG4gIH1cblxuICBwcml2YXRlIGZvY3VzSXRlbShkaXJlY3Rpb246ICduZXh0JyB8ICdwcmV2aW91cycpIHtcbiAgICBpZiAoIXRoaXMuaXRlbXMubGVuZ3RoKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IGl0ZW1zID0gdGhpcy5pdGVtcy50b0FycmF5KCk7XG4gICAgY29uc3QgYWN0aXZlRWxlbWVudEluZGV4ID0gaXRlbXMuZmluZEluZGV4KGl0ZW0gPT4gaXRlbS5oYXNGb2N1cygpKSArIChkaXJlY3Rpb24gPT09ICduZXh0JyA/IDEgOiAtMSk7XG4gICAgaWYgKGFjdGl2ZUVsZW1lbnRJbmRleCA9PT0gaXRlbXMubGVuZ3RoIHx8IGFjdGl2ZUVsZW1lbnRJbmRleCA8IDApIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaXRlbXNbYWN0aXZlRWxlbWVudEluZGV4XS5mb2N1cygpO1xuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVEcm9wZG93bk9wZW5FdmVudChkcm9wZG93bjogTmdsRHJvcGRvd24pIHtcbiAgICBpZiAoZHJvcGRvd24gIT09IHRoaXMpIHtcbiAgICAgIHRoaXMudG9nZ2xlKGZhbHNlKTtcbiAgICB9XG4gIH1cblxufVxuIl19